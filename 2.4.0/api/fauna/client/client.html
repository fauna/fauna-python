<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.0"/>
    <title>fauna.client.client API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../client.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;fauna.client</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="variable" href="#DefaultHttpConnectTimeout">DefaultHttpConnectTimeout</a>
            </li>
            <li>
                    <a class="variable" href="#DefaultHttpReadTimeout">DefaultHttpReadTimeout</a>
            </li>
            <li>
                    <a class="variable" href="#DefaultHttpWriteTimeout">DefaultHttpWriteTimeout</a>
            </li>
            <li>
                    <a class="variable" href="#DefaultHttpPoolTimeout">DefaultHttpPoolTimeout</a>
            </li>
            <li>
                    <a class="variable" href="#DefaultIdleConnectionTimeout">DefaultIdleConnectionTimeout</a>
            </li>
            <li>
                    <a class="variable" href="#DefaultQueryTimeout">DefaultQueryTimeout</a>
            </li>
            <li>
                    <a class="variable" href="#DefaultClientBufferTimeout">DefaultClientBufferTimeout</a>
            </li>
            <li>
                    <a class="variable" href="#DefaultMaxConnections">DefaultMaxConnections</a>
            </li>
            <li>
                    <a class="variable" href="#DefaultMaxIdleConnections">DefaultMaxIdleConnections</a>
            </li>
            <li>
                    <a class="class" href="#QueryOptions">QueryOptions</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#QueryOptions.__init__">QueryOptions</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryOptions.linearized">linearized</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryOptions.max_contention_retries">max_contention_retries</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryOptions.query_timeout">query_timeout</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryOptions.query_tags">query_tags</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryOptions.traceparent">traceparent</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryOptions.typecheck">typecheck</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryOptions.additional_headers">additional_headers</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#StreamOptions">StreamOptions</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StreamOptions.__init__">StreamOptions</a>
                        </li>
                        <li>
                                <a class="variable" href="#StreamOptions.max_attempts">max_attempts</a>
                        </li>
                        <li>
                                <a class="variable" href="#StreamOptions.max_backoff">max_backoff</a>
                        </li>
                        <li>
                                <a class="variable" href="#StreamOptions.start_ts">start_ts</a>
                        </li>
                        <li>
                                <a class="variable" href="#StreamOptions.cursor">cursor</a>
                        </li>
                        <li>
                                <a class="variable" href="#StreamOptions.status_events">status_events</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FeedOptions">FeedOptions</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FeedOptions.__init__">FeedOptions</a>
                        </li>
                        <li>
                                <a class="variable" href="#FeedOptions.max_attempts">max_attempts</a>
                        </li>
                        <li>
                                <a class="variable" href="#FeedOptions.max_backoff">max_backoff</a>
                        </li>
                        <li>
                                <a class="variable" href="#FeedOptions.query_timeout">query_timeout</a>
                        </li>
                        <li>
                                <a class="variable" href="#FeedOptions.page_size">page_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#FeedOptions.start_ts">start_ts</a>
                        </li>
                        <li>
                                <a class="variable" href="#FeedOptions.cursor">cursor</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Client">Client</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Client.__init__">Client</a>
                        </li>
                        <li>
                                <a class="function" href="#Client.close">close</a>
                        </li>
                        <li>
                                <a class="function" href="#Client.set_last_txn_ts">set_last_txn_ts</a>
                        </li>
                        <li>
                                <a class="function" href="#Client.get_last_txn_ts">get_last_txn_ts</a>
                        </li>
                        <li>
                                <a class="function" href="#Client.get_query_timeout">get_query_timeout</a>
                        </li>
                        <li>
                                <a class="function" href="#Client.paginate">paginate</a>
                        </li>
                        <li>
                                <a class="function" href="#Client.query">query</a>
                        </li>
                        <li>
                                <a class="function" href="#Client.stream">stream</a>
                        </li>
                        <li>
                                <a class="function" href="#Client.feed">feed</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#StreamIterator">StreamIterator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StreamIterator.__init__">StreamIterator</a>
                        </li>
                        <li>
                                <a class="variable" href="#StreamIterator.last_ts">last_ts</a>
                        </li>
                        <li>
                                <a class="variable" href="#StreamIterator.last_cursor">last_cursor</a>
                        </li>
                        <li>
                                <a class="function" href="#StreamIterator.close">close</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FeedPage">FeedPage</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FeedPage.__init__">FeedPage</a>
                        </li>
                        <li>
                                <a class="variable" href="#FeedPage.cursor">cursor</a>
                        </li>
                        <li>
                                <a class="variable" href="#FeedPage.stats">stats</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FeedIterator">FeedIterator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FeedIterator.__init__">FeedIterator</a>
                        </li>
                        <li>
                                <a class="function" href="#FeedIterator.flatten">flatten</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#QueryIterator">QueryIterator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#QueryIterator.__init__">QueryIterator</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryIterator.client">client</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryIterator.fql">fql</a>
                        </li>
                        <li>
                                <a class="variable" href="#QueryIterator.opts">opts</a>
                        </li>
                        <li>
                                <a class="function" href="#QueryIterator.iter">iter</a>
                        </li>
                        <li>
                                <a class="function" href="#QueryIterator.flatten">flatten</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../fauna.html">fauna</a><wbr>.<a href="./../client.html">client</a><wbr>.client    </h1>

                
                        <input id="mod-client-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-client-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">fauna</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span> <span class="nn">fauna.client.headers</span> <span class="kn">import</span> <span class="n">_DriverEnvironment</span><span class="p">,</span> <span class="n">_Header</span><span class="p">,</span> <span class="n">_Auth</span><span class="p">,</span> <span class="n">Header</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">fauna.client.retryable</span> <span class="kn">import</span> <span class="n">Retryable</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">fauna.client.utils</span> <span class="kn">import</span> <span class="n">_Environment</span><span class="p">,</span> <span class="n">LastTxnTs</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">fauna.encoding</span> <span class="kn">import</span> <span class="n">FaunaEncoder</span><span class="p">,</span> <span class="n">FaunaDecoder</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">fauna.encoding</span> <span class="kn">import</span> <span class="n">QuerySuccess</span><span class="p">,</span> <span class="n">QueryTags</span><span class="p">,</span> <span class="n">QueryStats</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span> <span class="nn">fauna.errors</span> <span class="kn">import</span> <span class="n">FaunaError</span><span class="p">,</span> <span class="n">ClientError</span><span class="p">,</span> <span class="n">ProtocolError</span><span class="p">,</span> \
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>  <span class="n">RetryableFaunaException</span><span class="p">,</span> <span class="n">NetworkError</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">fauna.http.http_client</span> <span class="kn">import</span> <span class="n">HTTPClient</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">fauna.query</span> <span class="kn">import</span> <span class="n">EventSource</span><span class="p">,</span> <span class="n">Query</span><span class="p">,</span> <span class="n">Page</span><span class="p">,</span> <span class="n">fql</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;fauna&quot;</span><span class="p">)</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="n">DefaultHttpConnectTimeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="n">DefaultHttpReadTimeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="n">DefaultHttpWriteTimeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="n">DefaultHttpPoolTimeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="n">DefaultIdleConnectionTimeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="n">DefaultQueryTimeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="n">DefaultClientBufferTimeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="n">DefaultMaxConnections</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="n">DefaultMaxIdleConnections</span> <span class="o">=</span> <span class="mi">20</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="nd">@dataclass</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="k">class</span> <span class="nc">QueryOptions</span><span class="p">:</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    A dataclass representing options available for a query.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    * linearized - If true, unconditionally run the query as strictly serialized. This affects read-only transactions. Transactions which write will always be strictly serialized.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    * max_contention_retries - The max number of times to retry the query if contention is encountered.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">    * query_timeout - Controls the maximum amount of time Fauna will execute your query before marking it failed.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">    * query_tags - Tags to associate with the query. See `logging &lt;https://docs.fauna.com/fauna/current/build/logs/query_log/&gt;`_</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">    * traceparent - A traceparent to associate with the query. See `logging &lt;https://docs.fauna.com/fauna/current/build/logs/query_log/&gt;`_ Must match format: https://www.w3.org/TR/trace-context/#traceparent-header</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">    * typecheck - Enable or disable typechecking of the query before evaluation. If not set, the value configured on the Client will be used. If neither is set, Fauna will use the value of the &quot;typechecked&quot; flag on the database configuration.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">    * additional_headers - Add/update HTTP request headers for the query. In general, this should not be necessary.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>  <span class="n">linearized</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>  <span class="n">max_contention_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>  <span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultQueryTimeout</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>  <span class="n">query_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>  <span class="n">traceparent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>  <span class="n">typecheck</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>  <span class="n">additional_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="nd">@dataclass</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="k">class</span> <span class="nc">StreamOptions</span><span class="p">:</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">    A dataclass representing options available for a stream.</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">    * max_attempts - The maximum number of times to attempt a stream query when a retryable exception is thrown.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    * max_backoff - The maximum backoff in seconds for an individual retry.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">    * start_ts - The starting timestamp of the stream, exclusive. If set, Fauna will return events starting after</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    the timestamp.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">    * cursor - The starting event cursor, exclusive. If set, Fauna will return events starting after the cursor.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">    * status_events - Indicates if stream should include status events. Status events are periodic events that</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">    update the client with the latest valid timestamp (in the event of a dropped connection) as well as metrics</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">    about the cost of maintaining the stream other than the cost of the received events.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>  <span class="n">max_attempts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>  <span class="n">max_backoff</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>  <span class="n">start_ts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>  <span class="n">cursor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>  <span class="n">status_events</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="nd">@dataclass</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="k">class</span> <span class="nc">FeedOptions</span><span class="p">:</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">    A dataclass representing options available for an Event Feed.</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">    * max_attempts - The maximum number of times to attempt an Event Feed query when a retryable exception is thrown.</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">    * max_backoff - The maximum backoff in seconds for an individual retry.</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">    * query_timeout - Controls the maximum amount of time Fauna will execute a query before returning a page of events.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">    * start_ts - The starting timestamp of the Event Feed, exclusive. If set, Fauna will return events starting after</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">    the timestamp.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">    * cursor - The starting event cursor, exclusive. If set, Fauna will return events starting after the cursor.</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">    * page_size - Maximum number of events returned per page. Must be in the</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">    range 1 to 16000 (inclusive). Defaults to 16.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>  <span class="n">max_attempts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>  <span class="n">max_backoff</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>  <span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>  <span class="n">page_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>  <span class="n">start_ts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>  <span class="n">cursor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="k">class</span> <span class="nc">Client</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>      <span class="n">endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>      <span class="n">secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>      <span class="n">http_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HTTPClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>      <span class="n">query_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>      <span class="n">linearized</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>      <span class="n">max_contention_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>      <span class="n">typecheck</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>      <span class="n">additional_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>      <span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultQueryTimeout</span><span class="p">,</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>      <span class="n">client_buffer_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultClientBufferTimeout</span><span class="p">,</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>      <span class="n">http_read_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpReadTimeout</span><span class="p">,</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>      <span class="n">http_write_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpWriteTimeout</span><span class="p">,</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>      <span class="n">http_connect_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpConnectTimeout</span><span class="p">,</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>      <span class="n">http_pool_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpPoolTimeout</span><span class="p">,</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>      <span class="n">http_idle_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultIdleConnectionTimeout</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>      <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>      <span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>  <span class="p">):</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes a Client.</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        :param endpoint: The Fauna Endpoint to use. Defaults to https://db.fauna.com, or the `FAUNA_ENDPOINT` env variable.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">        :param secret: The Fauna Secret to use. Defaults to empty, or the `FAUNA_SECRET` env variable.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        :param http_client: An :class:`HTTPClient` implementation. Defaults to a global :class:`HTTPXClient`.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">        :param query_tags: Tags to associate with the query. See `logging &lt;https://docs.fauna.com/fauna/current/build/logs/query_log/&gt;`_</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">        :param linearized: If true, unconditionally run the query as strictly serialized. This affects read-only transactions. Transactions which write will always be strictly serialized.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">        :param max_contention_retries: The max number of times to retry the query if contention is encountered.</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">        :param typecheck: Enable or disable typechecking of the query before evaluation. If not set, Fauna will use the value of the &quot;typechecked&quot; flag on the database configuration.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">        :param additional_headers: Add/update HTTP request headers for the query. In general, this should not be necessary.</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">        :param query_timeout: Controls the maximum amount of time Fauna will execute your query before marking it failed, default is :py:data:`DefaultQueryTimeout`.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        :param client_buffer_timeout: Time in milliseconds beyond query_timeout at which the client will abort a request if it has not received a response. The default is :py:data:`DefaultClientBufferTimeout`, which should account for network latency for most clients. The value must be greater than zero. The closer to zero the value is, the more likely the client is to abort the request before the server can report a legitimate response or error.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">        :param http_read_timeout: Set HTTP Read timeout, default is :py:data:`DefaultHttpReadTimeout`.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        :param http_write_timeout: Set HTTP Write timeout, default is :py:data:`DefaultHttpWriteTimeout`.</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">        :param http_connect_timeout: Set HTTP Connect timeout, default is :py:data:`DefaultHttpConnectTimeout`.</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        :param http_pool_timeout: Set HTTP Pool timeout, default is :py:data:`DefaultHttpPoolTimeout`.</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        :param http_idle_timeout: Set HTTP Idle timeout, default is :py:data:`DefaultIdleConnectionTimeout`.</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">        :param max_attempts: The maximum number of times to attempt a query when a retryable exception is thrown. Defaults to 3.</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        :param max_backoff: The maximum backoff in seconds for an individual retry. Defaults to 20.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_set_endpoint</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span> <span class="o">=</span> <span class="n">max_attempts</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span> <span class="o">=</span> <span class="n">max_backoff</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="k">if</span> <span class="n">secret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span> <span class="o">=</span> <span class="n">_Auth</span><span class="p">(</span><span class="n">_Environment</span><span class="o">.</span><span class="n">EnvFaunaSecret</span><span class="p">())</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span> <span class="o">=</span> <span class="n">_Auth</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span> <span class="o">=</span> <span class="n">LastTxnTs</span><span class="p">()</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>    <span class="k">if</span> <span class="n">query_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_tags</span><span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>    <span class="k">if</span> <span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">AcceptEncoding</span><span class="p">:</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">ContentType</span><span class="p">:</span> <span class="s2">&quot;application/json;charset=utf-8&quot;</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">Driver</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">DriverEnv</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">_DriverEnvironment</span><span class="p">()),</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>    <span class="p">}</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>    <span class="k">if</span> <span class="n">typecheck</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Typecheck</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">typecheck</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>    <span class="k">if</span> <span class="n">linearized</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Linearized</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">linearized</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>    <span class="k">if</span> <span class="n">max_contention_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_contention_retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">MaxContentionRetries</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">max_contention_retries</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>    <span class="k">if</span> <span class="n">additional_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>          <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>          <span class="o">**</span><span class="n">additional_headers</span><span class="p">,</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>      <span class="p">}</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span> <span class="n">HTTPClient</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>    <span class="k">if</span> <span class="n">http_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">http_client</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>      <span class="k">if</span> <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="n">timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="k">if</span> <span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">client_buffer_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>          <span class="n">timeout_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">query_timeout</span> <span class="o">+</span> <span class="n">client_buffer_timeout</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="n">read_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="k">if</span> <span class="n">http_read_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>          <span class="n">read_timeout_s</span> <span class="o">=</span> <span class="n">http_read_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="n">write_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_write_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_write_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="n">connect_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_connect_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_connect_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="n">pool_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_pool_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_pool_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="n">idle_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_idle_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_idle_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="kn">import</span> <span class="nn">httpx</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="kn">from</span> <span class="nn">fauna.http.httpx_client</span> <span class="kn">import</span> <span class="n">HTTPXClient</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">HTTPXClient</span><span class="p">(</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>            <span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                <span class="n">http1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                <span class="n">http2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">,</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>                    <span class="n">connect</span><span class="o">=</span><span class="n">connect_timeout_s</span><span class="p">,</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>                    <span class="n">read</span><span class="o">=</span><span class="n">read_timeout_s</span><span class="p">,</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>                    <span class="n">write</span><span class="o">=</span><span class="n">write_timeout_s</span><span class="p">,</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                    <span class="n">pool</span><span class="o">=</span><span class="n">pool_timeout_s</span><span class="p">,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                <span class="p">),</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                <span class="n">limits</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Limits</span><span class="p">(</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>                    <span class="n">max_connections</span><span class="o">=</span><span class="n">DefaultMaxConnections</span><span class="p">,</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>                    <span class="n">max_keepalive_connections</span><span class="o">=</span><span class="n">DefaultMaxIdleConnections</span><span class="p">,</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                    <span class="n">keepalive_expiry</span><span class="o">=</span><span class="n">idle_timeout_s</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                <span class="p">),</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>            <span class="p">),</span> <span class="n">logger</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">==</span> <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span><span class="p">:</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>      <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>  <span class="k">def</span> <span class="nf">set_last_txn_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txn_ts</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        Set the last timestamp seen by this client.</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        This has no effect if earlier than stored timestamp.</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">        .. WARNING:: This should be used only when coordinating timestamps across</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        multiple clients. Moving the timestamp arbitrarily forward into</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        the future will cause transactions to stall.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        :param txn_ts: the new transaction time.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span><span class="o">.</span><span class="n">update_txn_time</span><span class="p">(</span><span class="n">txn_ts</span><span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>  <span class="k">def</span> <span class="nf">get_last_txn_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">        Get the last timestamp seen by this client.</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">        :return:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span><span class="o">.</span><span class="n">time</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>  <span class="k">def</span> <span class="nf">get_query_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">        Get the query timeout for all queries.</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>      <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>      <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>  <span class="k">def</span> <span class="nf">paginate</span><span class="p">(</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;QueryIterator&quot;</span><span class="p">:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">        Run a query on Fauna and returning an iterator of results. If the query</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        returns a Page, the iterator will fetch additional Pages until the</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        after token is null. Each call for a page will be retried with exponential</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        backoff up to the max_attempts set in the client&#39;s retry policy in the</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        event of a 429 or 502.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        :param fql: A Query</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        :param opts: (Optional) Query Options</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">        :return: a :class:`QueryResponse`</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be a Query but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                 <span class="sa">f</span><span class="s2">&quot;Query by calling fauna.fql()&quot;</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>    <span class="k">return</span> <span class="n">QueryIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fql</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>  <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySuccess</span><span class="p">:</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="sd">        Run a query on Fauna. A query will be retried max_attempt times with exponential backoff</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">        up to the max_backoff in the event of a 429.</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">        :param fql: A Query</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">        :param opts: (Optional) Query Options</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="sd">        :return: a :class:`QueryResponse`</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be a Query but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                 <span class="sa">f</span><span class="s2">&quot;Query by calling fauna.fql()&quot;</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>      <span class="n">encoded_query</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">FaunaEncoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>      <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span><span class="s2">&quot;Failed to encode Query&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>    <span class="n">retryable</span> <span class="o">=</span> <span class="n">Retryable</span><span class="p">[</span><span class="n">QuerySuccess</span><span class="p">](</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">,</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="s2">&quot;/query/1&quot;</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="n">fql</span><span class="o">=</span><span class="n">encoded_query</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>    <span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>    <span class="n">r</span> <span class="o">=</span> <span class="n">retryable</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>    <span class="n">r</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">attempts</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">response</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>  <span class="k">def</span> <span class="nf">_query</span><span class="p">(</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>      <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>      <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySuccess</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>    <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Format</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tagged&quot;</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Authorization</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">bearer</span><span class="p">()</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>    <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span><span class="o">.</span><span class="n">request_header</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>    <span class="n">query_tags</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>      <span class="n">query_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">linearized</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Linearized</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">linearized</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">max_contention_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">MaxContentionRetries</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opts</span><span class="o">.</span><span class="n">max_contention_retries</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">traceparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Traceparent</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">traceparent</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="n">timeout_ms</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeout_ms</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">query_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="n">query_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">query_tags</span><span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">typecheck</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Typecheck</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">typecheck</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">additional_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">additional_headers</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Tags</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueryTags</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">query_tags</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">fql</span><span class="p">,</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>    <span class="p">}</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>    <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>      <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">()</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>      <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>      <span class="n">headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">()</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_check_protocol</span><span class="p">(</span><span class="n">response_json</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>      <span class="n">dec</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">FaunaDecoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>      <span class="k">if</span> <span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">399</span><span class="p">:</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="n">FaunaError</span><span class="o">.</span><span class="n">parse_error_and_throw</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>      <span class="k">if</span> <span class="s2">&quot;txn_ts&quot;</span> <span class="ow">in</span> <span class="n">dec</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_last_txn_ts</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">response_json</span><span class="p">[</span><span class="s2">&quot;txn_ts&quot;</span><span class="p">]))</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>      <span class="n">stats</span> <span class="o">=</span> <span class="n">QueryStats</span><span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;stats&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>      <span class="n">summary</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>      <span class="n">query_tags</span> <span class="o">=</span> <span class="n">QueryTags</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>          <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;query_tags&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;query_tags&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>      <span class="n">txn_ts</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;txn_ts&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;txn_ts&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>      <span class="n">schema_version</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;schema_version&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;schema_version&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>      <span class="n">traceparent</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;traceparent&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>      <span class="n">static_type</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;static_type&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;static_type&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>      <span class="k">return</span> <span class="n">QuerySuccess</span><span class="p">(</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>          <span class="n">data</span><span class="o">=</span><span class="n">dec</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>          <span class="n">query_tags</span><span class="o">=</span><span class="n">query_tags</span><span class="p">,</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>          <span class="n">static_type</span><span class="o">=</span><span class="n">static_type</span><span class="p">,</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>          <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>          <span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>          <span class="n">traceparent</span><span class="o">=</span><span class="n">traceparent</span><span class="p">,</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>          <span class="n">txn_ts</span><span class="o">=</span><span class="n">txn_ts</span><span class="p">,</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>          <span class="n">schema_version</span><span class="o">=</span><span class="n">schema_version</span><span class="p">,</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>      <span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>  <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EventSource</span><span class="p">,</span> <span class="n">Query</span><span class="p">],</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">StreamOptions</span> <span class="o">=</span> <span class="n">StreamOptions</span><span class="p">()</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamIterator&quot;</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">        Opens a Stream in Fauna and returns an iterator that consume Fauna events.</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">        :param fql: An EventSource or a Query that returns an EventSource.</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">        :param opts: (Optional) Stream Options.</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a><span class="sd">        :return: a :class:`StreamIterator`</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">        :raises ClientError: Invalid options provided</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="s2">&quot;The &#39;cursor&#39; configuration can only be used with an event source.&quot;</span><span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>      <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>      <span class="n">source</span> <span class="o">=</span> <span class="n">fql</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be an EventSource, or a Query that returns an EventSource but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>    <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Format</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tagged&quot;</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Authorization</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">bearer</span><span class="p">()</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>    <span class="k">return</span> <span class="n">StreamIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">+</span> <span class="s2">&quot;/stream/1&quot;</span><span class="p">,</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                          <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>  <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>      <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EventSource</span><span class="p">,</span> <span class="n">Query</span><span class="p">],</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">FeedOptions</span> <span class="o">=</span> <span class="n">FeedOptions</span><span class="p">(),</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FeedIterator&quot;</span><span class="p">:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">        Opens an Event Feed in Fauna and returns an iterator that consume Fauna events.</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a><span class="sd">        :param source: An EventSource or a Query that returns an EventSource.</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="sd">        :param opts: (Optional) Event Feed options.</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">        :return: a :class:`FeedIterator`</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a><span class="sd">        :raises ClientError: Invalid options provided</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>      <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;source&#39; must be an EventSource, or a Query that returns an EventSource but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>    <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Format</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tagged&quot;</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Authorization</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">bearer</span><span class="p">()</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>      <span class="n">query_timeout_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">query_timeout_ms</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span><span class="p">)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>    <span class="k">return</span> <span class="n">FeedIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">+</span> <span class="s2">&quot;/feed/1&quot;</span><span class="p">,</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>  <span class="k">def</span> <span class="nf">_check_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_json</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>    <span class="c1"># TODO: Logic to validate wire protocol belongs elsewhere.</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>    <span class="n">should_raise</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>    <span class="c1"># check for QuerySuccess</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>    <span class="k">if</span> <span class="n">status_code</span> <span class="o">&lt;=</span> <span class="mi">399</span> <span class="ow">and</span> <span class="s2">&quot;data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response_json</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>      <span class="n">should_raise</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>    <span class="c1"># check for QueryFailure</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>    <span class="k">if</span> <span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">399</span><span class="p">:</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>      <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response_json</span><span class="p">:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="n">should_raise</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="k">if</span> <span class="s2">&quot;code&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">e</span> <span class="ow">or</span> <span class="s2">&quot;message&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>          <span class="n">should_raise</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>    <span class="k">if</span> <span class="n">should_raise</span><span class="p">:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>      <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>          <span class="n">status_code</span><span class="p">,</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>          <span class="sa">f</span><span class="s2">&quot;Response is in an unknown format: </span><span class="se">\n</span><span class="si">{</span><span class="n">response_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>      <span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>  <span class="k">def</span> <span class="nf">_set_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>    <span class="k">if</span> <span class="n">endpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>      <span class="n">endpoint</span> <span class="o">=</span> <span class="n">_Environment</span><span class="o">.</span><span class="n">EnvFaunaEndpoint</span><span class="p">()</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>    <span class="k">if</span> <span class="n">endpoint</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>      <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a><span class="k">class</span> <span class="nc">StreamIterator</span><span class="p">:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;A class that mixes a ContextManager and an Iterator so we can detected retryable errors.&quot;&quot;&quot;</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http_client</span><span class="p">:</span> <span class="n">HTTPClient</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>               <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>               <span class="n">opts</span><span class="p">:</span> <span class="n">StreamOptions</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span> <span class="o">=</span> <span class="n">http_client</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">headers</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span> <span class="o">=</span> <span class="n">max_attempts</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span> <span class="o">=</span> <span class="n">max_backoff</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span> <span class="o">=</span> <span class="n">opts</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">source</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_ts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_stream</span><span class="p">()</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Only one of &#39;start_ts&#39; or &#39;cursor&#39; can be defined in the StreamOptions.&quot;</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>  <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>    <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>  <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">)</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>    <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>  <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">max_attempts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>      <span class="n">max_attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">max_attempts</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>      <span class="n">max_attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">max_backoff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>      <span class="n">max_backoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">max_backoff</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>      <span class="n">max_backoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>    <span class="n">retryable</span> <span class="o">=</span> <span class="n">Retryable</span><span class="p">[</span><span class="n">Any</span><span class="p">](</span><span class="n">max_attempts</span><span class="p">,</span> <span class="n">max_backoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_element</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>    <span class="k">return</span> <span class="n">retryable</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">response</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>  <span class="k">def</span> <span class="nf">_next_element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">_retry_stream</span><span class="p">()</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>        <span class="n">event</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">FaunaDecoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="p">))</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>          <span class="n">FaunaError</span><span class="o">.</span><span class="n">parse_error_and_throw</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_ts</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;txn_ts&quot;</span><span class="p">]</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_cursor</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cursor&#39;</span><span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_element</span><span class="p">()</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">status_events</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_element</span><span class="p">()</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="k">return</span> <span class="n">event</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>      <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>    <span class="k">except</span> <span class="n">NetworkError</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_retry_stream</span><span class="p">()</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>  <span class="k">def</span> <span class="nf">_retry_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_stream</span><span class="p">()</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>      <span class="k">pass</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>    <span class="k">raise</span> <span class="n">RetryableFaunaException</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>  <span class="k">def</span> <span class="nf">_create_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">token</span><span class="p">}</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>      <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_cursor</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>      <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">cursor</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>      <span class="n">data</span><span class="p">[</span><span class="s2">&quot;start_ts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">start_ts</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>        <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a><span class="k">class</span> <span class="nc">FeedPage</span><span class="p">:</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">cursor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stats</span><span class="p">:</span> <span class="n">QueryStats</span><span class="p">):</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="n">events</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>      <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        <span class="n">FaunaError</span><span class="o">.</span><span class="n">parse_error_and_throw</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>      <span class="k">yield</span> <span class="n">event</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a><span class="k">class</span> <span class="nc">FeedIterator</span><span class="p">:</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;A class to provide an iterator on top of Event Feed pages.&quot;&quot;&quot;</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http</span><span class="p">:</span> <span class="n">HTTPClient</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>               <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">opts</span><span class="p">:</span> <span class="n">FeedOptions</span><span class="p">,</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>               <span class="n">source</span><span class="p">:</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_http</span> <span class="o">=</span> <span class="n">http</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">headers</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">max_attempts</span> <span class="ow">or</span> <span class="n">max_attempts</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">max_backoff</span> <span class="ow">or</span> <span class="n">max_backoff</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">token</span><span class="p">}</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Only one of &#39;start_ts&#39; or &#39;cursor&#39; can be defined in the FeedOptions.&quot;</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;page_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">page_size</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;start_ts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">FeedPage</span><span class="p">]:</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>    <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>  <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeedPage</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span><span class="p">:</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>      <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>    <span class="n">retryable</span> <span class="o">=</span> <span class="n">Retryable</span><span class="p">[</span><span class="n">Any</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>                               <span class="bp">self</span><span class="o">.</span><span class="n">_next_page</span><span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>    <span class="k">return</span> <span class="n">retryable</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">response</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>  <span class="k">def</span> <span class="nf">_next_page</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeedPage</span><span class="p">:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>        <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span><span class="p">,</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>        <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>    <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>      <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">()</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>      <span class="n">decoded</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">FaunaDecoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>      <span class="k">if</span> <span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">399</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>        <span class="n">FaunaError</span><span class="o">.</span><span class="n">parse_error_and_throw</span><span class="p">(</span><span class="n">decoded</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;has_next&quot;</span><span class="p">]</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>      <span class="k">if</span> <span class="s2">&quot;start_ts&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;start_ts&quot;</span><span class="p">]</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>      <span class="k">return</span> <span class="n">FeedPage</span><span class="p">(</span><span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">],</span> <span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">],</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>                      <span class="n">QueryStats</span><span class="p">(</span><span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]))</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>  <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A generator that yields events instead of pages of events.&quot;&quot;&quot;</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>        <span class="k">yield</span> <span class="n">event</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a><span class="k">class</span> <span class="nc">QueryIterator</span><span class="p">:</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;A class to provider an iterator on top of Fauna queries.&quot;&quot;&quot;</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>               <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>               <span class="n">fql</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>               <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the QueryIterator</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a><span class="sd">        :param fql: A Query</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a><span class="sd">        :param opts: (Optional) Query Options</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Client</span><span class="p">):</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;client&#39; must be a Client but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">client</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>                  <span class="sa">f</span><span class="s2">&quot;Client by calling fauna.client.Client()&quot;</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be a Query but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>                 <span class="sa">f</span><span class="s2">&quot;Query by calling fauna.fql()&quot;</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fql</span> <span class="o">=</span> <span class="n">fql</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">()</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>  <span class="k">def</span> <span class="nf">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a><span class="sd">        A generator function that immediately fetches and yields the results of</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a><span class="sd">        the stored query. Yields additional pages on subsequent iterations if</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a><span class="sd">        they exist</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>    <span class="n">initial_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">Page</span><span class="p">):</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>      <span class="n">cursor</span> <span class="o">=</span> <span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">after</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>      <span class="k">yield</span> <span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>      <span class="k">while</span> <span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>        <span class="n">next_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>            <span class="n">fql</span><span class="p">(</span><span class="s2">&quot;Set.paginate($</span><span class="si">{after}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">cursor</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>        <span class="c1"># TODO: `Set.paginate` does not yet return a `@set` tagged value</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>        <span class="c1">#       so we will get back a plain object that might not have</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>        <span class="c1">#       an after property.</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">next_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>        <span class="k">yield</span> <span class="n">next_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>      <span class="k">yield</span> <span class="p">[</span><span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>  <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a><span class="sd">        A generator function that immediately fetches and yields the results of</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a><span class="sd">        the stored query. Yields each item individually, rather than a whole</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a><span class="sd">        Page at a time. Fetches additional pages as required if they exist.</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>        <span class="k">yield</span> <span class="n">item</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;Logger fauna (WARNING)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
    

                </section>
                <section id="DefaultHttpConnectTimeout">
                    <div class="attr variable">
            <span class="name">DefaultHttpConnectTimeout</span>        =
<span class="default_value">datetime.timedelta(seconds=5)</span>

        
    </div>
    <a class="headerlink" href="#DefaultHttpConnectTimeout"></a>
    
    

                </section>
                <section id="DefaultHttpReadTimeout">
                    <div class="attr variable">
            <span class="name">DefaultHttpReadTimeout</span><span class="annotation">: Optional[datetime.timedelta]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#DefaultHttpReadTimeout"></a>
    
    

                </section>
                <section id="DefaultHttpWriteTimeout">
                    <div class="attr variable">
            <span class="name">DefaultHttpWriteTimeout</span>        =
<span class="default_value">datetime.timedelta(seconds=5)</span>

        
    </div>
    <a class="headerlink" href="#DefaultHttpWriteTimeout"></a>
    
    

                </section>
                <section id="DefaultHttpPoolTimeout">
                    <div class="attr variable">
            <span class="name">DefaultHttpPoolTimeout</span>        =
<span class="default_value">datetime.timedelta(seconds=5)</span>

        
    </div>
    <a class="headerlink" href="#DefaultHttpPoolTimeout"></a>
    
    

                </section>
                <section id="DefaultIdleConnectionTimeout">
                    <div class="attr variable">
            <span class="name">DefaultIdleConnectionTimeout</span>        =
<span class="default_value">datetime.timedelta(seconds=5)</span>

        
    </div>
    <a class="headerlink" href="#DefaultIdleConnectionTimeout"></a>
    
    

                </section>
                <section id="DefaultQueryTimeout">
                    <div class="attr variable">
            <span class="name">DefaultQueryTimeout</span>        =
<span class="default_value">datetime.timedelta(seconds=5)</span>

        
    </div>
    <a class="headerlink" href="#DefaultQueryTimeout"></a>
    
    

                </section>
                <section id="DefaultClientBufferTimeout">
                    <div class="attr variable">
            <span class="name">DefaultClientBufferTimeout</span>        =
<span class="default_value">datetime.timedelta(seconds=5)</span>

        
    </div>
    <a class="headerlink" href="#DefaultClientBufferTimeout"></a>
    
    

                </section>
                <section id="DefaultMaxConnections">
                    <div class="attr variable">
            <span class="name">DefaultMaxConnections</span>        =
<span class="default_value">20</span>

        
    </div>
    <a class="headerlink" href="#DefaultMaxConnections"></a>
    
    

                </section>
                <section id="DefaultMaxIdleConnections">
                    <div class="attr variable">
            <span class="name">DefaultMaxIdleConnections</span>        =
<span class="default_value">20</span>

        
    </div>
    <a class="headerlink" href="#DefaultMaxIdleConnections"></a>
    
    

                </section>
                <section id="QueryOptions">
                            <input id="QueryOptions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">QueryOptions</span>:

                <label class="view-source-button" for="QueryOptions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#QueryOptions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="QueryOptions-31"><a href="#QueryOptions-31"><span class="linenos">31</span></a><span class="nd">@dataclass</span>
</span><span id="QueryOptions-32"><a href="#QueryOptions-32"><span class="linenos">32</span></a><span class="k">class</span> <span class="nc">QueryOptions</span><span class="p">:</span>
</span><span id="QueryOptions-33"><a href="#QueryOptions-33"><span class="linenos">33</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="QueryOptions-34"><a href="#QueryOptions-34"><span class="linenos">34</span></a><span class="sd">    A dataclass representing options available for a query.</span>
</span><span id="QueryOptions-35"><a href="#QueryOptions-35"><span class="linenos">35</span></a>
</span><span id="QueryOptions-36"><a href="#QueryOptions-36"><span class="linenos">36</span></a><span class="sd">    * linearized - If true, unconditionally run the query as strictly serialized. This affects read-only transactions. Transactions which write will always be strictly serialized.</span>
</span><span id="QueryOptions-37"><a href="#QueryOptions-37"><span class="linenos">37</span></a><span class="sd">    * max_contention_retries - The max number of times to retry the query if contention is encountered.</span>
</span><span id="QueryOptions-38"><a href="#QueryOptions-38"><span class="linenos">38</span></a><span class="sd">    * query_timeout - Controls the maximum amount of time Fauna will execute your query before marking it failed.</span>
</span><span id="QueryOptions-39"><a href="#QueryOptions-39"><span class="linenos">39</span></a><span class="sd">    * query_tags - Tags to associate with the query. See `logging &lt;https://docs.fauna.com/fauna/current/build/logs/query_log/&gt;`_</span>
</span><span id="QueryOptions-40"><a href="#QueryOptions-40"><span class="linenos">40</span></a><span class="sd">    * traceparent - A traceparent to associate with the query. See `logging &lt;https://docs.fauna.com/fauna/current/build/logs/query_log/&gt;`_ Must match format: https://www.w3.org/TR/trace-context/#traceparent-header</span>
</span><span id="QueryOptions-41"><a href="#QueryOptions-41"><span class="linenos">41</span></a><span class="sd">    * typecheck - Enable or disable typechecking of the query before evaluation. If not set, the value configured on the Client will be used. If neither is set, Fauna will use the value of the &quot;typechecked&quot; flag on the database configuration.</span>
</span><span id="QueryOptions-42"><a href="#QueryOptions-42"><span class="linenos">42</span></a><span class="sd">    * additional_headers - Add/update HTTP request headers for the query. In general, this should not be necessary.</span>
</span><span id="QueryOptions-43"><a href="#QueryOptions-43"><span class="linenos">43</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="QueryOptions-44"><a href="#QueryOptions-44"><span class="linenos">44</span></a>
</span><span id="QueryOptions-45"><a href="#QueryOptions-45"><span class="linenos">45</span></a>  <span class="n">linearized</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="QueryOptions-46"><a href="#QueryOptions-46"><span class="linenos">46</span></a>  <span class="n">max_contention_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="QueryOptions-47"><a href="#QueryOptions-47"><span class="linenos">47</span></a>  <span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultQueryTimeout</span>
</span><span id="QueryOptions-48"><a href="#QueryOptions-48"><span class="linenos">48</span></a>  <span class="n">query_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="QueryOptions-49"><a href="#QueryOptions-49"><span class="linenos">49</span></a>  <span class="n">traceparent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="QueryOptions-50"><a href="#QueryOptions-50"><span class="linenos">50</span></a>  <span class="n">typecheck</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="QueryOptions-51"><a href="#QueryOptions-51"><span class="linenos">51</span></a>  <span class="n">additional_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>A dataclass representing options available for a query.</p>

<ul>
<li>linearized - If true, unconditionally run the query as strictly serialized. This affects read-only transactions. Transactions which write will always be strictly serialized.</li>
<li>max_contention_retries - The max number of times to retry the query if contention is encountered.</li>
<li>query_timeout - Controls the maximum amount of time Fauna will execute your query before marking it failed.</li>
<li>query_tags - Tags to associate with the query. See <a href="https://docs.fauna.com/fauna/current/build/logs/query_log/">logging </a></li>
<li>traceparent - A traceparent to associate with the query. See <a href="https://docs.fauna.com/fauna/current/build/logs/query_log/">logging </a> Must match format: <a href="https://www.w3.org/TR/trace-context/#traceparent-header">https://www.w3.org/TR/trace-context/#traceparent-header</a></li>
<li>typecheck - Enable or disable typechecking of the query before evaluation. If not set, the value configured on the Client will be used. If neither is set, Fauna will use the value of the "typechecked" flag on the database configuration.</li>
<li>additional_headers - Add/update HTTP request headers for the query. In general, this should not be necessary.</li>
</ul>
</div>


                            <div id="QueryOptions.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">QueryOptions</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">linearized</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_contention_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>,</span><span class="param">	<span class="n">query_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">traceparent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">typecheck</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">additional_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#QueryOptions.__init__"></a>
    
    

                            </div>
                            <div id="QueryOptions.linearized" class="classattr">
                                <div class="attr variable">
            <span class="name">linearized</span><span class="annotation">: Optional[bool]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#QueryOptions.linearized"></a>
    
    

                            </div>
                            <div id="QueryOptions.max_contention_retries" class="classattr">
                                <div class="attr variable">
            <span class="name">max_contention_retries</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#QueryOptions.max_contention_retries"></a>
    
    

                            </div>
                            <div id="QueryOptions.query_timeout" class="classattr">
                                <div class="attr variable">
            <span class="name">query_timeout</span><span class="annotation">: Optional[datetime.timedelta]</span>        =
<span class="default_value">datetime.timedelta(seconds=5)</span>

        
    </div>
    <a class="headerlink" href="#QueryOptions.query_timeout"></a>
    
    

                            </div>
                            <div id="QueryOptions.query_tags" class="classattr">
                                <div class="attr variable">
            <span class="name">query_tags</span><span class="annotation">: Optional[Mapping[str, str]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#QueryOptions.query_tags"></a>
    
    

                            </div>
                            <div id="QueryOptions.traceparent" class="classattr">
                                <div class="attr variable">
            <span class="name">traceparent</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#QueryOptions.traceparent"></a>
    
    

                            </div>
                            <div id="QueryOptions.typecheck" class="classattr">
                                <div class="attr variable">
            <span class="name">typecheck</span><span class="annotation">: Optional[bool]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#QueryOptions.typecheck"></a>
    
    

                            </div>
                            <div id="QueryOptions.additional_headers" class="classattr">
                                <div class="attr variable">
            <span class="name">additional_headers</span><span class="annotation">: Optional[Dict[str, str]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#QueryOptions.additional_headers"></a>
    
    

                            </div>
                </section>
                <section id="StreamOptions">
                            <input id="StreamOptions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">StreamOptions</span>:

                <label class="view-source-button" for="StreamOptions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StreamOptions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StreamOptions-54"><a href="#StreamOptions-54"><span class="linenos">54</span></a><span class="nd">@dataclass</span>
</span><span id="StreamOptions-55"><a href="#StreamOptions-55"><span class="linenos">55</span></a><span class="k">class</span> <span class="nc">StreamOptions</span><span class="p">:</span>
</span><span id="StreamOptions-56"><a href="#StreamOptions-56"><span class="linenos">56</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StreamOptions-57"><a href="#StreamOptions-57"><span class="linenos">57</span></a><span class="sd">    A dataclass representing options available for a stream.</span>
</span><span id="StreamOptions-58"><a href="#StreamOptions-58"><span class="linenos">58</span></a>
</span><span id="StreamOptions-59"><a href="#StreamOptions-59"><span class="linenos">59</span></a><span class="sd">    * max_attempts - The maximum number of times to attempt a stream query when a retryable exception is thrown.</span>
</span><span id="StreamOptions-60"><a href="#StreamOptions-60"><span class="linenos">60</span></a><span class="sd">    * max_backoff - The maximum backoff in seconds for an individual retry.</span>
</span><span id="StreamOptions-61"><a href="#StreamOptions-61"><span class="linenos">61</span></a><span class="sd">    * start_ts - The starting timestamp of the stream, exclusive. If set, Fauna will return events starting after</span>
</span><span id="StreamOptions-62"><a href="#StreamOptions-62"><span class="linenos">62</span></a><span class="sd">    the timestamp.</span>
</span><span id="StreamOptions-63"><a href="#StreamOptions-63"><span class="linenos">63</span></a><span class="sd">    * cursor - The starting event cursor, exclusive. If set, Fauna will return events starting after the cursor.</span>
</span><span id="StreamOptions-64"><a href="#StreamOptions-64"><span class="linenos">64</span></a><span class="sd">    * status_events - Indicates if stream should include status events. Status events are periodic events that</span>
</span><span id="StreamOptions-65"><a href="#StreamOptions-65"><span class="linenos">65</span></a><span class="sd">    update the client with the latest valid timestamp (in the event of a dropped connection) as well as metrics</span>
</span><span id="StreamOptions-66"><a href="#StreamOptions-66"><span class="linenos">66</span></a><span class="sd">    about the cost of maintaining the stream other than the cost of the received events.</span>
</span><span id="StreamOptions-67"><a href="#StreamOptions-67"><span class="linenos">67</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="StreamOptions-68"><a href="#StreamOptions-68"><span class="linenos">68</span></a>
</span><span id="StreamOptions-69"><a href="#StreamOptions-69"><span class="linenos">69</span></a>  <span class="n">max_attempts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamOptions-70"><a href="#StreamOptions-70"><span class="linenos">70</span></a>  <span class="n">max_backoff</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamOptions-71"><a href="#StreamOptions-71"><span class="linenos">71</span></a>  <span class="n">start_ts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamOptions-72"><a href="#StreamOptions-72"><span class="linenos">72</span></a>  <span class="n">cursor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamOptions-73"><a href="#StreamOptions-73"><span class="linenos">73</span></a>  <span class="n">status_events</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>A dataclass representing options available for a stream.</p>

<ul>
<li>max_attempts - The maximum number of times to attempt a stream query when a retryable exception is thrown.</li>
<li>max_backoff - The maximum backoff in seconds for an individual retry.</li>
<li>start_ts - The starting timestamp of the stream, exclusive. If set, Fauna will return events starting after
the timestamp.</li>
<li>cursor - The starting event cursor, exclusive. If set, Fauna will return events starting after the cursor.</li>
<li>status_events - Indicates if stream should include status events. Status events are periodic events that
update the client with the latest valid timestamp (in the event of a dropped connection) as well as metrics
about the cost of maintaining the stream other than the cost of the received events.</li>
</ul>
</div>


                            <div id="StreamOptions.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">StreamOptions</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">max_attempts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_backoff</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">start_ts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">cursor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">status_events</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#StreamOptions.__init__"></a>
    
    

                            </div>
                            <div id="StreamOptions.max_attempts" class="classattr">
                                <div class="attr variable">
            <span class="name">max_attempts</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#StreamOptions.max_attempts"></a>
    
    

                            </div>
                            <div id="StreamOptions.max_backoff" class="classattr">
                                <div class="attr variable">
            <span class="name">max_backoff</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#StreamOptions.max_backoff"></a>
    
    

                            </div>
                            <div id="StreamOptions.start_ts" class="classattr">
                                <div class="attr variable">
            <span class="name">start_ts</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#StreamOptions.start_ts"></a>
    
    

                            </div>
                            <div id="StreamOptions.cursor" class="classattr">
                                <div class="attr variable">
            <span class="name">cursor</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#StreamOptions.cursor"></a>
    
    

                            </div>
                            <div id="StreamOptions.status_events" class="classattr">
                                <div class="attr variable">
            <span class="name">status_events</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#StreamOptions.status_events"></a>
    
    

                            </div>
                </section>
                <section id="FeedOptions">
                            <input id="FeedOptions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">FeedOptions</span>:

                <label class="view-source-button" for="FeedOptions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FeedOptions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FeedOptions-76"><a href="#FeedOptions-76"><span class="linenos">76</span></a><span class="nd">@dataclass</span>
</span><span id="FeedOptions-77"><a href="#FeedOptions-77"><span class="linenos">77</span></a><span class="k">class</span> <span class="nc">FeedOptions</span><span class="p">:</span>
</span><span id="FeedOptions-78"><a href="#FeedOptions-78"><span class="linenos">78</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FeedOptions-79"><a href="#FeedOptions-79"><span class="linenos">79</span></a><span class="sd">    A dataclass representing options available for an Event Feed.</span>
</span><span id="FeedOptions-80"><a href="#FeedOptions-80"><span class="linenos">80</span></a>
</span><span id="FeedOptions-81"><a href="#FeedOptions-81"><span class="linenos">81</span></a><span class="sd">    * max_attempts - The maximum number of times to attempt an Event Feed query when a retryable exception is thrown.</span>
</span><span id="FeedOptions-82"><a href="#FeedOptions-82"><span class="linenos">82</span></a><span class="sd">    * max_backoff - The maximum backoff in seconds for an individual retry.</span>
</span><span id="FeedOptions-83"><a href="#FeedOptions-83"><span class="linenos">83</span></a><span class="sd">    * query_timeout - Controls the maximum amount of time Fauna will execute a query before returning a page of events.</span>
</span><span id="FeedOptions-84"><a href="#FeedOptions-84"><span class="linenos">84</span></a><span class="sd">    * start_ts - The starting timestamp of the Event Feed, exclusive. If set, Fauna will return events starting after</span>
</span><span id="FeedOptions-85"><a href="#FeedOptions-85"><span class="linenos">85</span></a><span class="sd">    the timestamp.</span>
</span><span id="FeedOptions-86"><a href="#FeedOptions-86"><span class="linenos">86</span></a><span class="sd">    * cursor - The starting event cursor, exclusive. If set, Fauna will return events starting after the cursor.</span>
</span><span id="FeedOptions-87"><a href="#FeedOptions-87"><span class="linenos">87</span></a><span class="sd">    * page_size - Maximum number of events returned per page. Must be in the</span>
</span><span id="FeedOptions-88"><a href="#FeedOptions-88"><span class="linenos">88</span></a><span class="sd">    range 1 to 16000 (inclusive). Defaults to 16.</span>
</span><span id="FeedOptions-89"><a href="#FeedOptions-89"><span class="linenos">89</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FeedOptions-90"><a href="#FeedOptions-90"><span class="linenos">90</span></a>  <span class="n">max_attempts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FeedOptions-91"><a href="#FeedOptions-91"><span class="linenos">91</span></a>  <span class="n">max_backoff</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FeedOptions-92"><a href="#FeedOptions-92"><span class="linenos">92</span></a>  <span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FeedOptions-93"><a href="#FeedOptions-93"><span class="linenos">93</span></a>  <span class="n">page_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FeedOptions-94"><a href="#FeedOptions-94"><span class="linenos">94</span></a>  <span class="n">start_ts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="FeedOptions-95"><a href="#FeedOptions-95"><span class="linenos">95</span></a>  <span class="n">cursor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>A dataclass representing options available for an Event Feed.</p>

<ul>
<li>max_attempts - The maximum number of times to attempt an Event Feed query when a retryable exception is thrown.</li>
<li>max_backoff - The maximum backoff in seconds for an individual retry.</li>
<li>query_timeout - Controls the maximum amount of time Fauna will execute a query before returning a page of events.</li>
<li>start_ts - The starting timestamp of the Event Feed, exclusive. If set, Fauna will return events starting after
the timestamp.</li>
<li>cursor - The starting event cursor, exclusive. If set, Fauna will return events starting after the cursor.</li>
<li>page_size - Maximum number of events returned per page. Must be in the
range 1 to 16000 (inclusive). Defaults to 16.</li>
</ul>
</div>


                            <div id="FeedOptions.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">FeedOptions</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">max_attempts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_backoff</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">page_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">start_ts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">cursor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#FeedOptions.__init__"></a>
    
    

                            </div>
                            <div id="FeedOptions.max_attempts" class="classattr">
                                <div class="attr variable">
            <span class="name">max_attempts</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FeedOptions.max_attempts"></a>
    
    

                            </div>
                            <div id="FeedOptions.max_backoff" class="classattr">
                                <div class="attr variable">
            <span class="name">max_backoff</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FeedOptions.max_backoff"></a>
    
    

                            </div>
                            <div id="FeedOptions.query_timeout" class="classattr">
                                <div class="attr variable">
            <span class="name">query_timeout</span><span class="annotation">: Optional[datetime.timedelta]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FeedOptions.query_timeout"></a>
    
    

                            </div>
                            <div id="FeedOptions.page_size" class="classattr">
                                <div class="attr variable">
            <span class="name">page_size</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FeedOptions.page_size"></a>
    
    

                            </div>
                            <div id="FeedOptions.start_ts" class="classattr">
                                <div class="attr variable">
            <span class="name">start_ts</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FeedOptions.start_ts"></a>
    
    

                            </div>
                            <div id="FeedOptions.cursor" class="classattr">
                                <div class="attr variable">
            <span class="name">cursor</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#FeedOptions.cursor"></a>
    
    

                            </div>
                </section>
                <section id="Client">
                            <input id="Client-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Client</span>:

                <label class="view-source-button" for="Client-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client-98"><a href="#Client-98"><span class="linenos"> 98</span></a><span class="k">class</span> <span class="nc">Client</span><span class="p">:</span>
</span><span id="Client-99"><a href="#Client-99"><span class="linenos"> 99</span></a>
</span><span id="Client-100"><a href="#Client-100"><span class="linenos">100</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Client-101"><a href="#Client-101"><span class="linenos">101</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client-102"><a href="#Client-102"><span class="linenos">102</span></a>      <span class="n">endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-103"><a href="#Client-103"><span class="linenos">103</span></a>      <span class="n">secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-104"><a href="#Client-104"><span class="linenos">104</span></a>      <span class="n">http_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HTTPClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-105"><a href="#Client-105"><span class="linenos">105</span></a>      <span class="n">query_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-106"><a href="#Client-106"><span class="linenos">106</span></a>      <span class="n">linearized</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-107"><a href="#Client-107"><span class="linenos">107</span></a>      <span class="n">max_contention_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-108"><a href="#Client-108"><span class="linenos">108</span></a>      <span class="n">typecheck</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-109"><a href="#Client-109"><span class="linenos">109</span></a>      <span class="n">additional_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-110"><a href="#Client-110"><span class="linenos">110</span></a>      <span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultQueryTimeout</span><span class="p">,</span>
</span><span id="Client-111"><a href="#Client-111"><span class="linenos">111</span></a>      <span class="n">client_buffer_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultClientBufferTimeout</span><span class="p">,</span>
</span><span id="Client-112"><a href="#Client-112"><span class="linenos">112</span></a>      <span class="n">http_read_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpReadTimeout</span><span class="p">,</span>
</span><span id="Client-113"><a href="#Client-113"><span class="linenos">113</span></a>      <span class="n">http_write_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpWriteTimeout</span><span class="p">,</span>
</span><span id="Client-114"><a href="#Client-114"><span class="linenos">114</span></a>      <span class="n">http_connect_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpConnectTimeout</span><span class="p">,</span>
</span><span id="Client-115"><a href="#Client-115"><span class="linenos">115</span></a>      <span class="n">http_pool_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpPoolTimeout</span><span class="p">,</span>
</span><span id="Client-116"><a href="#Client-116"><span class="linenos">116</span></a>      <span class="n">http_idle_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultIdleConnectionTimeout</span><span class="p">,</span>
</span><span id="Client-117"><a href="#Client-117"><span class="linenos">117</span></a>      <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="Client-118"><a href="#Client-118"><span class="linenos">118</span></a>      <span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="Client-119"><a href="#Client-119"><span class="linenos">119</span></a>  <span class="p">):</span>
</span><span id="Client-120"><a href="#Client-120"><span class="linenos">120</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes a Client.</span>
</span><span id="Client-121"><a href="#Client-121"><span class="linenos">121</span></a>
</span><span id="Client-122"><a href="#Client-122"><span class="linenos">122</span></a><span class="sd">        :param endpoint: The Fauna Endpoint to use. Defaults to https://db.fauna.com, or the `FAUNA_ENDPOINT` env variable.</span>
</span><span id="Client-123"><a href="#Client-123"><span class="linenos">123</span></a><span class="sd">        :param secret: The Fauna Secret to use. Defaults to empty, or the `FAUNA_SECRET` env variable.</span>
</span><span id="Client-124"><a href="#Client-124"><span class="linenos">124</span></a><span class="sd">        :param http_client: An :class:`HTTPClient` implementation. Defaults to a global :class:`HTTPXClient`.</span>
</span><span id="Client-125"><a href="#Client-125"><span class="linenos">125</span></a><span class="sd">        :param query_tags: Tags to associate with the query. See `logging &lt;https://docs.fauna.com/fauna/current/build/logs/query_log/&gt;`_</span>
</span><span id="Client-126"><a href="#Client-126"><span class="linenos">126</span></a><span class="sd">        :param linearized: If true, unconditionally run the query as strictly serialized. This affects read-only transactions. Transactions which write will always be strictly serialized.</span>
</span><span id="Client-127"><a href="#Client-127"><span class="linenos">127</span></a><span class="sd">        :param max_contention_retries: The max number of times to retry the query if contention is encountered.</span>
</span><span id="Client-128"><a href="#Client-128"><span class="linenos">128</span></a><span class="sd">        :param typecheck: Enable or disable typechecking of the query before evaluation. If not set, Fauna will use the value of the &quot;typechecked&quot; flag on the database configuration.</span>
</span><span id="Client-129"><a href="#Client-129"><span class="linenos">129</span></a><span class="sd">        :param additional_headers: Add/update HTTP request headers for the query. In general, this should not be necessary.</span>
</span><span id="Client-130"><a href="#Client-130"><span class="linenos">130</span></a><span class="sd">        :param query_timeout: Controls the maximum amount of time Fauna will execute your query before marking it failed, default is :py:data:`DefaultQueryTimeout`.</span>
</span><span id="Client-131"><a href="#Client-131"><span class="linenos">131</span></a><span class="sd">        :param client_buffer_timeout: Time in milliseconds beyond query_timeout at which the client will abort a request if it has not received a response. The default is :py:data:`DefaultClientBufferTimeout`, which should account for network latency for most clients. The value must be greater than zero. The closer to zero the value is, the more likely the client is to abort the request before the server can report a legitimate response or error.</span>
</span><span id="Client-132"><a href="#Client-132"><span class="linenos">132</span></a><span class="sd">        :param http_read_timeout: Set HTTP Read timeout, default is :py:data:`DefaultHttpReadTimeout`.</span>
</span><span id="Client-133"><a href="#Client-133"><span class="linenos">133</span></a><span class="sd">        :param http_write_timeout: Set HTTP Write timeout, default is :py:data:`DefaultHttpWriteTimeout`.</span>
</span><span id="Client-134"><a href="#Client-134"><span class="linenos">134</span></a><span class="sd">        :param http_connect_timeout: Set HTTP Connect timeout, default is :py:data:`DefaultHttpConnectTimeout`.</span>
</span><span id="Client-135"><a href="#Client-135"><span class="linenos">135</span></a><span class="sd">        :param http_pool_timeout: Set HTTP Pool timeout, default is :py:data:`DefaultHttpPoolTimeout`.</span>
</span><span id="Client-136"><a href="#Client-136"><span class="linenos">136</span></a><span class="sd">        :param http_idle_timeout: Set HTTP Idle timeout, default is :py:data:`DefaultIdleConnectionTimeout`.</span>
</span><span id="Client-137"><a href="#Client-137"><span class="linenos">137</span></a><span class="sd">        :param max_attempts: The maximum number of times to attempt a query when a retryable exception is thrown. Defaults to 3.</span>
</span><span id="Client-138"><a href="#Client-138"><span class="linenos">138</span></a><span class="sd">        :param max_backoff: The maximum backoff in seconds for an individual retry. Defaults to 20.</span>
</span><span id="Client-139"><a href="#Client-139"><span class="linenos">139</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client-140"><a href="#Client-140"><span class="linenos">140</span></a>
</span><span id="Client-141"><a href="#Client-141"><span class="linenos">141</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_set_endpoint</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
</span><span id="Client-142"><a href="#Client-142"><span class="linenos">142</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span> <span class="o">=</span> <span class="n">max_attempts</span>
</span><span id="Client-143"><a href="#Client-143"><span class="linenos">143</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span> <span class="o">=</span> <span class="n">max_backoff</span>
</span><span id="Client-144"><a href="#Client-144"><span class="linenos">144</span></a>
</span><span id="Client-145"><a href="#Client-145"><span class="linenos">145</span></a>    <span class="k">if</span> <span class="n">secret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-146"><a href="#Client-146"><span class="linenos">146</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span> <span class="o">=</span> <span class="n">_Auth</span><span class="p">(</span><span class="n">_Environment</span><span class="o">.</span><span class="n">EnvFaunaSecret</span><span class="p">())</span>
</span><span id="Client-147"><a href="#Client-147"><span class="linenos">147</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client-148"><a href="#Client-148"><span class="linenos">148</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span> <span class="o">=</span> <span class="n">_Auth</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
</span><span id="Client-149"><a href="#Client-149"><span class="linenos">149</span></a>
</span><span id="Client-150"><a href="#Client-150"><span class="linenos">150</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span> <span class="o">=</span> <span class="n">LastTxnTs</span><span class="p">()</span>
</span><span id="Client-151"><a href="#Client-151"><span class="linenos">151</span></a>
</span><span id="Client-152"><a href="#Client-152"><span class="linenos">152</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Client-153"><a href="#Client-153"><span class="linenos">153</span></a>    <span class="k">if</span> <span class="n">query_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-154"><a href="#Client-154"><span class="linenos">154</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_tags</span><span class="p">)</span>
</span><span id="Client-155"><a href="#Client-155"><span class="linenos">155</span></a>
</span><span id="Client-156"><a href="#Client-156"><span class="linenos">156</span></a>    <span class="k">if</span> <span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-157"><a href="#Client-157"><span class="linenos">157</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="Client-158"><a href="#Client-158"><span class="linenos">158</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client-159"><a href="#Client-159"><span class="linenos">159</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Client-160"><a href="#Client-160"><span class="linenos">160</span></a>
</span><span id="Client-161"><a href="#Client-161"><span class="linenos">161</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Client-162"><a href="#Client-162"><span class="linenos">162</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">AcceptEncoding</span><span class="p">:</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
</span><span id="Client-163"><a href="#Client-163"><span class="linenos">163</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">ContentType</span><span class="p">:</span> <span class="s2">&quot;application/json;charset=utf-8&quot;</span><span class="p">,</span>
</span><span id="Client-164"><a href="#Client-164"><span class="linenos">164</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">Driver</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
</span><span id="Client-165"><a href="#Client-165"><span class="linenos">165</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">DriverEnv</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">_DriverEnvironment</span><span class="p">()),</span>
</span><span id="Client-166"><a href="#Client-166"><span class="linenos">166</span></a>    <span class="p">}</span>
</span><span id="Client-167"><a href="#Client-167"><span class="linenos">167</span></a>
</span><span id="Client-168"><a href="#Client-168"><span class="linenos">168</span></a>    <span class="k">if</span> <span class="n">typecheck</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-169"><a href="#Client-169"><span class="linenos">169</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Typecheck</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">typecheck</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Client-170"><a href="#Client-170"><span class="linenos">170</span></a>
</span><span id="Client-171"><a href="#Client-171"><span class="linenos">171</span></a>    <span class="k">if</span> <span class="n">linearized</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-172"><a href="#Client-172"><span class="linenos">172</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Linearized</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">linearized</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Client-173"><a href="#Client-173"><span class="linenos">173</span></a>
</span><span id="Client-174"><a href="#Client-174"><span class="linenos">174</span></a>    <span class="k">if</span> <span class="n">max_contention_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_contention_retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Client-175"><a href="#Client-175"><span class="linenos">175</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">MaxContentionRetries</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="Client-176"><a href="#Client-176"><span class="linenos">176</span></a>          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">max_contention_retries</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Client-177"><a href="#Client-177"><span class="linenos">177</span></a>
</span><span id="Client-178"><a href="#Client-178"><span class="linenos">178</span></a>    <span class="k">if</span> <span class="n">additional_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-179"><a href="#Client-179"><span class="linenos">179</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Client-180"><a href="#Client-180"><span class="linenos">180</span></a>          <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
</span><span id="Client-181"><a href="#Client-181"><span class="linenos">181</span></a>          <span class="o">**</span><span class="n">additional_headers</span><span class="p">,</span>
</span><span id="Client-182"><a href="#Client-182"><span class="linenos">182</span></a>      <span class="p">}</span>
</span><span id="Client-183"><a href="#Client-183"><span class="linenos">183</span></a>
</span><span id="Client-184"><a href="#Client-184"><span class="linenos">184</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span> <span class="n">HTTPClient</span>
</span><span id="Client-185"><a href="#Client-185"><span class="linenos">185</span></a>
</span><span id="Client-186"><a href="#Client-186"><span class="linenos">186</span></a>    <span class="k">if</span> <span class="n">http_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-187"><a href="#Client-187"><span class="linenos">187</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">http_client</span>
</span><span id="Client-188"><a href="#Client-188"><span class="linenos">188</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client-189"><a href="#Client-189"><span class="linenos">189</span></a>      <span class="k">if</span> <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-190"><a href="#Client-190"><span class="linenos">190</span></a>        <span class="n">timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Client-191"><a href="#Client-191"><span class="linenos">191</span></a>        <span class="k">if</span> <span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">client_buffer_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-192"><a href="#Client-192"><span class="linenos">192</span></a>          <span class="n">timeout_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">query_timeout</span> <span class="o">+</span> <span class="n">client_buffer_timeout</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="Client-193"><a href="#Client-193"><span class="linenos">193</span></a>        <span class="n">read_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Client-194"><a href="#Client-194"><span class="linenos">194</span></a>        <span class="k">if</span> <span class="n">http_read_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-195"><a href="#Client-195"><span class="linenos">195</span></a>          <span class="n">read_timeout_s</span> <span class="o">=</span> <span class="n">http_read_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="Client-196"><a href="#Client-196"><span class="linenos">196</span></a>
</span><span id="Client-197"><a href="#Client-197"><span class="linenos">197</span></a>        <span class="n">write_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_write_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="Client-198"><a href="#Client-198"><span class="linenos">198</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_write_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-199"><a href="#Client-199"><span class="linenos">199</span></a>        <span class="n">connect_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_connect_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="Client-200"><a href="#Client-200"><span class="linenos">200</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_connect_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-201"><a href="#Client-201"><span class="linenos">201</span></a>        <span class="n">pool_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_pool_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="Client-202"><a href="#Client-202"><span class="linenos">202</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_pool_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-203"><a href="#Client-203"><span class="linenos">203</span></a>        <span class="n">idle_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_idle_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="Client-204"><a href="#Client-204"><span class="linenos">204</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_idle_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-205"><a href="#Client-205"><span class="linenos">205</span></a>
</span><span id="Client-206"><a href="#Client-206"><span class="linenos">206</span></a>        <span class="kn">import</span> <span class="nn">httpx</span>
</span><span id="Client-207"><a href="#Client-207"><span class="linenos">207</span></a>        <span class="kn">from</span> <span class="nn">fauna.http.httpx_client</span> <span class="kn">import</span> <span class="n">HTTPXClient</span>
</span><span id="Client-208"><a href="#Client-208"><span class="linenos">208</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">HTTPXClient</span><span class="p">(</span>
</span><span id="Client-209"><a href="#Client-209"><span class="linenos">209</span></a>            <span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
</span><span id="Client-210"><a href="#Client-210"><span class="linenos">210</span></a>                <span class="n">http1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Client-211"><a href="#Client-211"><span class="linenos">211</span></a>                <span class="n">http2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Client-212"><a href="#Client-212"><span class="linenos">212</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span>
</span><span id="Client-213"><a href="#Client-213"><span class="linenos">213</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">,</span>
</span><span id="Client-214"><a href="#Client-214"><span class="linenos">214</span></a>                    <span class="n">connect</span><span class="o">=</span><span class="n">connect_timeout_s</span><span class="p">,</span>
</span><span id="Client-215"><a href="#Client-215"><span class="linenos">215</span></a>                    <span class="n">read</span><span class="o">=</span><span class="n">read_timeout_s</span><span class="p">,</span>
</span><span id="Client-216"><a href="#Client-216"><span class="linenos">216</span></a>                    <span class="n">write</span><span class="o">=</span><span class="n">write_timeout_s</span><span class="p">,</span>
</span><span id="Client-217"><a href="#Client-217"><span class="linenos">217</span></a>                    <span class="n">pool</span><span class="o">=</span><span class="n">pool_timeout_s</span><span class="p">,</span>
</span><span id="Client-218"><a href="#Client-218"><span class="linenos">218</span></a>                <span class="p">),</span>
</span><span id="Client-219"><a href="#Client-219"><span class="linenos">219</span></a>                <span class="n">limits</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Limits</span><span class="p">(</span>
</span><span id="Client-220"><a href="#Client-220"><span class="linenos">220</span></a>                    <span class="n">max_connections</span><span class="o">=</span><span class="n">DefaultMaxConnections</span><span class="p">,</span>
</span><span id="Client-221"><a href="#Client-221"><span class="linenos">221</span></a>                    <span class="n">max_keepalive_connections</span><span class="o">=</span><span class="n">DefaultMaxIdleConnections</span><span class="p">,</span>
</span><span id="Client-222"><a href="#Client-222"><span class="linenos">222</span></a>                    <span class="n">keepalive_expiry</span><span class="o">=</span><span class="n">idle_timeout_s</span><span class="p">,</span>
</span><span id="Client-223"><a href="#Client-223"><span class="linenos">223</span></a>                <span class="p">),</span>
</span><span id="Client-224"><a href="#Client-224"><span class="linenos">224</span></a>            <span class="p">),</span> <span class="n">logger</span><span class="p">)</span>
</span><span id="Client-225"><a href="#Client-225"><span class="linenos">225</span></a>        <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="Client-226"><a href="#Client-226"><span class="linenos">226</span></a>
</span><span id="Client-227"><a href="#Client-227"><span class="linenos">227</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span>
</span><span id="Client-228"><a href="#Client-228"><span class="linenos">228</span></a>
</span><span id="Client-229"><a href="#Client-229"><span class="linenos">229</span></a>  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Client-230"><a href="#Client-230"><span class="linenos">230</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Client-231"><a href="#Client-231"><span class="linenos">231</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">==</span> <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span><span class="p">:</span>
</span><span id="Client-232"><a href="#Client-232"><span class="linenos">232</span></a>      <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Client-233"><a href="#Client-233"><span class="linenos">233</span></a>
</span><span id="Client-234"><a href="#Client-234"><span class="linenos">234</span></a>  <span class="k">def</span> <span class="nf">set_last_txn_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txn_ts</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="Client-235"><a href="#Client-235"><span class="linenos">235</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client-236"><a href="#Client-236"><span class="linenos">236</span></a><span class="sd">        Set the last timestamp seen by this client.</span>
</span><span id="Client-237"><a href="#Client-237"><span class="linenos">237</span></a><span class="sd">        This has no effect if earlier than stored timestamp.</span>
</span><span id="Client-238"><a href="#Client-238"><span class="linenos">238</span></a>
</span><span id="Client-239"><a href="#Client-239"><span class="linenos">239</span></a><span class="sd">        .. WARNING:: This should be used only when coordinating timestamps across</span>
</span><span id="Client-240"><a href="#Client-240"><span class="linenos">240</span></a><span class="sd">        multiple clients. Moving the timestamp arbitrarily forward into</span>
</span><span id="Client-241"><a href="#Client-241"><span class="linenos">241</span></a><span class="sd">        the future will cause transactions to stall.</span>
</span><span id="Client-242"><a href="#Client-242"><span class="linenos">242</span></a>
</span><span id="Client-243"><a href="#Client-243"><span class="linenos">243</span></a><span class="sd">        :param txn_ts: the new transaction time.</span>
</span><span id="Client-244"><a href="#Client-244"><span class="linenos">244</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client-245"><a href="#Client-245"><span class="linenos">245</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span><span class="o">.</span><span class="n">update_txn_time</span><span class="p">(</span><span class="n">txn_ts</span><span class="p">)</span>
</span><span id="Client-246"><a href="#Client-246"><span class="linenos">246</span></a>
</span><span id="Client-247"><a href="#Client-247"><span class="linenos">247</span></a>  <span class="k">def</span> <span class="nf">get_last_txn_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Client-248"><a href="#Client-248"><span class="linenos">248</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client-249"><a href="#Client-249"><span class="linenos">249</span></a><span class="sd">        Get the last timestamp seen by this client.</span>
</span><span id="Client-250"><a href="#Client-250"><span class="linenos">250</span></a><span class="sd">        :return:</span>
</span><span id="Client-251"><a href="#Client-251"><span class="linenos">251</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client-252"><a href="#Client-252"><span class="linenos">252</span></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span><span class="o">.</span><span class="n">time</span>
</span><span id="Client-253"><a href="#Client-253"><span class="linenos">253</span></a>
</span><span id="Client-254"><a href="#Client-254"><span class="linenos">254</span></a>  <span class="k">def</span> <span class="nf">get_query_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]:</span>
</span><span id="Client-255"><a href="#Client-255"><span class="linenos">255</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client-256"><a href="#Client-256"><span class="linenos">256</span></a><span class="sd">        Get the query timeout for all queries.</span>
</span><span id="Client-257"><a href="#Client-257"><span class="linenos">257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client-258"><a href="#Client-258"><span class="linenos">258</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-259"><a href="#Client-259"><span class="linenos">259</span></a>      <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span><span class="p">)</span>
</span><span id="Client-260"><a href="#Client-260"><span class="linenos">260</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client-261"><a href="#Client-261"><span class="linenos">261</span></a>      <span class="k">return</span> <span class="kc">None</span>
</span><span id="Client-262"><a href="#Client-262"><span class="linenos">262</span></a>
</span><span id="Client-263"><a href="#Client-263"><span class="linenos">263</span></a>  <span class="k">def</span> <span class="nf">paginate</span><span class="p">(</span>
</span><span id="Client-264"><a href="#Client-264"><span class="linenos">264</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client-265"><a href="#Client-265"><span class="linenos">265</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
</span><span id="Client-266"><a href="#Client-266"><span class="linenos">266</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-267"><a href="#Client-267"><span class="linenos">267</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;QueryIterator&quot;</span><span class="p">:</span>
</span><span id="Client-268"><a href="#Client-268"><span class="linenos">268</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client-269"><a href="#Client-269"><span class="linenos">269</span></a><span class="sd">        Run a query on Fauna and returning an iterator of results. If the query</span>
</span><span id="Client-270"><a href="#Client-270"><span class="linenos">270</span></a><span class="sd">        returns a Page, the iterator will fetch additional Pages until the</span>
</span><span id="Client-271"><a href="#Client-271"><span class="linenos">271</span></a><span class="sd">        after token is null. Each call for a page will be retried with exponential</span>
</span><span id="Client-272"><a href="#Client-272"><span class="linenos">272</span></a><span class="sd">        backoff up to the max_attempts set in the client&#39;s retry policy in the</span>
</span><span id="Client-273"><a href="#Client-273"><span class="linenos">273</span></a><span class="sd">        event of a 429 or 502.</span>
</span><span id="Client-274"><a href="#Client-274"><span class="linenos">274</span></a>
</span><span id="Client-275"><a href="#Client-275"><span class="linenos">275</span></a><span class="sd">        :param fql: A Query</span>
</span><span id="Client-276"><a href="#Client-276"><span class="linenos">276</span></a><span class="sd">        :param opts: (Optional) Query Options</span>
</span><span id="Client-277"><a href="#Client-277"><span class="linenos">277</span></a>
</span><span id="Client-278"><a href="#Client-278"><span class="linenos">278</span></a><span class="sd">        :return: a :class:`QueryResponse`</span>
</span><span id="Client-279"><a href="#Client-279"><span class="linenos">279</span></a>
</span><span id="Client-280"><a href="#Client-280"><span class="linenos">280</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="Client-281"><a href="#Client-281"><span class="linenos">281</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="Client-282"><a href="#Client-282"><span class="linenos">282</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="Client-283"><a href="#Client-283"><span class="linenos">283</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="Client-284"><a href="#Client-284"><span class="linenos">284</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="Client-285"><a href="#Client-285"><span class="linenos">285</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client-286"><a href="#Client-286"><span class="linenos">286</span></a>
</span><span id="Client-287"><a href="#Client-287"><span class="linenos">287</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="Client-288"><a href="#Client-288"><span class="linenos">288</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be a Query but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="Client-289"><a href="#Client-289"><span class="linenos">289</span></a>                 <span class="sa">f</span><span class="s2">&quot;Query by calling fauna.fql()&quot;</span>
</span><span id="Client-290"><a href="#Client-290"><span class="linenos">290</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="Client-291"><a href="#Client-291"><span class="linenos">291</span></a>
</span><span id="Client-292"><a href="#Client-292"><span class="linenos">292</span></a>    <span class="k">return</span> <span class="n">QueryIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fql</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span><span id="Client-293"><a href="#Client-293"><span class="linenos">293</span></a>
</span><span id="Client-294"><a href="#Client-294"><span class="linenos">294</span></a>  <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="Client-295"><a href="#Client-295"><span class="linenos">295</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client-296"><a href="#Client-296"><span class="linenos">296</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
</span><span id="Client-297"><a href="#Client-297"><span class="linenos">297</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-298"><a href="#Client-298"><span class="linenos">298</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySuccess</span><span class="p">:</span>
</span><span id="Client-299"><a href="#Client-299"><span class="linenos">299</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client-300"><a href="#Client-300"><span class="linenos">300</span></a><span class="sd">        Run a query on Fauna. A query will be retried max_attempt times with exponential backoff</span>
</span><span id="Client-301"><a href="#Client-301"><span class="linenos">301</span></a><span class="sd">        up to the max_backoff in the event of a 429.</span>
</span><span id="Client-302"><a href="#Client-302"><span class="linenos">302</span></a>
</span><span id="Client-303"><a href="#Client-303"><span class="linenos">303</span></a><span class="sd">        :param fql: A Query</span>
</span><span id="Client-304"><a href="#Client-304"><span class="linenos">304</span></a><span class="sd">        :param opts: (Optional) Query Options</span>
</span><span id="Client-305"><a href="#Client-305"><span class="linenos">305</span></a>
</span><span id="Client-306"><a href="#Client-306"><span class="linenos">306</span></a><span class="sd">        :return: a :class:`QueryResponse`</span>
</span><span id="Client-307"><a href="#Client-307"><span class="linenos">307</span></a>
</span><span id="Client-308"><a href="#Client-308"><span class="linenos">308</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="Client-309"><a href="#Client-309"><span class="linenos">309</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="Client-310"><a href="#Client-310"><span class="linenos">310</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="Client-311"><a href="#Client-311"><span class="linenos">311</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="Client-312"><a href="#Client-312"><span class="linenos">312</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="Client-313"><a href="#Client-313"><span class="linenos">313</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client-314"><a href="#Client-314"><span class="linenos">314</span></a>
</span><span id="Client-315"><a href="#Client-315"><span class="linenos">315</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="Client-316"><a href="#Client-316"><span class="linenos">316</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be a Query but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="Client-317"><a href="#Client-317"><span class="linenos">317</span></a>                 <span class="sa">f</span><span class="s2">&quot;Query by calling fauna.fql()&quot;</span>
</span><span id="Client-318"><a href="#Client-318"><span class="linenos">318</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="Client-319"><a href="#Client-319"><span class="linenos">319</span></a>
</span><span id="Client-320"><a href="#Client-320"><span class="linenos">320</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="Client-321"><a href="#Client-321"><span class="linenos">321</span></a>      <span class="n">encoded_query</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">FaunaEncoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span>
</span><span id="Client-322"><a href="#Client-322"><span class="linenos">322</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Client-323"><a href="#Client-323"><span class="linenos">323</span></a>      <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span><span class="s2">&quot;Failed to encode Query&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span><span id="Client-324"><a href="#Client-324"><span class="linenos">324</span></a>
</span><span id="Client-325"><a href="#Client-325"><span class="linenos">325</span></a>    <span class="n">retryable</span> <span class="o">=</span> <span class="n">Retryable</span><span class="p">[</span><span class="n">QuerySuccess</span><span class="p">](</span>
</span><span id="Client-326"><a href="#Client-326"><span class="linenos">326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span>
</span><span id="Client-327"><a href="#Client-327"><span class="linenos">327</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span>
</span><span id="Client-328"><a href="#Client-328"><span class="linenos">328</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">,</span>
</span><span id="Client-329"><a href="#Client-329"><span class="linenos">329</span></a>        <span class="s2">&quot;/query/1&quot;</span><span class="p">,</span>
</span><span id="Client-330"><a href="#Client-330"><span class="linenos">330</span></a>        <span class="n">fql</span><span class="o">=</span><span class="n">encoded_query</span><span class="p">,</span>
</span><span id="Client-331"><a href="#Client-331"><span class="linenos">331</span></a>        <span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span>
</span><span id="Client-332"><a href="#Client-332"><span class="linenos">332</span></a>    <span class="p">)</span>
</span><span id="Client-333"><a href="#Client-333"><span class="linenos">333</span></a>
</span><span id="Client-334"><a href="#Client-334"><span class="linenos">334</span></a>    <span class="n">r</span> <span class="o">=</span> <span class="n">retryable</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span id="Client-335"><a href="#Client-335"><span class="linenos">335</span></a>    <span class="n">r</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">attempts</span>
</span><span id="Client-336"><a href="#Client-336"><span class="linenos">336</span></a>    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">response</span>
</span><span id="Client-337"><a href="#Client-337"><span class="linenos">337</span></a>
</span><span id="Client-338"><a href="#Client-338"><span class="linenos">338</span></a>  <span class="k">def</span> <span class="nf">_query</span><span class="p">(</span>
</span><span id="Client-339"><a href="#Client-339"><span class="linenos">339</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client-340"><a href="#Client-340"><span class="linenos">340</span></a>      <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Client-341"><a href="#Client-341"><span class="linenos">341</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="Client-342"><a href="#Client-342"><span class="linenos">342</span></a>      <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-343"><a href="#Client-343"><span class="linenos">343</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client-344"><a href="#Client-344"><span class="linenos">344</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySuccess</span><span class="p">:</span>
</span><span id="Client-345"><a href="#Client-345"><span class="linenos">345</span></a>
</span><span id="Client-346"><a href="#Client-346"><span class="linenos">346</span></a>    <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Client-347"><a href="#Client-347"><span class="linenos">347</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Format</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tagged&quot;</span>
</span><span id="Client-348"><a href="#Client-348"><span class="linenos">348</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Authorization</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">bearer</span><span class="p">()</span>
</span><span id="Client-349"><a href="#Client-349"><span class="linenos">349</span></a>
</span><span id="Client-350"><a href="#Client-350"><span class="linenos">350</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-351"><a href="#Client-351"><span class="linenos">351</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span><span class="p">)</span>
</span><span id="Client-352"><a href="#Client-352"><span class="linenos">352</span></a>
</span><span id="Client-353"><a href="#Client-353"><span class="linenos">353</span></a>    <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span><span class="o">.</span><span class="n">request_header</span><span class="p">)</span>
</span><span id="Client-354"><a href="#Client-354"><span class="linenos">354</span></a>
</span><span id="Client-355"><a href="#Client-355"><span class="linenos">355</span></a>    <span class="n">query_tags</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Client-356"><a href="#Client-356"><span class="linenos">356</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-357"><a href="#Client-357"><span class="linenos">357</span></a>      <span class="n">query_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span><span class="p">)</span>
</span><span id="Client-358"><a href="#Client-358"><span class="linenos">358</span></a>
</span><span id="Client-359"><a href="#Client-359"><span class="linenos">359</span></a>    <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-360"><a href="#Client-360"><span class="linenos">360</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">linearized</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-361"><a href="#Client-361"><span class="linenos">361</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Linearized</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">linearized</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Client-362"><a href="#Client-362"><span class="linenos">362</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">max_contention_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-363"><a href="#Client-363"><span class="linenos">363</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">MaxContentionRetries</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="Client-364"><a href="#Client-364"><span class="linenos">364</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opts</span><span class="o">.</span><span class="n">max_contention_retries</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Client-365"><a href="#Client-365"><span class="linenos">365</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">traceparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-366"><a href="#Client-366"><span class="linenos">366</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Traceparent</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">traceparent</span>
</span><span id="Client-367"><a href="#Client-367"><span class="linenos">367</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-368"><a href="#Client-368"><span class="linenos">368</span></a>        <span class="n">timeout_ms</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Client-369"><a href="#Client-369"><span class="linenos">369</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeout_ms</span>
</span><span id="Client-370"><a href="#Client-370"><span class="linenos">370</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">query_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-371"><a href="#Client-371"><span class="linenos">371</span></a>        <span class="n">query_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">query_tags</span><span class="p">)</span>
</span><span id="Client-372"><a href="#Client-372"><span class="linenos">372</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">typecheck</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-373"><a href="#Client-373"><span class="linenos">373</span></a>        <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Typecheck</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">typecheck</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Client-374"><a href="#Client-374"><span class="linenos">374</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">additional_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-375"><a href="#Client-375"><span class="linenos">375</span></a>        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">additional_headers</span><span class="p">)</span>
</span><span id="Client-376"><a href="#Client-376"><span class="linenos">376</span></a>
</span><span id="Client-377"><a href="#Client-377"><span class="linenos">377</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Client-378"><a href="#Client-378"><span class="linenos">378</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Tags</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueryTags</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">query_tags</span><span class="p">)</span>
</span><span id="Client-379"><a href="#Client-379"><span class="linenos">379</span></a>
</span><span id="Client-380"><a href="#Client-380"><span class="linenos">380</span></a>    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Client-381"><a href="#Client-381"><span class="linenos">381</span></a>        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">fql</span><span class="p">,</span>
</span><span id="Client-382"><a href="#Client-382"><span class="linenos">382</span></a>        <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">arguments</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="Client-383"><a href="#Client-383"><span class="linenos">383</span></a>    <span class="p">}</span>
</span><span id="Client-384"><a href="#Client-384"><span class="linenos">384</span></a>
</span><span id="Client-385"><a href="#Client-385"><span class="linenos">385</span></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="Client-386"><a href="#Client-386"><span class="linenos">386</span></a>        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="Client-387"><a href="#Client-387"><span class="linenos">387</span></a>        <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span>
</span><span id="Client-388"><a href="#Client-388"><span class="linenos">388</span></a>        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="Client-389"><a href="#Client-389"><span class="linenos">389</span></a>        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
</span><span id="Client-390"><a href="#Client-390"><span class="linenos">390</span></a>    <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="Client-391"><a href="#Client-391"><span class="linenos">391</span></a>      <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">()</span>
</span><span id="Client-392"><a href="#Client-392"><span class="linenos">392</span></a>      <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="Client-393"><a href="#Client-393"><span class="linenos">393</span></a>      <span class="n">headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">()</span>
</span><span id="Client-394"><a href="#Client-394"><span class="linenos">394</span></a>
</span><span id="Client-395"><a href="#Client-395"><span class="linenos">395</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_check_protocol</span><span class="p">(</span><span class="n">response_json</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
</span><span id="Client-396"><a href="#Client-396"><span class="linenos">396</span></a>
</span><span id="Client-397"><a href="#Client-397"><span class="linenos">397</span></a>      <span class="n">dec</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">FaunaDecoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span>
</span><span id="Client-398"><a href="#Client-398"><span class="linenos">398</span></a>
</span><span id="Client-399"><a href="#Client-399"><span class="linenos">399</span></a>      <span class="k">if</span> <span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">399</span><span class="p">:</span>
</span><span id="Client-400"><a href="#Client-400"><span class="linenos">400</span></a>        <span class="n">FaunaError</span><span class="o">.</span><span class="n">parse_error_and_throw</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
</span><span id="Client-401"><a href="#Client-401"><span class="linenos">401</span></a>
</span><span id="Client-402"><a href="#Client-402"><span class="linenos">402</span></a>      <span class="k">if</span> <span class="s2">&quot;txn_ts&quot;</span> <span class="ow">in</span> <span class="n">dec</span><span class="p">:</span>
</span><span id="Client-403"><a href="#Client-403"><span class="linenos">403</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_last_txn_ts</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">response_json</span><span class="p">[</span><span class="s2">&quot;txn_ts&quot;</span><span class="p">]))</span>
</span><span id="Client-404"><a href="#Client-404"><span class="linenos">404</span></a>
</span><span id="Client-405"><a href="#Client-405"><span class="linenos">405</span></a>      <span class="n">stats</span> <span class="o">=</span> <span class="n">QueryStats</span><span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;stats&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-406"><a href="#Client-406"><span class="linenos">406</span></a>      <span class="n">summary</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-407"><a href="#Client-407"><span class="linenos">407</span></a>      <span class="n">query_tags</span> <span class="o">=</span> <span class="n">QueryTags</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span id="Client-408"><a href="#Client-408"><span class="linenos">408</span></a>          <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;query_tags&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;query_tags&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-409"><a href="#Client-409"><span class="linenos">409</span></a>      <span class="n">txn_ts</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;txn_ts&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;txn_ts&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-410"><a href="#Client-410"><span class="linenos">410</span></a>      <span class="n">schema_version</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;schema_version&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;schema_version&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-411"><a href="#Client-411"><span class="linenos">411</span></a>      <span class="n">traceparent</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;traceparent&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Client-412"><a href="#Client-412"><span class="linenos">412</span></a>      <span class="n">static_type</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="s2">&quot;static_type&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;static_type&quot;</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client-413"><a href="#Client-413"><span class="linenos">413</span></a>
</span><span id="Client-414"><a href="#Client-414"><span class="linenos">414</span></a>      <span class="k">return</span> <span class="n">QuerySuccess</span><span class="p">(</span>
</span><span id="Client-415"><a href="#Client-415"><span class="linenos">415</span></a>          <span class="n">data</span><span class="o">=</span><span class="n">dec</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
</span><span id="Client-416"><a href="#Client-416"><span class="linenos">416</span></a>          <span class="n">query_tags</span><span class="o">=</span><span class="n">query_tags</span><span class="p">,</span>
</span><span id="Client-417"><a href="#Client-417"><span class="linenos">417</span></a>          <span class="n">static_type</span><span class="o">=</span><span class="n">static_type</span><span class="p">,</span>
</span><span id="Client-418"><a href="#Client-418"><span class="linenos">418</span></a>          <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span>
</span><span id="Client-419"><a href="#Client-419"><span class="linenos">419</span></a>          <span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
</span><span id="Client-420"><a href="#Client-420"><span class="linenos">420</span></a>          <span class="n">traceparent</span><span class="o">=</span><span class="n">traceparent</span><span class="p">,</span>
</span><span id="Client-421"><a href="#Client-421"><span class="linenos">421</span></a>          <span class="n">txn_ts</span><span class="o">=</span><span class="n">txn_ts</span><span class="p">,</span>
</span><span id="Client-422"><a href="#Client-422"><span class="linenos">422</span></a>          <span class="n">schema_version</span><span class="o">=</span><span class="n">schema_version</span><span class="p">,</span>
</span><span id="Client-423"><a href="#Client-423"><span class="linenos">423</span></a>      <span class="p">)</span>
</span><span id="Client-424"><a href="#Client-424"><span class="linenos">424</span></a>
</span><span id="Client-425"><a href="#Client-425"><span class="linenos">425</span></a>  <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span>
</span><span id="Client-426"><a href="#Client-426"><span class="linenos">426</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client-427"><a href="#Client-427"><span class="linenos">427</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EventSource</span><span class="p">,</span> <span class="n">Query</span><span class="p">],</span>
</span><span id="Client-428"><a href="#Client-428"><span class="linenos">428</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">StreamOptions</span> <span class="o">=</span> <span class="n">StreamOptions</span><span class="p">()</span>
</span><span id="Client-429"><a href="#Client-429"><span class="linenos">429</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamIterator&quot;</span><span class="p">:</span>
</span><span id="Client-430"><a href="#Client-430"><span class="linenos">430</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client-431"><a href="#Client-431"><span class="linenos">431</span></a><span class="sd">        Opens a Stream in Fauna and returns an iterator that consume Fauna events.</span>
</span><span id="Client-432"><a href="#Client-432"><span class="linenos">432</span></a>
</span><span id="Client-433"><a href="#Client-433"><span class="linenos">433</span></a><span class="sd">        :param fql: An EventSource or a Query that returns an EventSource.</span>
</span><span id="Client-434"><a href="#Client-434"><span class="linenos">434</span></a><span class="sd">        :param opts: (Optional) Stream Options.</span>
</span><span id="Client-435"><a href="#Client-435"><span class="linenos">435</span></a>
</span><span id="Client-436"><a href="#Client-436"><span class="linenos">436</span></a><span class="sd">        :return: a :class:`StreamIterator`</span>
</span><span id="Client-437"><a href="#Client-437"><span class="linenos">437</span></a>
</span><span id="Client-438"><a href="#Client-438"><span class="linenos">438</span></a><span class="sd">        :raises ClientError: Invalid options provided</span>
</span><span id="Client-439"><a href="#Client-439"><span class="linenos">439</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="Client-440"><a href="#Client-440"><span class="linenos">440</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="Client-441"><a href="#Client-441"><span class="linenos">441</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="Client-442"><a href="#Client-442"><span class="linenos">442</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="Client-443"><a href="#Client-443"><span class="linenos">443</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="Client-444"><a href="#Client-444"><span class="linenos">444</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client-445"><a href="#Client-445"><span class="linenos">445</span></a>
</span><span id="Client-446"><a href="#Client-446"><span class="linenos">446</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="Client-447"><a href="#Client-447"><span class="linenos">447</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-448"><a href="#Client-448"><span class="linenos">448</span></a>        <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span>
</span><span id="Client-449"><a href="#Client-449"><span class="linenos">449</span></a>            <span class="s2">&quot;The &#39;cursor&#39; configuration can only be used with an event source.&quot;</span><span class="p">)</span>
</span><span id="Client-450"><a href="#Client-450"><span class="linenos">450</span></a>
</span><span id="Client-451"><a href="#Client-451"><span class="linenos">451</span></a>      <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="Client-452"><a href="#Client-452"><span class="linenos">452</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client-453"><a href="#Client-453"><span class="linenos">453</span></a>      <span class="n">source</span> <span class="o">=</span> <span class="n">fql</span>
</span><span id="Client-454"><a href="#Client-454"><span class="linenos">454</span></a>
</span><span id="Client-455"><a href="#Client-455"><span class="linenos">455</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="Client-456"><a href="#Client-456"><span class="linenos">456</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be an EventSource, or a Query that returns an EventSource but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="Client-457"><a href="#Client-457"><span class="linenos">457</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="Client-458"><a href="#Client-458"><span class="linenos">458</span></a>
</span><span id="Client-459"><a href="#Client-459"><span class="linenos">459</span></a>    <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Client-460"><a href="#Client-460"><span class="linenos">460</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Format</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tagged&quot;</span>
</span><span id="Client-461"><a href="#Client-461"><span class="linenos">461</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Authorization</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">bearer</span><span class="p">()</span>
</span><span id="Client-462"><a href="#Client-462"><span class="linenos">462</span></a>
</span><span id="Client-463"><a href="#Client-463"><span class="linenos">463</span></a>    <span class="k">return</span> <span class="n">StreamIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">+</span> <span class="s2">&quot;/stream/1&quot;</span><span class="p">,</span>
</span><span id="Client-464"><a href="#Client-464"><span class="linenos">464</span></a>                          <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
</span><span id="Client-465"><a href="#Client-465"><span class="linenos">465</span></a>
</span><span id="Client-466"><a href="#Client-466"><span class="linenos">466</span></a>  <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span>
</span><span id="Client-467"><a href="#Client-467"><span class="linenos">467</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client-468"><a href="#Client-468"><span class="linenos">468</span></a>      <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EventSource</span><span class="p">,</span> <span class="n">Query</span><span class="p">],</span>
</span><span id="Client-469"><a href="#Client-469"><span class="linenos">469</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">FeedOptions</span> <span class="o">=</span> <span class="n">FeedOptions</span><span class="p">(),</span>
</span><span id="Client-470"><a href="#Client-470"><span class="linenos">470</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FeedIterator&quot;</span><span class="p">:</span>
</span><span id="Client-471"><a href="#Client-471"><span class="linenos">471</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client-472"><a href="#Client-472"><span class="linenos">472</span></a><span class="sd">        Opens an Event Feed in Fauna and returns an iterator that consume Fauna events.</span>
</span><span id="Client-473"><a href="#Client-473"><span class="linenos">473</span></a>
</span><span id="Client-474"><a href="#Client-474"><span class="linenos">474</span></a><span class="sd">        :param source: An EventSource or a Query that returns an EventSource.</span>
</span><span id="Client-475"><a href="#Client-475"><span class="linenos">475</span></a><span class="sd">        :param opts: (Optional) Event Feed options.</span>
</span><span id="Client-476"><a href="#Client-476"><span class="linenos">476</span></a>
</span><span id="Client-477"><a href="#Client-477"><span class="linenos">477</span></a><span class="sd">        :return: a :class:`FeedIterator`</span>
</span><span id="Client-478"><a href="#Client-478"><span class="linenos">478</span></a>
</span><span id="Client-479"><a href="#Client-479"><span class="linenos">479</span></a><span class="sd">        :raises ClientError: Invalid options provided</span>
</span><span id="Client-480"><a href="#Client-480"><span class="linenos">480</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="Client-481"><a href="#Client-481"><span class="linenos">481</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="Client-482"><a href="#Client-482"><span class="linenos">482</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="Client-483"><a href="#Client-483"><span class="linenos">483</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="Client-484"><a href="#Client-484"><span class="linenos">484</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="Client-485"><a href="#Client-485"><span class="linenos">485</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client-486"><a href="#Client-486"><span class="linenos">486</span></a>
</span><span id="Client-487"><a href="#Client-487"><span class="linenos">487</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="Client-488"><a href="#Client-488"><span class="linenos">488</span></a>      <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="Client-489"><a href="#Client-489"><span class="linenos">489</span></a>
</span><span id="Client-490"><a href="#Client-490"><span class="linenos">490</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="Client-491"><a href="#Client-491"><span class="linenos">491</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;source&#39; must be an EventSource, or a Query that returns an EventSource but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="Client-492"><a href="#Client-492"><span class="linenos">492</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="Client-493"><a href="#Client-493"><span class="linenos">493</span></a>
</span><span id="Client-494"><a href="#Client-494"><span class="linenos">494</span></a>    <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Client-495"><a href="#Client-495"><span class="linenos">495</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Format</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tagged&quot;</span>
</span><span id="Client-496"><a href="#Client-496"><span class="linenos">496</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Authorization</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">bearer</span><span class="p">()</span>
</span><span id="Client-497"><a href="#Client-497"><span class="linenos">497</span></a>
</span><span id="Client-498"><a href="#Client-498"><span class="linenos">498</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-499"><a href="#Client-499"><span class="linenos">499</span></a>      <span class="n">query_timeout_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="Client-500"><a href="#Client-500"><span class="linenos">500</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">query_timeout_ms</span><span class="p">)</span>
</span><span id="Client-501"><a href="#Client-501"><span class="linenos">501</span></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-502"><a href="#Client-502"><span class="linenos">502</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span><span class="p">)</span>
</span><span id="Client-503"><a href="#Client-503"><span class="linenos">503</span></a>
</span><span id="Client-504"><a href="#Client-504"><span class="linenos">504</span></a>    <span class="k">return</span> <span class="n">FeedIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">+</span> <span class="s2">&quot;/feed/1&quot;</span><span class="p">,</span>
</span><span id="Client-505"><a href="#Client-505"><span class="linenos">505</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
</span><span id="Client-506"><a href="#Client-506"><span class="linenos">506</span></a>
</span><span id="Client-507"><a href="#Client-507"><span class="linenos">507</span></a>  <span class="k">def</span> <span class="nf">_check_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_json</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
</span><span id="Client-508"><a href="#Client-508"><span class="linenos">508</span></a>    <span class="c1"># TODO: Logic to validate wire protocol belongs elsewhere.</span>
</span><span id="Client-509"><a href="#Client-509"><span class="linenos">509</span></a>    <span class="n">should_raise</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Client-510"><a href="#Client-510"><span class="linenos">510</span></a>
</span><span id="Client-511"><a href="#Client-511"><span class="linenos">511</span></a>    <span class="c1"># check for QuerySuccess</span>
</span><span id="Client-512"><a href="#Client-512"><span class="linenos">512</span></a>    <span class="k">if</span> <span class="n">status_code</span> <span class="o">&lt;=</span> <span class="mi">399</span> <span class="ow">and</span> <span class="s2">&quot;data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response_json</span><span class="p">:</span>
</span><span id="Client-513"><a href="#Client-513"><span class="linenos">513</span></a>      <span class="n">should_raise</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Client-514"><a href="#Client-514"><span class="linenos">514</span></a>
</span><span id="Client-515"><a href="#Client-515"><span class="linenos">515</span></a>    <span class="c1"># check for QueryFailure</span>
</span><span id="Client-516"><a href="#Client-516"><span class="linenos">516</span></a>    <span class="k">if</span> <span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">399</span><span class="p">:</span>
</span><span id="Client-517"><a href="#Client-517"><span class="linenos">517</span></a>      <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response_json</span><span class="p">:</span>
</span><span id="Client-518"><a href="#Client-518"><span class="linenos">518</span></a>        <span class="n">should_raise</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Client-519"><a href="#Client-519"><span class="linenos">519</span></a>      <span class="k">else</span><span class="p">:</span>
</span><span id="Client-520"><a href="#Client-520"><span class="linenos">520</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
</span><span id="Client-521"><a href="#Client-521"><span class="linenos">521</span></a>        <span class="k">if</span> <span class="s2">&quot;code&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">e</span> <span class="ow">or</span> <span class="s2">&quot;message&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Client-522"><a href="#Client-522"><span class="linenos">522</span></a>          <span class="n">should_raise</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Client-523"><a href="#Client-523"><span class="linenos">523</span></a>
</span><span id="Client-524"><a href="#Client-524"><span class="linenos">524</span></a>    <span class="k">if</span> <span class="n">should_raise</span><span class="p">:</span>
</span><span id="Client-525"><a href="#Client-525"><span class="linenos">525</span></a>      <span class="k">raise</span> <span class="n">ProtocolError</span><span class="p">(</span>
</span><span id="Client-526"><a href="#Client-526"><span class="linenos">526</span></a>          <span class="n">status_code</span><span class="p">,</span>
</span><span id="Client-527"><a href="#Client-527"><span class="linenos">527</span></a>          <span class="sa">f</span><span class="s2">&quot;Response is in an unknown format: </span><span class="se">\n</span><span class="si">{</span><span class="n">response_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Client-528"><a href="#Client-528"><span class="linenos">528</span></a>      <span class="p">)</span>
</span><span id="Client-529"><a href="#Client-529"><span class="linenos">529</span></a>
</span><span id="Client-530"><a href="#Client-530"><span class="linenos">530</span></a>  <span class="k">def</span> <span class="nf">_set_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
</span><span id="Client-531"><a href="#Client-531"><span class="linenos">531</span></a>    <span class="k">if</span> <span class="n">endpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client-532"><a href="#Client-532"><span class="linenos">532</span></a>      <span class="n">endpoint</span> <span class="o">=</span> <span class="n">_Environment</span><span class="o">.</span><span class="n">EnvFaunaEndpoint</span><span class="p">()</span>
</span><span id="Client-533"><a href="#Client-533"><span class="linenos">533</span></a>
</span><span id="Client-534"><a href="#Client-534"><span class="linenos">534</span></a>    <span class="k">if</span> <span class="n">endpoint</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
</span><span id="Client-535"><a href="#Client-535"><span class="linenos">535</span></a>      <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Client-536"><a href="#Client-536"><span class="linenos">536</span></a>
</span><span id="Client-537"><a href="#Client-537"><span class="linenos">537</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
</span></pre></div>


    

                            <div id="Client.__init__" class="classattr">
                                        <input id="Client.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Client</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">http_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="../http/http_client.html#HTTPClient">fauna.http.http_client.HTTPClient</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">query_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">linearized</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_contention_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">typecheck</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">additional_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>,</span><span class="param">	<span class="n">client_buffer_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>,</span><span class="param">	<span class="n">http_read_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">http_write_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>,</span><span class="param">	<span class="n">http_connect_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>,</span><span class="param">	<span class="n">http_pool_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>,</span><span class="param">	<span class="n">http_idle_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>,</span><span class="param">	<span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span></span>)</span>

                <label class="view-source-button" for="Client.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client.__init__-100"><a href="#Client.__init__-100"><span class="linenos">100</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Client.__init__-101"><a href="#Client.__init__-101"><span class="linenos">101</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client.__init__-102"><a href="#Client.__init__-102"><span class="linenos">102</span></a>      <span class="n">endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.__init__-103"><a href="#Client.__init__-103"><span class="linenos">103</span></a>      <span class="n">secret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.__init__-104"><a href="#Client.__init__-104"><span class="linenos">104</span></a>      <span class="n">http_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HTTPClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.__init__-105"><a href="#Client.__init__-105"><span class="linenos">105</span></a>      <span class="n">query_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.__init__-106"><a href="#Client.__init__-106"><span class="linenos">106</span></a>      <span class="n">linearized</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.__init__-107"><a href="#Client.__init__-107"><span class="linenos">107</span></a>      <span class="n">max_contention_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.__init__-108"><a href="#Client.__init__-108"><span class="linenos">108</span></a>      <span class="n">typecheck</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.__init__-109"><a href="#Client.__init__-109"><span class="linenos">109</span></a>      <span class="n">additional_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.__init__-110"><a href="#Client.__init__-110"><span class="linenos">110</span></a>      <span class="n">query_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultQueryTimeout</span><span class="p">,</span>
</span><span id="Client.__init__-111"><a href="#Client.__init__-111"><span class="linenos">111</span></a>      <span class="n">client_buffer_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultClientBufferTimeout</span><span class="p">,</span>
</span><span id="Client.__init__-112"><a href="#Client.__init__-112"><span class="linenos">112</span></a>      <span class="n">http_read_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpReadTimeout</span><span class="p">,</span>
</span><span id="Client.__init__-113"><a href="#Client.__init__-113"><span class="linenos">113</span></a>      <span class="n">http_write_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpWriteTimeout</span><span class="p">,</span>
</span><span id="Client.__init__-114"><a href="#Client.__init__-114"><span class="linenos">114</span></a>      <span class="n">http_connect_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpConnectTimeout</span><span class="p">,</span>
</span><span id="Client.__init__-115"><a href="#Client.__init__-115"><span class="linenos">115</span></a>      <span class="n">http_pool_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultHttpPoolTimeout</span><span class="p">,</span>
</span><span id="Client.__init__-116"><a href="#Client.__init__-116"><span class="linenos">116</span></a>      <span class="n">http_idle_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultIdleConnectionTimeout</span><span class="p">,</span>
</span><span id="Client.__init__-117"><a href="#Client.__init__-117"><span class="linenos">117</span></a>      <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="Client.__init__-118"><a href="#Client.__init__-118"><span class="linenos">118</span></a>      <span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="Client.__init__-119"><a href="#Client.__init__-119"><span class="linenos">119</span></a>  <span class="p">):</span>
</span><span id="Client.__init__-120"><a href="#Client.__init__-120"><span class="linenos">120</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes a Client.</span>
</span><span id="Client.__init__-121"><a href="#Client.__init__-121"><span class="linenos">121</span></a>
</span><span id="Client.__init__-122"><a href="#Client.__init__-122"><span class="linenos">122</span></a><span class="sd">        :param endpoint: The Fauna Endpoint to use. Defaults to https://db.fauna.com, or the `FAUNA_ENDPOINT` env variable.</span>
</span><span id="Client.__init__-123"><a href="#Client.__init__-123"><span class="linenos">123</span></a><span class="sd">        :param secret: The Fauna Secret to use. Defaults to empty, or the `FAUNA_SECRET` env variable.</span>
</span><span id="Client.__init__-124"><a href="#Client.__init__-124"><span class="linenos">124</span></a><span class="sd">        :param http_client: An :class:`HTTPClient` implementation. Defaults to a global :class:`HTTPXClient`.</span>
</span><span id="Client.__init__-125"><a href="#Client.__init__-125"><span class="linenos">125</span></a><span class="sd">        :param query_tags: Tags to associate with the query. See `logging &lt;https://docs.fauna.com/fauna/current/build/logs/query_log/&gt;`_</span>
</span><span id="Client.__init__-126"><a href="#Client.__init__-126"><span class="linenos">126</span></a><span class="sd">        :param linearized: If true, unconditionally run the query as strictly serialized. This affects read-only transactions. Transactions which write will always be strictly serialized.</span>
</span><span id="Client.__init__-127"><a href="#Client.__init__-127"><span class="linenos">127</span></a><span class="sd">        :param max_contention_retries: The max number of times to retry the query if contention is encountered.</span>
</span><span id="Client.__init__-128"><a href="#Client.__init__-128"><span class="linenos">128</span></a><span class="sd">        :param typecheck: Enable or disable typechecking of the query before evaluation. If not set, Fauna will use the value of the &quot;typechecked&quot; flag on the database configuration.</span>
</span><span id="Client.__init__-129"><a href="#Client.__init__-129"><span class="linenos">129</span></a><span class="sd">        :param additional_headers: Add/update HTTP request headers for the query. In general, this should not be necessary.</span>
</span><span id="Client.__init__-130"><a href="#Client.__init__-130"><span class="linenos">130</span></a><span class="sd">        :param query_timeout: Controls the maximum amount of time Fauna will execute your query before marking it failed, default is :py:data:`DefaultQueryTimeout`.</span>
</span><span id="Client.__init__-131"><a href="#Client.__init__-131"><span class="linenos">131</span></a><span class="sd">        :param client_buffer_timeout: Time in milliseconds beyond query_timeout at which the client will abort a request if it has not received a response. The default is :py:data:`DefaultClientBufferTimeout`, which should account for network latency for most clients. The value must be greater than zero. The closer to zero the value is, the more likely the client is to abort the request before the server can report a legitimate response or error.</span>
</span><span id="Client.__init__-132"><a href="#Client.__init__-132"><span class="linenos">132</span></a><span class="sd">        :param http_read_timeout: Set HTTP Read timeout, default is :py:data:`DefaultHttpReadTimeout`.</span>
</span><span id="Client.__init__-133"><a href="#Client.__init__-133"><span class="linenos">133</span></a><span class="sd">        :param http_write_timeout: Set HTTP Write timeout, default is :py:data:`DefaultHttpWriteTimeout`.</span>
</span><span id="Client.__init__-134"><a href="#Client.__init__-134"><span class="linenos">134</span></a><span class="sd">        :param http_connect_timeout: Set HTTP Connect timeout, default is :py:data:`DefaultHttpConnectTimeout`.</span>
</span><span id="Client.__init__-135"><a href="#Client.__init__-135"><span class="linenos">135</span></a><span class="sd">        :param http_pool_timeout: Set HTTP Pool timeout, default is :py:data:`DefaultHttpPoolTimeout`.</span>
</span><span id="Client.__init__-136"><a href="#Client.__init__-136"><span class="linenos">136</span></a><span class="sd">        :param http_idle_timeout: Set HTTP Idle timeout, default is :py:data:`DefaultIdleConnectionTimeout`.</span>
</span><span id="Client.__init__-137"><a href="#Client.__init__-137"><span class="linenos">137</span></a><span class="sd">        :param max_attempts: The maximum number of times to attempt a query when a retryable exception is thrown. Defaults to 3.</span>
</span><span id="Client.__init__-138"><a href="#Client.__init__-138"><span class="linenos">138</span></a><span class="sd">        :param max_backoff: The maximum backoff in seconds for an individual retry. Defaults to 20.</span>
</span><span id="Client.__init__-139"><a href="#Client.__init__-139"><span class="linenos">139</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client.__init__-140"><a href="#Client.__init__-140"><span class="linenos">140</span></a>
</span><span id="Client.__init__-141"><a href="#Client.__init__-141"><span class="linenos">141</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_set_endpoint</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
</span><span id="Client.__init__-142"><a href="#Client.__init__-142"><span class="linenos">142</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span> <span class="o">=</span> <span class="n">max_attempts</span>
</span><span id="Client.__init__-143"><a href="#Client.__init__-143"><span class="linenos">143</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span> <span class="o">=</span> <span class="n">max_backoff</span>
</span><span id="Client.__init__-144"><a href="#Client.__init__-144"><span class="linenos">144</span></a>
</span><span id="Client.__init__-145"><a href="#Client.__init__-145"><span class="linenos">145</span></a>    <span class="k">if</span> <span class="n">secret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-146"><a href="#Client.__init__-146"><span class="linenos">146</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span> <span class="o">=</span> <span class="n">_Auth</span><span class="p">(</span><span class="n">_Environment</span><span class="o">.</span><span class="n">EnvFaunaSecret</span><span class="p">())</span>
</span><span id="Client.__init__-147"><a href="#Client.__init__-147"><span class="linenos">147</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client.__init__-148"><a href="#Client.__init__-148"><span class="linenos">148</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span> <span class="o">=</span> <span class="n">_Auth</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
</span><span id="Client.__init__-149"><a href="#Client.__init__-149"><span class="linenos">149</span></a>
</span><span id="Client.__init__-150"><a href="#Client.__init__-150"><span class="linenos">150</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span> <span class="o">=</span> <span class="n">LastTxnTs</span><span class="p">()</span>
</span><span id="Client.__init__-151"><a href="#Client.__init__-151"><span class="linenos">151</span></a>
</span><span id="Client.__init__-152"><a href="#Client.__init__-152"><span class="linenos">152</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Client.__init__-153"><a href="#Client.__init__-153"><span class="linenos">153</span></a>    <span class="k">if</span> <span class="n">query_tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-154"><a href="#Client.__init__-154"><span class="linenos">154</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_query_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_tags</span><span class="p">)</span>
</span><span id="Client.__init__-155"><a href="#Client.__init__-155"><span class="linenos">155</span></a>
</span><span id="Client.__init__-156"><a href="#Client.__init__-156"><span class="linenos">156</span></a>    <span class="k">if</span> <span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-157"><a href="#Client.__init__-157"><span class="linenos">157</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="Client.__init__-158"><a href="#Client.__init__-158"><span class="linenos">158</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client.__init__-159"><a href="#Client.__init__-159"><span class="linenos">159</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Client.__init__-160"><a href="#Client.__init__-160"><span class="linenos">160</span></a>
</span><span id="Client.__init__-161"><a href="#Client.__init__-161"><span class="linenos">161</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Client.__init__-162"><a href="#Client.__init__-162"><span class="linenos">162</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">AcceptEncoding</span><span class="p">:</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
</span><span id="Client.__init__-163"><a href="#Client.__init__-163"><span class="linenos">163</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">ContentType</span><span class="p">:</span> <span class="s2">&quot;application/json;charset=utf-8&quot;</span><span class="p">,</span>
</span><span id="Client.__init__-164"><a href="#Client.__init__-164"><span class="linenos">164</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">Driver</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
</span><span id="Client.__init__-165"><a href="#Client.__init__-165"><span class="linenos">165</span></a>        <span class="n">_Header</span><span class="o">.</span><span class="n">DriverEnv</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">_DriverEnvironment</span><span class="p">()),</span>
</span><span id="Client.__init__-166"><a href="#Client.__init__-166"><span class="linenos">166</span></a>    <span class="p">}</span>
</span><span id="Client.__init__-167"><a href="#Client.__init__-167"><span class="linenos">167</span></a>
</span><span id="Client.__init__-168"><a href="#Client.__init__-168"><span class="linenos">168</span></a>    <span class="k">if</span> <span class="n">typecheck</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-169"><a href="#Client.__init__-169"><span class="linenos">169</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Typecheck</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">typecheck</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Client.__init__-170"><a href="#Client.__init__-170"><span class="linenos">170</span></a>
</span><span id="Client.__init__-171"><a href="#Client.__init__-171"><span class="linenos">171</span></a>    <span class="k">if</span> <span class="n">linearized</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-172"><a href="#Client.__init__-172"><span class="linenos">172</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">Linearized</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">linearized</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Client.__init__-173"><a href="#Client.__init__-173"><span class="linenos">173</span></a>
</span><span id="Client.__init__-174"><a href="#Client.__init__-174"><span class="linenos">174</span></a>    <span class="k">if</span> <span class="n">max_contention_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_contention_retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Client.__init__-175"><a href="#Client.__init__-175"><span class="linenos">175</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">MaxContentionRetries</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="Client.__init__-176"><a href="#Client.__init__-176"><span class="linenos">176</span></a>          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">max_contention_retries</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Client.__init__-177"><a href="#Client.__init__-177"><span class="linenos">177</span></a>
</span><span id="Client.__init__-178"><a href="#Client.__init__-178"><span class="linenos">178</span></a>    <span class="k">if</span> <span class="n">additional_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-179"><a href="#Client.__init__-179"><span class="linenos">179</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Client.__init__-180"><a href="#Client.__init__-180"><span class="linenos">180</span></a>          <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
</span><span id="Client.__init__-181"><a href="#Client.__init__-181"><span class="linenos">181</span></a>          <span class="o">**</span><span class="n">additional_headers</span><span class="p">,</span>
</span><span id="Client.__init__-182"><a href="#Client.__init__-182"><span class="linenos">182</span></a>      <span class="p">}</span>
</span><span id="Client.__init__-183"><a href="#Client.__init__-183"><span class="linenos">183</span></a>
</span><span id="Client.__init__-184"><a href="#Client.__init__-184"><span class="linenos">184</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">:</span> <span class="n">HTTPClient</span>
</span><span id="Client.__init__-185"><a href="#Client.__init__-185"><span class="linenos">185</span></a>
</span><span id="Client.__init__-186"><a href="#Client.__init__-186"><span class="linenos">186</span></a>    <span class="k">if</span> <span class="n">http_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-187"><a href="#Client.__init__-187"><span class="linenos">187</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">http_client</span>
</span><span id="Client.__init__-188"><a href="#Client.__init__-188"><span class="linenos">188</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client.__init__-189"><a href="#Client.__init__-189"><span class="linenos">189</span></a>      <span class="k">if</span> <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-190"><a href="#Client.__init__-190"><span class="linenos">190</span></a>        <span class="n">timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Client.__init__-191"><a href="#Client.__init__-191"><span class="linenos">191</span></a>        <span class="k">if</span> <span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">client_buffer_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-192"><a href="#Client.__init__-192"><span class="linenos">192</span></a>          <span class="n">timeout_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">query_timeout</span> <span class="o">+</span> <span class="n">client_buffer_timeout</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="Client.__init__-193"><a href="#Client.__init__-193"><span class="linenos">193</span></a>        <span class="n">read_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Client.__init__-194"><a href="#Client.__init__-194"><span class="linenos">194</span></a>        <span class="k">if</span> <span class="n">http_read_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.__init__-195"><a href="#Client.__init__-195"><span class="linenos">195</span></a>          <span class="n">read_timeout_s</span> <span class="o">=</span> <span class="n">http_read_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="Client.__init__-196"><a href="#Client.__init__-196"><span class="linenos">196</span></a>
</span><span id="Client.__init__-197"><a href="#Client.__init__-197"><span class="linenos">197</span></a>        <span class="n">write_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_write_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="Client.__init__-198"><a href="#Client.__init__-198"><span class="linenos">198</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_write_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client.__init__-199"><a href="#Client.__init__-199"><span class="linenos">199</span></a>        <span class="n">connect_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_connect_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="Client.__init__-200"><a href="#Client.__init__-200"><span class="linenos">200</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_connect_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client.__init__-201"><a href="#Client.__init__-201"><span class="linenos">201</span></a>        <span class="n">pool_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_pool_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="Client.__init__-202"><a href="#Client.__init__-202"><span class="linenos">202</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_pool_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client.__init__-203"><a href="#Client.__init__-203"><span class="linenos">203</span></a>        <span class="n">idle_timeout_s</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_idle_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(</span>
</span><span id="Client.__init__-204"><a href="#Client.__init__-204"><span class="linenos">204</span></a>        <span class="p">)</span> <span class="k">if</span> <span class="n">http_idle_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Client.__init__-205"><a href="#Client.__init__-205"><span class="linenos">205</span></a>
</span><span id="Client.__init__-206"><a href="#Client.__init__-206"><span class="linenos">206</span></a>        <span class="kn">import</span> <span class="nn">httpx</span>
</span><span id="Client.__init__-207"><a href="#Client.__init__-207"><span class="linenos">207</span></a>        <span class="kn">from</span> <span class="nn">fauna.http.httpx_client</span> <span class="kn">import</span> <span class="n">HTTPXClient</span>
</span><span id="Client.__init__-208"><a href="#Client.__init__-208"><span class="linenos">208</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">HTTPXClient</span><span class="p">(</span>
</span><span id="Client.__init__-209"><a href="#Client.__init__-209"><span class="linenos">209</span></a>            <span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
</span><span id="Client.__init__-210"><a href="#Client.__init__-210"><span class="linenos">210</span></a>                <span class="n">http1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Client.__init__-211"><a href="#Client.__init__-211"><span class="linenos">211</span></a>                <span class="n">http2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Client.__init__-212"><a href="#Client.__init__-212"><span class="linenos">212</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span>
</span><span id="Client.__init__-213"><a href="#Client.__init__-213"><span class="linenos">213</span></a>                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_s</span><span class="p">,</span>
</span><span id="Client.__init__-214"><a href="#Client.__init__-214"><span class="linenos">214</span></a>                    <span class="n">connect</span><span class="o">=</span><span class="n">connect_timeout_s</span><span class="p">,</span>
</span><span id="Client.__init__-215"><a href="#Client.__init__-215"><span class="linenos">215</span></a>                    <span class="n">read</span><span class="o">=</span><span class="n">read_timeout_s</span><span class="p">,</span>
</span><span id="Client.__init__-216"><a href="#Client.__init__-216"><span class="linenos">216</span></a>                    <span class="n">write</span><span class="o">=</span><span class="n">write_timeout_s</span><span class="p">,</span>
</span><span id="Client.__init__-217"><a href="#Client.__init__-217"><span class="linenos">217</span></a>                    <span class="n">pool</span><span class="o">=</span><span class="n">pool_timeout_s</span><span class="p">,</span>
</span><span id="Client.__init__-218"><a href="#Client.__init__-218"><span class="linenos">218</span></a>                <span class="p">),</span>
</span><span id="Client.__init__-219"><a href="#Client.__init__-219"><span class="linenos">219</span></a>                <span class="n">limits</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Limits</span><span class="p">(</span>
</span><span id="Client.__init__-220"><a href="#Client.__init__-220"><span class="linenos">220</span></a>                    <span class="n">max_connections</span><span class="o">=</span><span class="n">DefaultMaxConnections</span><span class="p">,</span>
</span><span id="Client.__init__-221"><a href="#Client.__init__-221"><span class="linenos">221</span></a>                    <span class="n">max_keepalive_connections</span><span class="o">=</span><span class="n">DefaultMaxIdleConnections</span><span class="p">,</span>
</span><span id="Client.__init__-222"><a href="#Client.__init__-222"><span class="linenos">222</span></a>                    <span class="n">keepalive_expiry</span><span class="o">=</span><span class="n">idle_timeout_s</span><span class="p">,</span>
</span><span id="Client.__init__-223"><a href="#Client.__init__-223"><span class="linenos">223</span></a>                <span class="p">),</span>
</span><span id="Client.__init__-224"><a href="#Client.__init__-224"><span class="linenos">224</span></a>            <span class="p">),</span> <span class="n">logger</span><span class="p">)</span>
</span><span id="Client.__init__-225"><a href="#Client.__init__-225"><span class="linenos">225</span></a>        <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="Client.__init__-226"><a href="#Client.__init__-226"><span class="linenos">226</span></a>
</span><span id="Client.__init__-227"><a href="#Client.__init__-227"><span class="linenos">227</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span>
</span></pre></div>


            <div class="docstring"><p>Initializes a Client.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>endpoint: The Fauna Endpoint to use. Defaults to https</strong>: //db.fauna.com, or the <code>FAUNA_ENDPOINT</code> env variable.</li>
<li><strong>secret</strong>:  The Fauna Secret to use. Defaults to empty, or the <code>FAUNA_SECRET</code> env variable.</li>
<li><strong>http_client</strong>:  An <code>HTTPClient</code> implementation. Defaults to a global <code>HTTPXClient</code>.</li>
<li>**query_tags: Tags to associate with the query. See <a href="https**: //docs.fauna.com/fauna/current/build/logs/query_log/">logging </a></li>
<li><strong>linearized</strong>:  If true, unconditionally run the query as strictly serialized. This affects read-only transactions. Transactions which write will always be strictly serialized.</li>
<li><strong>max_contention_retries</strong>:  The max number of times to retry the query if contention is encountered.</li>
<li><strong>typecheck</strong>:  Enable or disable typechecking of the query before evaluation. If not set, Fauna will use the value of the "typechecked" flag on the database configuration.</li>
<li><strong>additional_headers</strong>:  Add/update HTTP request headers for the query. In general, this should not be necessary.</li>
<li><strong>query_timeout</strong>:  Controls the maximum amount of time Fauna will execute your query before marking it failed, default is <code><a href="#DefaultQueryTimeout">DefaultQueryTimeout</a></code>.</li>
<li><strong>client_buffer_timeout</strong>:  Time in milliseconds beyond query_timeout at which the client will abort a request if it has not received a response. The default is <code><a href="#DefaultClientBufferTimeout">DefaultClientBufferTimeout</a></code>, which should account for network latency for most clients. The value must be greater than zero. The closer to zero the value is, the more likely the client is to abort the request before the server can report a legitimate response or error.</li>
<li><strong>http_read_timeout</strong>:  Set HTTP Read timeout, default is <code><a href="#DefaultHttpReadTimeout">DefaultHttpReadTimeout</a></code>.</li>
<li><strong>http_write_timeout</strong>:  Set HTTP Write timeout, default is <code><a href="#DefaultHttpWriteTimeout">DefaultHttpWriteTimeout</a></code>.</li>
<li><strong>http_connect_timeout</strong>:  Set HTTP Connect timeout, default is <code><a href="#DefaultHttpConnectTimeout">DefaultHttpConnectTimeout</a></code>.</li>
<li><strong>http_pool_timeout</strong>:  Set HTTP Pool timeout, default is <code><a href="#DefaultHttpPoolTimeout">DefaultHttpPoolTimeout</a></code>.</li>
<li><strong>http_idle_timeout</strong>:  Set HTTP Idle timeout, default is <code><a href="#DefaultIdleConnectionTimeout">DefaultIdleConnectionTimeout</a></code>.</li>
<li><strong>max_attempts</strong>:  The maximum number of times to attempt a query when a retryable exception is thrown. Defaults to 3.</li>
<li><strong>max_backoff</strong>:  The maximum backoff in seconds for an individual retry. Defaults to 20.</li>
</ul>
</div>


                            </div>
                            <div id="Client.close" class="classattr">
                                        <input id="Client.close-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">close</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Client.close-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client.close"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client.close-229"><a href="#Client.close-229"><span class="linenos">229</span></a>  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Client.close-230"><a href="#Client.close-230"><span class="linenos">230</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Client.close-231"><a href="#Client.close-231"><span class="linenos">231</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">==</span> <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span><span class="p">:</span>
</span><span id="Client.close-232"><a href="#Client.close-232"><span class="linenos">232</span></a>      <span class="n">fauna</span><span class="o">.</span><span class="n">global_http_client</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="Client.set_last_txn_ts" class="classattr">
                                        <input id="Client.set_last_txn_ts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_last_txn_ts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">txn_ts</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Client.set_last_txn_ts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client.set_last_txn_ts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client.set_last_txn_ts-234"><a href="#Client.set_last_txn_ts-234"><span class="linenos">234</span></a>  <span class="k">def</span> <span class="nf">set_last_txn_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txn_ts</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="Client.set_last_txn_ts-235"><a href="#Client.set_last_txn_ts-235"><span class="linenos">235</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client.set_last_txn_ts-236"><a href="#Client.set_last_txn_ts-236"><span class="linenos">236</span></a><span class="sd">        Set the last timestamp seen by this client.</span>
</span><span id="Client.set_last_txn_ts-237"><a href="#Client.set_last_txn_ts-237"><span class="linenos">237</span></a><span class="sd">        This has no effect if earlier than stored timestamp.</span>
</span><span id="Client.set_last_txn_ts-238"><a href="#Client.set_last_txn_ts-238"><span class="linenos">238</span></a>
</span><span id="Client.set_last_txn_ts-239"><a href="#Client.set_last_txn_ts-239"><span class="linenos">239</span></a><span class="sd">        .. WARNING:: This should be used only when coordinating timestamps across</span>
</span><span id="Client.set_last_txn_ts-240"><a href="#Client.set_last_txn_ts-240"><span class="linenos">240</span></a><span class="sd">        multiple clients. Moving the timestamp arbitrarily forward into</span>
</span><span id="Client.set_last_txn_ts-241"><a href="#Client.set_last_txn_ts-241"><span class="linenos">241</span></a><span class="sd">        the future will cause transactions to stall.</span>
</span><span id="Client.set_last_txn_ts-242"><a href="#Client.set_last_txn_ts-242"><span class="linenos">242</span></a>
</span><span id="Client.set_last_txn_ts-243"><a href="#Client.set_last_txn_ts-243"><span class="linenos">243</span></a><span class="sd">        :param txn_ts: the new transaction time.</span>
</span><span id="Client.set_last_txn_ts-244"><a href="#Client.set_last_txn_ts-244"><span class="linenos">244</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client.set_last_txn_ts-245"><a href="#Client.set_last_txn_ts-245"><span class="linenos">245</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span><span class="o">.</span><span class="n">update_txn_time</span><span class="p">(</span><span class="n">txn_ts</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Set the last timestamp seen by this client.
This has no effect if earlier than stored timestamp.</p>

<p>.. WARNING:: This should be used only when coordinating timestamps across
multiple clients. Moving the timestamp arbitrarily forward into
the future will cause transactions to stall.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>txn_ts</strong>:  the new transaction time.</li>
</ul>
</div>


                            </div>
                            <div id="Client.get_last_txn_ts" class="classattr">
                                        <input id="Client.get_last_txn_ts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_last_txn_ts</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Client.get_last_txn_ts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client.get_last_txn_ts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client.get_last_txn_ts-247"><a href="#Client.get_last_txn_ts-247"><span class="linenos">247</span></a>  <span class="k">def</span> <span class="nf">get_last_txn_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Client.get_last_txn_ts-248"><a href="#Client.get_last_txn_ts-248"><span class="linenos">248</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client.get_last_txn_ts-249"><a href="#Client.get_last_txn_ts-249"><span class="linenos">249</span></a><span class="sd">        Get the last timestamp seen by this client.</span>
</span><span id="Client.get_last_txn_ts-250"><a href="#Client.get_last_txn_ts-250"><span class="linenos">250</span></a><span class="sd">        :return:</span>
</span><span id="Client.get_last_txn_ts-251"><a href="#Client.get_last_txn_ts-251"><span class="linenos">251</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client.get_last_txn_ts-252"><a href="#Client.get_last_txn_ts-252"><span class="linenos">252</span></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_txn_ts</span><span class="o">.</span><span class="n">time</span>
</span></pre></div>


            <div class="docstring"><p>Get the last timestamp seen by this client.</p>

<h6 id="returns">Returns</h6>
</div>


                            </div>
                            <div id="Client.get_query_timeout" class="classattr">
                                        <input id="Client.get_query_timeout-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_query_timeout</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Client.get_query_timeout-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client.get_query_timeout"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client.get_query_timeout-254"><a href="#Client.get_query_timeout-254"><span class="linenos">254</span></a>  <span class="k">def</span> <span class="nf">get_query_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]:</span>
</span><span id="Client.get_query_timeout-255"><a href="#Client.get_query_timeout-255"><span class="linenos">255</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client.get_query_timeout-256"><a href="#Client.get_query_timeout-256"><span class="linenos">256</span></a><span class="sd">        Get the query timeout for all queries.</span>
</span><span id="Client.get_query_timeout-257"><a href="#Client.get_query_timeout-257"><span class="linenos">257</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client.get_query_timeout-258"><a href="#Client.get_query_timeout-258"><span class="linenos">258</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.get_query_timeout-259"><a href="#Client.get_query_timeout-259"><span class="linenos">259</span></a>      <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span><span class="p">)</span>
</span><span id="Client.get_query_timeout-260"><a href="#Client.get_query_timeout-260"><span class="linenos">260</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client.get_query_timeout-261"><a href="#Client.get_query_timeout-261"><span class="linenos">261</span></a>      <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Get the query timeout for all queries.</p>
</div>


                            </div>
                            <div id="Client.paginate" class="classattr">
                                        <input id="Client.paginate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">paginate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">fql</span><span class="p">:</span> <span class="n"><a href="../query/query_builder.html#Query">fauna.query.query_builder.Query</a></span>,</span><span class="param">	<span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="#QueryOptions">QueryOptions</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#QueryIterator">QueryIterator</a></span>:</span></span>

                <label class="view-source-button" for="Client.paginate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client.paginate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client.paginate-263"><a href="#Client.paginate-263"><span class="linenos">263</span></a>  <span class="k">def</span> <span class="nf">paginate</span><span class="p">(</span>
</span><span id="Client.paginate-264"><a href="#Client.paginate-264"><span class="linenos">264</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client.paginate-265"><a href="#Client.paginate-265"><span class="linenos">265</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
</span><span id="Client.paginate-266"><a href="#Client.paginate-266"><span class="linenos">266</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.paginate-267"><a href="#Client.paginate-267"><span class="linenos">267</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;QueryIterator&quot;</span><span class="p">:</span>
</span><span id="Client.paginate-268"><a href="#Client.paginate-268"><span class="linenos">268</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client.paginate-269"><a href="#Client.paginate-269"><span class="linenos">269</span></a><span class="sd">        Run a query on Fauna and returning an iterator of results. If the query</span>
</span><span id="Client.paginate-270"><a href="#Client.paginate-270"><span class="linenos">270</span></a><span class="sd">        returns a Page, the iterator will fetch additional Pages until the</span>
</span><span id="Client.paginate-271"><a href="#Client.paginate-271"><span class="linenos">271</span></a><span class="sd">        after token is null. Each call for a page will be retried with exponential</span>
</span><span id="Client.paginate-272"><a href="#Client.paginate-272"><span class="linenos">272</span></a><span class="sd">        backoff up to the max_attempts set in the client&#39;s retry policy in the</span>
</span><span id="Client.paginate-273"><a href="#Client.paginate-273"><span class="linenos">273</span></a><span class="sd">        event of a 429 or 502.</span>
</span><span id="Client.paginate-274"><a href="#Client.paginate-274"><span class="linenos">274</span></a>
</span><span id="Client.paginate-275"><a href="#Client.paginate-275"><span class="linenos">275</span></a><span class="sd">        :param fql: A Query</span>
</span><span id="Client.paginate-276"><a href="#Client.paginate-276"><span class="linenos">276</span></a><span class="sd">        :param opts: (Optional) Query Options</span>
</span><span id="Client.paginate-277"><a href="#Client.paginate-277"><span class="linenos">277</span></a>
</span><span id="Client.paginate-278"><a href="#Client.paginate-278"><span class="linenos">278</span></a><span class="sd">        :return: a :class:`QueryResponse`</span>
</span><span id="Client.paginate-279"><a href="#Client.paginate-279"><span class="linenos">279</span></a>
</span><span id="Client.paginate-280"><a href="#Client.paginate-280"><span class="linenos">280</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="Client.paginate-281"><a href="#Client.paginate-281"><span class="linenos">281</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="Client.paginate-282"><a href="#Client.paginate-282"><span class="linenos">282</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="Client.paginate-283"><a href="#Client.paginate-283"><span class="linenos">283</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="Client.paginate-284"><a href="#Client.paginate-284"><span class="linenos">284</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="Client.paginate-285"><a href="#Client.paginate-285"><span class="linenos">285</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client.paginate-286"><a href="#Client.paginate-286"><span class="linenos">286</span></a>
</span><span id="Client.paginate-287"><a href="#Client.paginate-287"><span class="linenos">287</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="Client.paginate-288"><a href="#Client.paginate-288"><span class="linenos">288</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be a Query but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="Client.paginate-289"><a href="#Client.paginate-289"><span class="linenos">289</span></a>                 <span class="sa">f</span><span class="s2">&quot;Query by calling fauna.fql()&quot;</span>
</span><span id="Client.paginate-290"><a href="#Client.paginate-290"><span class="linenos">290</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="Client.paginate-291"><a href="#Client.paginate-291"><span class="linenos">291</span></a>
</span><span id="Client.paginate-292"><a href="#Client.paginate-292"><span class="linenos">292</span></a>    <span class="k">return</span> <span class="n">QueryIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fql</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Run a query on Fauna and returning an iterator of results. If the query
returns a Page, the iterator will fetch additional Pages until the
after token is null. Each call for a page will be retried with exponential
backoff up to the max_attempts set in the client's retry policy in the
event of a 429 or 502.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>fql</strong>:  A Query</li>
<li><strong>opts</strong>:  (Optional) Query Options</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a <code>QueryResponse</code></p>
</blockquote>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>NetworkError</strong>:  HTTP Request failed in transit</li>
<li><strong>ProtocolError</strong>:  HTTP error not from Fauna</li>
<li><strong>ServiceError</strong>:  Fauna returned an error</li>
<li><strong>ValueError</strong>:  Encoding and decoding errors</li>
<li><strong>TypeError</strong>:  Invalid param types</li>
</ul>
</div>


                            </div>
                            <div id="Client.query" class="classattr">
                                        <input id="Client.query-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">query</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">fql</span><span class="p">:</span> <span class="n"><a href="../query/query_builder.html#Query">fauna.query.query_builder.Query</a></span>,</span><span class="param">	<span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="#QueryOptions">QueryOptions</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="../encoding/wire_protocol.html#QuerySuccess">fauna.encoding.wire_protocol.QuerySuccess</a></span>:</span></span>

                <label class="view-source-button" for="Client.query-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client.query"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client.query-294"><a href="#Client.query-294"><span class="linenos">294</span></a>  <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="Client.query-295"><a href="#Client.query-295"><span class="linenos">295</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client.query-296"><a href="#Client.query-296"><span class="linenos">296</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
</span><span id="Client.query-297"><a href="#Client.query-297"><span class="linenos">297</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Client.query-298"><a href="#Client.query-298"><span class="linenos">298</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySuccess</span><span class="p">:</span>
</span><span id="Client.query-299"><a href="#Client.query-299"><span class="linenos">299</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client.query-300"><a href="#Client.query-300"><span class="linenos">300</span></a><span class="sd">        Run a query on Fauna. A query will be retried max_attempt times with exponential backoff</span>
</span><span id="Client.query-301"><a href="#Client.query-301"><span class="linenos">301</span></a><span class="sd">        up to the max_backoff in the event of a 429.</span>
</span><span id="Client.query-302"><a href="#Client.query-302"><span class="linenos">302</span></a>
</span><span id="Client.query-303"><a href="#Client.query-303"><span class="linenos">303</span></a><span class="sd">        :param fql: A Query</span>
</span><span id="Client.query-304"><a href="#Client.query-304"><span class="linenos">304</span></a><span class="sd">        :param opts: (Optional) Query Options</span>
</span><span id="Client.query-305"><a href="#Client.query-305"><span class="linenos">305</span></a>
</span><span id="Client.query-306"><a href="#Client.query-306"><span class="linenos">306</span></a><span class="sd">        :return: a :class:`QueryResponse`</span>
</span><span id="Client.query-307"><a href="#Client.query-307"><span class="linenos">307</span></a>
</span><span id="Client.query-308"><a href="#Client.query-308"><span class="linenos">308</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="Client.query-309"><a href="#Client.query-309"><span class="linenos">309</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="Client.query-310"><a href="#Client.query-310"><span class="linenos">310</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="Client.query-311"><a href="#Client.query-311"><span class="linenos">311</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="Client.query-312"><a href="#Client.query-312"><span class="linenos">312</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="Client.query-313"><a href="#Client.query-313"><span class="linenos">313</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client.query-314"><a href="#Client.query-314"><span class="linenos">314</span></a>
</span><span id="Client.query-315"><a href="#Client.query-315"><span class="linenos">315</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="Client.query-316"><a href="#Client.query-316"><span class="linenos">316</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be a Query but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="Client.query-317"><a href="#Client.query-317"><span class="linenos">317</span></a>                 <span class="sa">f</span><span class="s2">&quot;Query by calling fauna.fql()&quot;</span>
</span><span id="Client.query-318"><a href="#Client.query-318"><span class="linenos">318</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="Client.query-319"><a href="#Client.query-319"><span class="linenos">319</span></a>
</span><span id="Client.query-320"><a href="#Client.query-320"><span class="linenos">320</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="Client.query-321"><a href="#Client.query-321"><span class="linenos">321</span></a>      <span class="n">encoded_query</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">FaunaEncoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span>
</span><span id="Client.query-322"><a href="#Client.query-322"><span class="linenos">322</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Client.query-323"><a href="#Client.query-323"><span class="linenos">323</span></a>      <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span><span class="s2">&quot;Failed to encode Query&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span><span id="Client.query-324"><a href="#Client.query-324"><span class="linenos">324</span></a>
</span><span id="Client.query-325"><a href="#Client.query-325"><span class="linenos">325</span></a>    <span class="n">retryable</span> <span class="o">=</span> <span class="n">Retryable</span><span class="p">[</span><span class="n">QuerySuccess</span><span class="p">](</span>
</span><span id="Client.query-326"><a href="#Client.query-326"><span class="linenos">326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span>
</span><span id="Client.query-327"><a href="#Client.query-327"><span class="linenos">327</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span>
</span><span id="Client.query-328"><a href="#Client.query-328"><span class="linenos">328</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">,</span>
</span><span id="Client.query-329"><a href="#Client.query-329"><span class="linenos">329</span></a>        <span class="s2">&quot;/query/1&quot;</span><span class="p">,</span>
</span><span id="Client.query-330"><a href="#Client.query-330"><span class="linenos">330</span></a>        <span class="n">fql</span><span class="o">=</span><span class="n">encoded_query</span><span class="p">,</span>
</span><span id="Client.query-331"><a href="#Client.query-331"><span class="linenos">331</span></a>        <span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span>
</span><span id="Client.query-332"><a href="#Client.query-332"><span class="linenos">332</span></a>    <span class="p">)</span>
</span><span id="Client.query-333"><a href="#Client.query-333"><span class="linenos">333</span></a>
</span><span id="Client.query-334"><a href="#Client.query-334"><span class="linenos">334</span></a>    <span class="n">r</span> <span class="o">=</span> <span class="n">retryable</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span id="Client.query-335"><a href="#Client.query-335"><span class="linenos">335</span></a>    <span class="n">r</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">attempts</span>
</span><span id="Client.query-336"><a href="#Client.query-336"><span class="linenos">336</span></a>    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">response</span>
</span></pre></div>


            <div class="docstring"><p>Run a query on Fauna. A query will be retried max_attempt times with exponential backoff
up to the max_backoff in the event of a 429.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>fql</strong>:  A Query</li>
<li><strong>opts</strong>:  (Optional) Query Options</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a <code>QueryResponse</code></p>
</blockquote>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>NetworkError</strong>:  HTTP Request failed in transit</li>
<li><strong>ProtocolError</strong>:  HTTP error not from Fauna</li>
<li><strong>ServiceError</strong>:  Fauna returned an error</li>
<li><strong>ValueError</strong>:  Encoding and decoding errors</li>
<li><strong>TypeError</strong>:  Invalid param types</li>
</ul>
</div>


                            </div>
                            <div id="Client.stream" class="classattr">
                                        <input id="Client.stream-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stream</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">fql</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="../query/models.html#EventSource">fauna.query.models.EventSource</a></span><span class="p">,</span> <span class="n"><a href="../query/query_builder.html#Query">fauna.query.query_builder.Query</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">opts</span><span class="p">:</span> <span class="n"><a href="#StreamOptions">StreamOptions</a></span> <span class="o">=</span> <span class="n">StreamOptions</span><span class="p">(</span><span class="n">max_attempts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_backoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status_events</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></span><span class="return-annotation">) -> <span class="n"><a href="#StreamIterator">StreamIterator</a></span>:</span></span>

                <label class="view-source-button" for="Client.stream-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client.stream"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client.stream-425"><a href="#Client.stream-425"><span class="linenos">425</span></a>  <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span>
</span><span id="Client.stream-426"><a href="#Client.stream-426"><span class="linenos">426</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client.stream-427"><a href="#Client.stream-427"><span class="linenos">427</span></a>      <span class="n">fql</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EventSource</span><span class="p">,</span> <span class="n">Query</span><span class="p">],</span>
</span><span id="Client.stream-428"><a href="#Client.stream-428"><span class="linenos">428</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">StreamOptions</span> <span class="o">=</span> <span class="n">StreamOptions</span><span class="p">()</span>
</span><span id="Client.stream-429"><a href="#Client.stream-429"><span class="linenos">429</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StreamIterator&quot;</span><span class="p">:</span>
</span><span id="Client.stream-430"><a href="#Client.stream-430"><span class="linenos">430</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client.stream-431"><a href="#Client.stream-431"><span class="linenos">431</span></a><span class="sd">        Opens a Stream in Fauna and returns an iterator that consume Fauna events.</span>
</span><span id="Client.stream-432"><a href="#Client.stream-432"><span class="linenos">432</span></a>
</span><span id="Client.stream-433"><a href="#Client.stream-433"><span class="linenos">433</span></a><span class="sd">        :param fql: An EventSource or a Query that returns an EventSource.</span>
</span><span id="Client.stream-434"><a href="#Client.stream-434"><span class="linenos">434</span></a><span class="sd">        :param opts: (Optional) Stream Options.</span>
</span><span id="Client.stream-435"><a href="#Client.stream-435"><span class="linenos">435</span></a>
</span><span id="Client.stream-436"><a href="#Client.stream-436"><span class="linenos">436</span></a><span class="sd">        :return: a :class:`StreamIterator`</span>
</span><span id="Client.stream-437"><a href="#Client.stream-437"><span class="linenos">437</span></a>
</span><span id="Client.stream-438"><a href="#Client.stream-438"><span class="linenos">438</span></a><span class="sd">        :raises ClientError: Invalid options provided</span>
</span><span id="Client.stream-439"><a href="#Client.stream-439"><span class="linenos">439</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="Client.stream-440"><a href="#Client.stream-440"><span class="linenos">440</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="Client.stream-441"><a href="#Client.stream-441"><span class="linenos">441</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="Client.stream-442"><a href="#Client.stream-442"><span class="linenos">442</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="Client.stream-443"><a href="#Client.stream-443"><span class="linenos">443</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="Client.stream-444"><a href="#Client.stream-444"><span class="linenos">444</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client.stream-445"><a href="#Client.stream-445"><span class="linenos">445</span></a>
</span><span id="Client.stream-446"><a href="#Client.stream-446"><span class="linenos">446</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="Client.stream-447"><a href="#Client.stream-447"><span class="linenos">447</span></a>      <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.stream-448"><a href="#Client.stream-448"><span class="linenos">448</span></a>        <span class="k">raise</span> <span class="n">ClientError</span><span class="p">(</span>
</span><span id="Client.stream-449"><a href="#Client.stream-449"><span class="linenos">449</span></a>            <span class="s2">&quot;The &#39;cursor&#39; configuration can only be used with an event source.&quot;</span><span class="p">)</span>
</span><span id="Client.stream-450"><a href="#Client.stream-450"><span class="linenos">450</span></a>
</span><span id="Client.stream-451"><a href="#Client.stream-451"><span class="linenos">451</span></a>      <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="Client.stream-452"><a href="#Client.stream-452"><span class="linenos">452</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Client.stream-453"><a href="#Client.stream-453"><span class="linenos">453</span></a>      <span class="n">source</span> <span class="o">=</span> <span class="n">fql</span>
</span><span id="Client.stream-454"><a href="#Client.stream-454"><span class="linenos">454</span></a>
</span><span id="Client.stream-455"><a href="#Client.stream-455"><span class="linenos">455</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="Client.stream-456"><a href="#Client.stream-456"><span class="linenos">456</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be an EventSource, or a Query that returns an EventSource but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="Client.stream-457"><a href="#Client.stream-457"><span class="linenos">457</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="Client.stream-458"><a href="#Client.stream-458"><span class="linenos">458</span></a>
</span><span id="Client.stream-459"><a href="#Client.stream-459"><span class="linenos">459</span></a>    <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Client.stream-460"><a href="#Client.stream-460"><span class="linenos">460</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Format</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tagged&quot;</span>
</span><span id="Client.stream-461"><a href="#Client.stream-461"><span class="linenos">461</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Authorization</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">bearer</span><span class="p">()</span>
</span><span id="Client.stream-462"><a href="#Client.stream-462"><span class="linenos">462</span></a>
</span><span id="Client.stream-463"><a href="#Client.stream-463"><span class="linenos">463</span></a>    <span class="k">return</span> <span class="n">StreamIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">+</span> <span class="s2">&quot;/stream/1&quot;</span><span class="p">,</span>
</span><span id="Client.stream-464"><a href="#Client.stream-464"><span class="linenos">464</span></a>                          <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Opens a Stream in Fauna and returns an iterator that consume Fauna events.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>fql</strong>:  An EventSource or a Query that returns an EventSource.</li>
<li><strong>opts</strong>:  (Optional) Stream Options.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a <code><a href="#StreamIterator">StreamIterator</a></code></p>
</blockquote>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ClientError</strong>:  Invalid options provided</li>
<li><strong>NetworkError</strong>:  HTTP Request failed in transit</li>
<li><strong>ProtocolError</strong>:  HTTP error not from Fauna</li>
<li><strong>ServiceError</strong>:  Fauna returned an error</li>
<li><strong>ValueError</strong>:  Encoding and decoding errors</li>
<li><strong>TypeError</strong>:  Invalid param types</li>
</ul>
</div>


                            </div>
                            <div id="Client.feed" class="classattr">
                                        <input id="Client.feed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">feed</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="../query/models.html#EventSource">fauna.query.models.EventSource</a></span><span class="p">,</span> <span class="n"><a href="../query/query_builder.html#Query">fauna.query.query_builder.Query</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">opts</span><span class="p">:</span> <span class="n"><a href="#FeedOptions">FeedOptions</a></span> <span class="o">=</span> <span class="n">FeedOptions</span><span class="p">(</span><span class="n">max_attempts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_backoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">page_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></span><span class="return-annotation">) -> <span class="n"><a href="#FeedIterator">FeedIterator</a></span>:</span></span>

                <label class="view-source-button" for="Client.feed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Client.feed"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Client.feed-466"><a href="#Client.feed-466"><span class="linenos">466</span></a>  <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span>
</span><span id="Client.feed-467"><a href="#Client.feed-467"><span class="linenos">467</span></a>      <span class="bp">self</span><span class="p">,</span>
</span><span id="Client.feed-468"><a href="#Client.feed-468"><span class="linenos">468</span></a>      <span class="n">source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EventSource</span><span class="p">,</span> <span class="n">Query</span><span class="p">],</span>
</span><span id="Client.feed-469"><a href="#Client.feed-469"><span class="linenos">469</span></a>      <span class="n">opts</span><span class="p">:</span> <span class="n">FeedOptions</span> <span class="o">=</span> <span class="n">FeedOptions</span><span class="p">(),</span>
</span><span id="Client.feed-470"><a href="#Client.feed-470"><span class="linenos">470</span></a>  <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FeedIterator&quot;</span><span class="p">:</span>
</span><span id="Client.feed-471"><a href="#Client.feed-471"><span class="linenos">471</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Client.feed-472"><a href="#Client.feed-472"><span class="linenos">472</span></a><span class="sd">        Opens an Event Feed in Fauna and returns an iterator that consume Fauna events.</span>
</span><span id="Client.feed-473"><a href="#Client.feed-473"><span class="linenos">473</span></a>
</span><span id="Client.feed-474"><a href="#Client.feed-474"><span class="linenos">474</span></a><span class="sd">        :param source: An EventSource or a Query that returns an EventSource.</span>
</span><span id="Client.feed-475"><a href="#Client.feed-475"><span class="linenos">475</span></a><span class="sd">        :param opts: (Optional) Event Feed options.</span>
</span><span id="Client.feed-476"><a href="#Client.feed-476"><span class="linenos">476</span></a>
</span><span id="Client.feed-477"><a href="#Client.feed-477"><span class="linenos">477</span></a><span class="sd">        :return: a :class:`FeedIterator`</span>
</span><span id="Client.feed-478"><a href="#Client.feed-478"><span class="linenos">478</span></a>
</span><span id="Client.feed-479"><a href="#Client.feed-479"><span class="linenos">479</span></a><span class="sd">        :raises ClientError: Invalid options provided</span>
</span><span id="Client.feed-480"><a href="#Client.feed-480"><span class="linenos">480</span></a><span class="sd">        :raises NetworkError: HTTP Request failed in transit</span>
</span><span id="Client.feed-481"><a href="#Client.feed-481"><span class="linenos">481</span></a><span class="sd">        :raises ProtocolError: HTTP error not from Fauna</span>
</span><span id="Client.feed-482"><a href="#Client.feed-482"><span class="linenos">482</span></a><span class="sd">        :raises ServiceError: Fauna returned an error</span>
</span><span id="Client.feed-483"><a href="#Client.feed-483"><span class="linenos">483</span></a><span class="sd">        :raises ValueError: Encoding and decoding errors</span>
</span><span id="Client.feed-484"><a href="#Client.feed-484"><span class="linenos">484</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="Client.feed-485"><a href="#Client.feed-485"><span class="linenos">485</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Client.feed-486"><a href="#Client.feed-486"><span class="linenos">486</span></a>
</span><span id="Client.feed-487"><a href="#Client.feed-487"><span class="linenos">487</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="Client.feed-488"><a href="#Client.feed-488"><span class="linenos">488</span></a>      <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="Client.feed-489"><a href="#Client.feed-489"><span class="linenos">489</span></a>
</span><span id="Client.feed-490"><a href="#Client.feed-490"><span class="linenos">490</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="Client.feed-491"><a href="#Client.feed-491"><span class="linenos">491</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;source&#39; must be an EventSource, or a Query that returns an EventSource but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="Client.feed-492"><a href="#Client.feed-492"><span class="linenos">492</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="Client.feed-493"><a href="#Client.feed-493"><span class="linenos">493</span></a>
</span><span id="Client.feed-494"><a href="#Client.feed-494"><span class="linenos">494</span></a>    <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Client.feed-495"><a href="#Client.feed-495"><span class="linenos">495</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Format</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tagged&quot;</span>
</span><span id="Client.feed-496"><a href="#Client.feed-496"><span class="linenos">496</span></a>    <span class="n">headers</span><span class="p">[</span><span class="n">_Header</span><span class="o">.</span><span class="n">Authorization</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">bearer</span><span class="p">()</span>
</span><span id="Client.feed-497"><a href="#Client.feed-497"><span class="linenos">497</span></a>
</span><span id="Client.feed-498"><a href="#Client.feed-498"><span class="linenos">498</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.feed-499"><a href="#Client.feed-499"><span class="linenos">499</span></a>      <span class="n">query_timeout_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">query_timeout</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="Client.feed-500"><a href="#Client.feed-500"><span class="linenos">500</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">query_timeout_ms</span><span class="p">)</span>
</span><span id="Client.feed-501"><a href="#Client.feed-501"><span class="linenos">501</span></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Client.feed-502"><a href="#Client.feed-502"><span class="linenos">502</span></a>      <span class="n">headers</span><span class="p">[</span><span class="n">Header</span><span class="o">.</span><span class="n">QueryTimeoutMs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_query_timeout_ms</span><span class="p">)</span>
</span><span id="Client.feed-503"><a href="#Client.feed-503"><span class="linenos">503</span></a>
</span><span id="Client.feed-504"><a href="#Client.feed-504"><span class="linenos">504</span></a>    <span class="k">return</span> <span class="n">FeedIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">+</span> <span class="s2">&quot;/feed/1&quot;</span><span class="p">,</span>
</span><span id="Client.feed-505"><a href="#Client.feed-505"><span class="linenos">505</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Opens an Event Feed in Fauna and returns an iterator that consume Fauna events.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>source</strong>:  An EventSource or a Query that returns an EventSource.</li>
<li><strong>opts</strong>:  (Optional) Event Feed options.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>a <code><a href="#FeedIterator">FeedIterator</a></code></p>
</blockquote>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ClientError</strong>:  Invalid options provided</li>
<li><strong>NetworkError</strong>:  HTTP Request failed in transit</li>
<li><strong>ProtocolError</strong>:  HTTP error not from Fauna</li>
<li><strong>ServiceError</strong>:  Fauna returned an error</li>
<li><strong>ValueError</strong>:  Encoding and decoding errors</li>
<li><strong>TypeError</strong>:  Invalid param types</li>
</ul>
</div>


                            </div>
                </section>
                <section id="StreamIterator">
                            <input id="StreamIterator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">StreamIterator</span>:

                <label class="view-source-button" for="StreamIterator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StreamIterator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StreamIterator-540"><a href="#StreamIterator-540"><span class="linenos">540</span></a><span class="k">class</span> <span class="nc">StreamIterator</span><span class="p">:</span>
</span><span id="StreamIterator-541"><a href="#StreamIterator-541"><span class="linenos">541</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;A class that mixes a ContextManager and an Iterator so we can detected retryable errors.&quot;&quot;&quot;</span>
</span><span id="StreamIterator-542"><a href="#StreamIterator-542"><span class="linenos">542</span></a>
</span><span id="StreamIterator-543"><a href="#StreamIterator-543"><span class="linenos">543</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http_client</span><span class="p">:</span> <span class="n">HTTPClient</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="StreamIterator-544"><a href="#StreamIterator-544"><span class="linenos">544</span></a>               <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="StreamIterator-545"><a href="#StreamIterator-545"><span class="linenos">545</span></a>               <span class="n">opts</span><span class="p">:</span> <span class="n">StreamOptions</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="StreamIterator-546"><a href="#StreamIterator-546"><span class="linenos">546</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span> <span class="o">=</span> <span class="n">http_client</span>
</span><span id="StreamIterator-547"><a href="#StreamIterator-547"><span class="linenos">547</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">headers</span>
</span><span id="StreamIterator-548"><a href="#StreamIterator-548"><span class="linenos">548</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
</span><span id="StreamIterator-549"><a href="#StreamIterator-549"><span class="linenos">549</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span> <span class="o">=</span> <span class="n">max_attempts</span>
</span><span id="StreamIterator-550"><a href="#StreamIterator-550"><span class="linenos">550</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span> <span class="o">=</span> <span class="n">max_backoff</span>
</span><span id="StreamIterator-551"><a href="#StreamIterator-551"><span class="linenos">551</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span> <span class="o">=</span> <span class="n">opts</span>
</span><span id="StreamIterator-552"><a href="#StreamIterator-552"><span class="linenos">552</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">source</span>
</span><span id="StreamIterator-553"><a href="#StreamIterator-553"><span class="linenos">553</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamIterator-554"><a href="#StreamIterator-554"><span class="linenos">554</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_ts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamIterator-555"><a href="#StreamIterator-555"><span class="linenos">555</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamIterator-556"><a href="#StreamIterator-556"><span class="linenos">556</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_stream</span><span class="p">()</span>
</span><span id="StreamIterator-557"><a href="#StreamIterator-557"><span class="linenos">557</span></a>
</span><span id="StreamIterator-558"><a href="#StreamIterator-558"><span class="linenos">558</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-559"><a href="#StreamIterator-559"><span class="linenos">559</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Only one of &#39;start_ts&#39; or &#39;cursor&#39; can be defined in the StreamOptions.&quot;</span>
</span><span id="StreamIterator-560"><a href="#StreamIterator-560"><span class="linenos">560</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="StreamIterator-561"><a href="#StreamIterator-561"><span class="linenos">561</span></a>
</span><span id="StreamIterator-562"><a href="#StreamIterator-562"><span class="linenos">562</span></a>  <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="StreamIterator-563"><a href="#StreamIterator-563"><span class="linenos">563</span></a>    <span class="k">return</span> <span class="bp">self</span>
</span><span id="StreamIterator-564"><a href="#StreamIterator-564"><span class="linenos">564</span></a>
</span><span id="StreamIterator-565"><a href="#StreamIterator-565"><span class="linenos">565</span></a>  <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
</span><span id="StreamIterator-566"><a href="#StreamIterator-566"><span class="linenos">566</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-567"><a href="#StreamIterator-567"><span class="linenos">567</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="StreamIterator-568"><a href="#StreamIterator-568"><span class="linenos">568</span></a>
</span><span id="StreamIterator-569"><a href="#StreamIterator-569"><span class="linenos">569</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">)</span>
</span><span id="StreamIterator-570"><a href="#StreamIterator-570"><span class="linenos">570</span></a>    <span class="k">return</span> <span class="kc">False</span>
</span><span id="StreamIterator-571"><a href="#StreamIterator-571"><span class="linenos">571</span></a>
</span><span id="StreamIterator-572"><a href="#StreamIterator-572"><span class="linenos">572</span></a>  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="StreamIterator-573"><a href="#StreamIterator-573"><span class="linenos">573</span></a>    <span class="k">return</span> <span class="bp">self</span>
</span><span id="StreamIterator-574"><a href="#StreamIterator-574"><span class="linenos">574</span></a>
</span><span id="StreamIterator-575"><a href="#StreamIterator-575"><span class="linenos">575</span></a>  <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="StreamIterator-576"><a href="#StreamIterator-576"><span class="linenos">576</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">max_attempts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-577"><a href="#StreamIterator-577"><span class="linenos">577</span></a>      <span class="n">max_attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">max_attempts</span>
</span><span id="StreamIterator-578"><a href="#StreamIterator-578"><span class="linenos">578</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="StreamIterator-579"><a href="#StreamIterator-579"><span class="linenos">579</span></a>      <span class="n">max_attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span>
</span><span id="StreamIterator-580"><a href="#StreamIterator-580"><span class="linenos">580</span></a>
</span><span id="StreamIterator-581"><a href="#StreamIterator-581"><span class="linenos">581</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">max_backoff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-582"><a href="#StreamIterator-582"><span class="linenos">582</span></a>      <span class="n">max_backoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">max_backoff</span>
</span><span id="StreamIterator-583"><a href="#StreamIterator-583"><span class="linenos">583</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="StreamIterator-584"><a href="#StreamIterator-584"><span class="linenos">584</span></a>      <span class="n">max_backoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span>
</span><span id="StreamIterator-585"><a href="#StreamIterator-585"><span class="linenos">585</span></a>
</span><span id="StreamIterator-586"><a href="#StreamIterator-586"><span class="linenos">586</span></a>    <span class="n">retryable</span> <span class="o">=</span> <span class="n">Retryable</span><span class="p">[</span><span class="n">Any</span><span class="p">](</span><span class="n">max_attempts</span><span class="p">,</span> <span class="n">max_backoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_element</span><span class="p">)</span>
</span><span id="StreamIterator-587"><a href="#StreamIterator-587"><span class="linenos">587</span></a>    <span class="k">return</span> <span class="n">retryable</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">response</span>
</span><span id="StreamIterator-588"><a href="#StreamIterator-588"><span class="linenos">588</span></a>
</span><span id="StreamIterator-589"><a href="#StreamIterator-589"><span class="linenos">589</span></a>  <span class="k">def</span> <span class="nf">_next_element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="StreamIterator-590"><a href="#StreamIterator-590"><span class="linenos">590</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="StreamIterator-591"><a href="#StreamIterator-591"><span class="linenos">591</span></a>      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-592"><a href="#StreamIterator-592"><span class="linenos">592</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="StreamIterator-593"><a href="#StreamIterator-593"><span class="linenos">593</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
</span><span id="StreamIterator-594"><a href="#StreamIterator-594"><span class="linenos">594</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="StreamIterator-595"><a href="#StreamIterator-595"><span class="linenos">595</span></a>          <span class="bp">self</span><span class="o">.</span><span class="n">_retry_stream</span><span class="p">()</span>
</span><span id="StreamIterator-596"><a href="#StreamIterator-596"><span class="linenos">596</span></a>
</span><span id="StreamIterator-597"><a href="#StreamIterator-597"><span class="linenos">597</span></a>      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-598"><a href="#StreamIterator-598"><span class="linenos">598</span></a>        <span class="n">event</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">FaunaDecoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="p">))</span>
</span><span id="StreamIterator-599"><a href="#StreamIterator-599"><span class="linenos">599</span></a>
</span><span id="StreamIterator-600"><a href="#StreamIterator-600"><span class="linenos">600</span></a>        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
</span><span id="StreamIterator-601"><a href="#StreamIterator-601"><span class="linenos">601</span></a>          <span class="n">FaunaError</span><span class="o">.</span><span class="n">parse_error_and_throw</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span><span id="StreamIterator-602"><a href="#StreamIterator-602"><span class="linenos">602</span></a>
</span><span id="StreamIterator-603"><a href="#StreamIterator-603"><span class="linenos">603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_ts</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;txn_ts&quot;</span><span class="p">]</span>
</span><span id="StreamIterator-604"><a href="#StreamIterator-604"><span class="linenos">604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_cursor</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cursor&#39;</span><span class="p">)</span>
</span><span id="StreamIterator-605"><a href="#StreamIterator-605"><span class="linenos">605</span></a>
</span><span id="StreamIterator-606"><a href="#StreamIterator-606"><span class="linenos">606</span></a>        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
</span><span id="StreamIterator-607"><a href="#StreamIterator-607"><span class="linenos">607</span></a>          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_element</span><span class="p">()</span>
</span><span id="StreamIterator-608"><a href="#StreamIterator-608"><span class="linenos">608</span></a>
</span><span id="StreamIterator-609"><a href="#StreamIterator-609"><span class="linenos">609</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">status_events</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span>
</span><span id="StreamIterator-610"><a href="#StreamIterator-610"><span class="linenos">610</span></a>          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_element</span><span class="p">()</span>
</span><span id="StreamIterator-611"><a href="#StreamIterator-611"><span class="linenos">611</span></a>
</span><span id="StreamIterator-612"><a href="#StreamIterator-612"><span class="linenos">612</span></a>        <span class="k">return</span> <span class="n">event</span>
</span><span id="StreamIterator-613"><a href="#StreamIterator-613"><span class="linenos">613</span></a>
</span><span id="StreamIterator-614"><a href="#StreamIterator-614"><span class="linenos">614</span></a>      <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="StreamIterator-615"><a href="#StreamIterator-615"><span class="linenos">615</span></a>    <span class="k">except</span> <span class="n">NetworkError</span><span class="p">:</span>
</span><span id="StreamIterator-616"><a href="#StreamIterator-616"><span class="linenos">616</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_retry_stream</span><span class="p">()</span>
</span><span id="StreamIterator-617"><a href="#StreamIterator-617"><span class="linenos">617</span></a>
</span><span id="StreamIterator-618"><a href="#StreamIterator-618"><span class="linenos">618</span></a>  <span class="k">def</span> <span class="nf">_retry_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="StreamIterator-619"><a href="#StreamIterator-619"><span class="linenos">619</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-620"><a href="#StreamIterator-620"><span class="linenos">620</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="StreamIterator-621"><a href="#StreamIterator-621"><span class="linenos">621</span></a>
</span><span id="StreamIterator-622"><a href="#StreamIterator-622"><span class="linenos">622</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamIterator-623"><a href="#StreamIterator-623"><span class="linenos">623</span></a>
</span><span id="StreamIterator-624"><a href="#StreamIterator-624"><span class="linenos">624</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="StreamIterator-625"><a href="#StreamIterator-625"><span class="linenos">625</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_stream</span><span class="p">()</span>
</span><span id="StreamIterator-626"><a href="#StreamIterator-626"><span class="linenos">626</span></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="StreamIterator-627"><a href="#StreamIterator-627"><span class="linenos">627</span></a>      <span class="k">pass</span>
</span><span id="StreamIterator-628"><a href="#StreamIterator-628"><span class="linenos">628</span></a>    <span class="k">raise</span> <span class="n">RetryableFaunaException</span>
</span><span id="StreamIterator-629"><a href="#StreamIterator-629"><span class="linenos">629</span></a>
</span><span id="StreamIterator-630"><a href="#StreamIterator-630"><span class="linenos">630</span></a>  <span class="k">def</span> <span class="nf">_create_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="StreamIterator-631"><a href="#StreamIterator-631"><span class="linenos">631</span></a>    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">token</span><span class="p">}</span>
</span><span id="StreamIterator-632"><a href="#StreamIterator-632"><span class="linenos">632</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-633"><a href="#StreamIterator-633"><span class="linenos">633</span></a>      <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_cursor</span>
</span><span id="StreamIterator-634"><a href="#StreamIterator-634"><span class="linenos">634</span></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-635"><a href="#StreamIterator-635"><span class="linenos">635</span></a>      <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">cursor</span>
</span><span id="StreamIterator-636"><a href="#StreamIterator-636"><span class="linenos">636</span></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-637"><a href="#StreamIterator-637"><span class="linenos">637</span></a>      <span class="n">data</span><span class="p">[</span><span class="s2">&quot;start_ts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span><span class="o">.</span><span class="n">start_ts</span>
</span><span id="StreamIterator-638"><a href="#StreamIterator-638"><span class="linenos">638</span></a>
</span><span id="StreamIterator-639"><a href="#StreamIterator-639"><span class="linenos">639</span></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="StreamIterator-640"><a href="#StreamIterator-640"><span class="linenos">640</span></a>        <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="StreamIterator-641"><a href="#StreamIterator-641"><span class="linenos">641</span></a>
</span><span id="StreamIterator-642"><a href="#StreamIterator-642"><span class="linenos">642</span></a>  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="StreamIterator-643"><a href="#StreamIterator-643"><span class="linenos">643</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator-644"><a href="#StreamIterator-644"><span class="linenos">644</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>A class that mixes a ContextManager and an Iterator so we can detected retryable errors.</p>
</div>


                            <div id="StreamIterator.__init__" class="classattr">
                                        <input id="StreamIterator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">StreamIterator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">http_client</span><span class="p">:</span> <span class="n"><a href="../http/http_client.html#HTTPClient">fauna.http.http_client.HTTPClient</a></span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>,</span><span class="param">	<span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">opts</span><span class="p">:</span> <span class="n"><a href="#StreamOptions">StreamOptions</a></span>,</span><span class="param">	<span class="n">source</span><span class="p">:</span> <span class="n"><a href="../query/models.html#EventSource">fauna.query.models.EventSource</a></span></span>)</span>

                <label class="view-source-button" for="StreamIterator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StreamIterator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StreamIterator.__init__-543"><a href="#StreamIterator.__init__-543"><span class="linenos">543</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http_client</span><span class="p">:</span> <span class="n">HTTPClient</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="StreamIterator.__init__-544"><a href="#StreamIterator.__init__-544"><span class="linenos">544</span></a>               <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="StreamIterator.__init__-545"><a href="#StreamIterator.__init__-545"><span class="linenos">545</span></a>               <span class="n">opts</span><span class="p">:</span> <span class="n">StreamOptions</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="StreamIterator.__init__-546"><a href="#StreamIterator.__init__-546"><span class="linenos">546</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_http_client</span> <span class="o">=</span> <span class="n">http_client</span>
</span><span id="StreamIterator.__init__-547"><a href="#StreamIterator.__init__-547"><span class="linenos">547</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">headers</span>
</span><span id="StreamIterator.__init__-548"><a href="#StreamIterator.__init__-548"><span class="linenos">548</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
</span><span id="StreamIterator.__init__-549"><a href="#StreamIterator.__init__-549"><span class="linenos">549</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span> <span class="o">=</span> <span class="n">max_attempts</span>
</span><span id="StreamIterator.__init__-550"><a href="#StreamIterator.__init__-550"><span class="linenos">550</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span> <span class="o">=</span> <span class="n">max_backoff</span>
</span><span id="StreamIterator.__init__-551"><a href="#StreamIterator.__init__-551"><span class="linenos">551</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_opts</span> <span class="o">=</span> <span class="n">opts</span>
</span><span id="StreamIterator.__init__-552"><a href="#StreamIterator.__init__-552"><span class="linenos">552</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">source</span>
</span><span id="StreamIterator.__init__-553"><a href="#StreamIterator.__init__-553"><span class="linenos">553</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamIterator.__init__-554"><a href="#StreamIterator.__init__-554"><span class="linenos">554</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_ts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamIterator.__init__-555"><a href="#StreamIterator.__init__-555"><span class="linenos">555</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StreamIterator.__init__-556"><a href="#StreamIterator.__init__-556"><span class="linenos">556</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_stream</span><span class="p">()</span>
</span><span id="StreamIterator.__init__-557"><a href="#StreamIterator.__init__-557"><span class="linenos">557</span></a>
</span><span id="StreamIterator.__init__-558"><a href="#StreamIterator.__init__-558"><span class="linenos">558</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator.__init__-559"><a href="#StreamIterator.__init__-559"><span class="linenos">559</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Only one of &#39;start_ts&#39; or &#39;cursor&#39; can be defined in the StreamOptions.&quot;</span>
</span><span id="StreamIterator.__init__-560"><a href="#StreamIterator.__init__-560"><span class="linenos">560</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="StreamIterator.last_ts" class="classattr">
                                <div class="attr variable">
            <span class="name">last_ts</span>

        
    </div>
    <a class="headerlink" href="#StreamIterator.last_ts"></a>
    
    

                            </div>
                            <div id="StreamIterator.last_cursor" class="classattr">
                                <div class="attr variable">
            <span class="name">last_cursor</span>

        
    </div>
    <a class="headerlink" href="#StreamIterator.last_cursor"></a>
    
    

                            </div>
                            <div id="StreamIterator.close" class="classattr">
                                        <input id="StreamIterator.close-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">close</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="StreamIterator.close-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StreamIterator.close"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StreamIterator.close-642"><a href="#StreamIterator.close-642"><span class="linenos">642</span></a>  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="StreamIterator.close-643"><a href="#StreamIterator.close-643"><span class="linenos">643</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StreamIterator.close-644"><a href="#StreamIterator.close-644"><span class="linenos">644</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="FeedPage">
                            <input id="FeedPage-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FeedPage</span>:

                <label class="view-source-button" for="FeedPage-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FeedPage"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FeedPage-647"><a href="#FeedPage-647"><span class="linenos">647</span></a><span class="k">class</span> <span class="nc">FeedPage</span><span class="p">:</span>
</span><span id="FeedPage-648"><a href="#FeedPage-648"><span class="linenos">648</span></a>
</span><span id="FeedPage-649"><a href="#FeedPage-649"><span class="linenos">649</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">cursor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stats</span><span class="p">:</span> <span class="n">QueryStats</span><span class="p">):</span>
</span><span id="FeedPage-650"><a href="#FeedPage-650"><span class="linenos">650</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="n">events</span>
</span><span id="FeedPage-651"><a href="#FeedPage-651"><span class="linenos">651</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span>
</span><span id="FeedPage-652"><a href="#FeedPage-652"><span class="linenos">652</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span>
</span><span id="FeedPage-653"><a href="#FeedPage-653"><span class="linenos">653</span></a>
</span><span id="FeedPage-654"><a href="#FeedPage-654"><span class="linenos">654</span></a>  <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="FeedPage-655"><a href="#FeedPage-655"><span class="linenos">655</span></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">)</span>
</span><span id="FeedPage-656"><a href="#FeedPage-656"><span class="linenos">656</span></a>
</span><span id="FeedPage-657"><a href="#FeedPage-657"><span class="linenos">657</span></a>  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="FeedPage-658"><a href="#FeedPage-658"><span class="linenos">658</span></a>    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span>
</span><span id="FeedPage-659"><a href="#FeedPage-659"><span class="linenos">659</span></a>      <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
</span><span id="FeedPage-660"><a href="#FeedPage-660"><span class="linenos">660</span></a>        <span class="n">FaunaError</span><span class="o">.</span><span class="n">parse_error_and_throw</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span><span id="FeedPage-661"><a href="#FeedPage-661"><span class="linenos">661</span></a>      <span class="k">yield</span> <span class="n">event</span>
</span></pre></div>


    

                            <div id="FeedPage.__init__" class="classattr">
                                        <input id="FeedPage.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FeedPage</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">cursor</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">stats</span><span class="p">:</span> <span class="n"><a href="../encoding/wire_protocol.html#QueryStats">fauna.encoding.wire_protocol.QueryStats</a></span></span>)</span>

                <label class="view-source-button" for="FeedPage.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FeedPage.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FeedPage.__init__-649"><a href="#FeedPage.__init__-649"><span class="linenos">649</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">cursor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stats</span><span class="p">:</span> <span class="n">QueryStats</span><span class="p">):</span>
</span><span id="FeedPage.__init__-650"><a href="#FeedPage.__init__-650"><span class="linenos">650</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="n">events</span>
</span><span id="FeedPage.__init__-651"><a href="#FeedPage.__init__-651"><span class="linenos">651</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span>
</span><span id="FeedPage.__init__-652"><a href="#FeedPage.__init__-652"><span class="linenos">652</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span>
</span></pre></div>


    

                            </div>
                            <div id="FeedPage.cursor" class="classattr">
                                <div class="attr variable">
            <span class="name">cursor</span>

        
    </div>
    <a class="headerlink" href="#FeedPage.cursor"></a>
    
    

                            </div>
                            <div id="FeedPage.stats" class="classattr">
                                <div class="attr variable">
            <span class="name">stats</span>

        
    </div>
    <a class="headerlink" href="#FeedPage.stats"></a>
    
    

                            </div>
                </section>
                <section id="FeedIterator">
                            <input id="FeedIterator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FeedIterator</span>:

                <label class="view-source-button" for="FeedIterator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FeedIterator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FeedIterator-664"><a href="#FeedIterator-664"><span class="linenos">664</span></a><span class="k">class</span> <span class="nc">FeedIterator</span><span class="p">:</span>
</span><span id="FeedIterator-665"><a href="#FeedIterator-665"><span class="linenos">665</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;A class to provide an iterator on top of Event Feed pages.&quot;&quot;&quot;</span>
</span><span id="FeedIterator-666"><a href="#FeedIterator-666"><span class="linenos">666</span></a>
</span><span id="FeedIterator-667"><a href="#FeedIterator-667"><span class="linenos">667</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http</span><span class="p">:</span> <span class="n">HTTPClient</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="FeedIterator-668"><a href="#FeedIterator-668"><span class="linenos">668</span></a>               <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">opts</span><span class="p">:</span> <span class="n">FeedOptions</span><span class="p">,</span>
</span><span id="FeedIterator-669"><a href="#FeedIterator-669"><span class="linenos">669</span></a>               <span class="n">source</span><span class="p">:</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="FeedIterator-670"><a href="#FeedIterator-670"><span class="linenos">670</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_http</span> <span class="o">=</span> <span class="n">http</span>
</span><span id="FeedIterator-671"><a href="#FeedIterator-671"><span class="linenos">671</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">headers</span>
</span><span id="FeedIterator-672"><a href="#FeedIterator-672"><span class="linenos">672</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
</span><span id="FeedIterator-673"><a href="#FeedIterator-673"><span class="linenos">673</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">max_attempts</span> <span class="ow">or</span> <span class="n">max_attempts</span>
</span><span id="FeedIterator-674"><a href="#FeedIterator-674"><span class="linenos">674</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">max_backoff</span> <span class="ow">or</span> <span class="n">max_backoff</span>
</span><span id="FeedIterator-675"><a href="#FeedIterator-675"><span class="linenos">675</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">token</span><span class="p">}</span>
</span><span id="FeedIterator-676"><a href="#FeedIterator-676"><span class="linenos">676</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FeedIterator-677"><a href="#FeedIterator-677"><span class="linenos">677</span></a>
</span><span id="FeedIterator-678"><a href="#FeedIterator-678"><span class="linenos">678</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FeedIterator-679"><a href="#FeedIterator-679"><span class="linenos">679</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Only one of &#39;start_ts&#39; or &#39;cursor&#39; can be defined in the FeedOptions.&quot;</span>
</span><span id="FeedIterator-680"><a href="#FeedIterator-680"><span class="linenos">680</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="FeedIterator-681"><a href="#FeedIterator-681"><span class="linenos">681</span></a>
</span><span id="FeedIterator-682"><a href="#FeedIterator-682"><span class="linenos">682</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FeedIterator-683"><a href="#FeedIterator-683"><span class="linenos">683</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;page_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">page_size</span>
</span><span id="FeedIterator-684"><a href="#FeedIterator-684"><span class="linenos">684</span></a>
</span><span id="FeedIterator-685"><a href="#FeedIterator-685"><span class="linenos">685</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FeedIterator-686"><a href="#FeedIterator-686"><span class="linenos">686</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span>
</span><span id="FeedIterator-687"><a href="#FeedIterator-687"><span class="linenos">687</span></a>    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FeedIterator-688"><a href="#FeedIterator-688"><span class="linenos">688</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;start_ts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span>
</span><span id="FeedIterator-689"><a href="#FeedIterator-689"><span class="linenos">689</span></a>
</span><span id="FeedIterator-690"><a href="#FeedIterator-690"><span class="linenos">690</span></a>  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">FeedPage</span><span class="p">]:</span>
</span><span id="FeedIterator-691"><a href="#FeedIterator-691"><span class="linenos">691</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FeedIterator-692"><a href="#FeedIterator-692"><span class="linenos">692</span></a>    <span class="k">return</span> <span class="bp">self</span>
</span><span id="FeedIterator-693"><a href="#FeedIterator-693"><span class="linenos">693</span></a>
</span><span id="FeedIterator-694"><a href="#FeedIterator-694"><span class="linenos">694</span></a>  <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeedPage</span><span class="p">:</span>
</span><span id="FeedIterator-695"><a href="#FeedIterator-695"><span class="linenos">695</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span><span class="p">:</span>
</span><span id="FeedIterator-696"><a href="#FeedIterator-696"><span class="linenos">696</span></a>      <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="FeedIterator-697"><a href="#FeedIterator-697"><span class="linenos">697</span></a>
</span><span id="FeedIterator-698"><a href="#FeedIterator-698"><span class="linenos">698</span></a>    <span class="n">retryable</span> <span class="o">=</span> <span class="n">Retryable</span><span class="p">[</span><span class="n">Any</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span><span class="p">,</span>
</span><span id="FeedIterator-699"><a href="#FeedIterator-699"><span class="linenos">699</span></a>                               <span class="bp">self</span><span class="o">.</span><span class="n">_next_page</span><span class="p">)</span>
</span><span id="FeedIterator-700"><a href="#FeedIterator-700"><span class="linenos">700</span></a>    <span class="k">return</span> <span class="n">retryable</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">response</span>
</span><span id="FeedIterator-701"><a href="#FeedIterator-701"><span class="linenos">701</span></a>
</span><span id="FeedIterator-702"><a href="#FeedIterator-702"><span class="linenos">702</span></a>  <span class="k">def</span> <span class="nf">_next_page</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeedPage</span><span class="p">:</span>
</span><span id="FeedIterator-703"><a href="#FeedIterator-703"><span class="linenos">703</span></a>    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="FeedIterator-704"><a href="#FeedIterator-704"><span class="linenos">704</span></a>        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="FeedIterator-705"><a href="#FeedIterator-705"><span class="linenos">705</span></a>        <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span><span class="p">,</span>
</span><span id="FeedIterator-706"><a href="#FeedIterator-706"><span class="linenos">706</span></a>        <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
</span><span id="FeedIterator-707"><a href="#FeedIterator-707"><span class="linenos">707</span></a>        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span>
</span><span id="FeedIterator-708"><a href="#FeedIterator-708"><span class="linenos">708</span></a>    <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="FeedIterator-709"><a href="#FeedIterator-709"><span class="linenos">709</span></a>      <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">()</span>
</span><span id="FeedIterator-710"><a href="#FeedIterator-710"><span class="linenos">710</span></a>      <span class="n">decoded</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">FaunaDecoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span><span id="FeedIterator-711"><a href="#FeedIterator-711"><span class="linenos">711</span></a>
</span><span id="FeedIterator-712"><a href="#FeedIterator-712"><span class="linenos">712</span></a>      <span class="k">if</span> <span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">399</span><span class="p">:</span>
</span><span id="FeedIterator-713"><a href="#FeedIterator-713"><span class="linenos">713</span></a>        <span class="n">FaunaError</span><span class="o">.</span><span class="n">parse_error_and_throw</span><span class="p">(</span><span class="n">decoded</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
</span><span id="FeedIterator-714"><a href="#FeedIterator-714"><span class="linenos">714</span></a>
</span><span id="FeedIterator-715"><a href="#FeedIterator-715"><span class="linenos">715</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;has_next&quot;</span><span class="p">]</span>
</span><span id="FeedIterator-716"><a href="#FeedIterator-716"><span class="linenos">716</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span>
</span><span id="FeedIterator-717"><a href="#FeedIterator-717"><span class="linenos">717</span></a>
</span><span id="FeedIterator-718"><a href="#FeedIterator-718"><span class="linenos">718</span></a>      <span class="k">if</span> <span class="s2">&quot;start_ts&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
</span><span id="FeedIterator-719"><a href="#FeedIterator-719"><span class="linenos">719</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;start_ts&quot;</span><span class="p">]</span>
</span><span id="FeedIterator-720"><a href="#FeedIterator-720"><span class="linenos">720</span></a>
</span><span id="FeedIterator-721"><a href="#FeedIterator-721"><span class="linenos">721</span></a>      <span class="k">return</span> <span class="n">FeedPage</span><span class="p">(</span><span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">],</span> <span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">],</span>
</span><span id="FeedIterator-722"><a href="#FeedIterator-722"><span class="linenos">722</span></a>                      <span class="n">QueryStats</span><span class="p">(</span><span class="n">decoded</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]))</span>
</span><span id="FeedIterator-723"><a href="#FeedIterator-723"><span class="linenos">723</span></a>
</span><span id="FeedIterator-724"><a href="#FeedIterator-724"><span class="linenos">724</span></a>  <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="FeedIterator-725"><a href="#FeedIterator-725"><span class="linenos">725</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A generator that yields events instead of pages of events.&quot;&quot;&quot;</span>
</span><span id="FeedIterator-726"><a href="#FeedIterator-726"><span class="linenos">726</span></a>    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="FeedIterator-727"><a href="#FeedIterator-727"><span class="linenos">727</span></a>      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
</span><span id="FeedIterator-728"><a href="#FeedIterator-728"><span class="linenos">728</span></a>        <span class="k">yield</span> <span class="n">event</span>
</span></pre></div>


            <div class="docstring"><p>A class to provide an iterator on top of Event Feed pages.</p>
</div>


                            <div id="FeedIterator.__init__" class="classattr">
                                        <input id="FeedIterator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FeedIterator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">http</span><span class="p">:</span> <span class="n"><a href="../http/http_client.html#HTTPClient">fauna.http.http_client.HTTPClient</a></span>,</span><span class="param">	<span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>,</span><span class="param">	<span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">opts</span><span class="p">:</span> <span class="n"><a href="#FeedOptions">FeedOptions</a></span>,</span><span class="param">	<span class="n">source</span><span class="p">:</span> <span class="n"><a href="../query/models.html#EventSource">fauna.query.models.EventSource</a></span></span>)</span>

                <label class="view-source-button" for="FeedIterator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FeedIterator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FeedIterator.__init__-667"><a href="#FeedIterator.__init__-667"><span class="linenos">667</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http</span><span class="p">:</span> <span class="n">HTTPClient</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="FeedIterator.__init__-668"><a href="#FeedIterator.__init__-668"><span class="linenos">668</span></a>               <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_backoff</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">opts</span><span class="p">:</span> <span class="n">FeedOptions</span><span class="p">,</span>
</span><span id="FeedIterator.__init__-669"><a href="#FeedIterator.__init__-669"><span class="linenos">669</span></a>               <span class="n">source</span><span class="p">:</span> <span class="n">EventSource</span><span class="p">):</span>
</span><span id="FeedIterator.__init__-670"><a href="#FeedIterator.__init__-670"><span class="linenos">670</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_http</span> <span class="o">=</span> <span class="n">http</span>
</span><span id="FeedIterator.__init__-671"><a href="#FeedIterator.__init__-671"><span class="linenos">671</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">headers</span>
</span><span id="FeedIterator.__init__-672"><a href="#FeedIterator.__init__-672"><span class="linenos">672</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
</span><span id="FeedIterator.__init__-673"><a href="#FeedIterator.__init__-673"><span class="linenos">673</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_attempts</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">max_attempts</span> <span class="ow">or</span> <span class="n">max_attempts</span>
</span><span id="FeedIterator.__init__-674"><a href="#FeedIterator.__init__-674"><span class="linenos">674</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_backoff</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">max_backoff</span> <span class="ow">or</span> <span class="n">max_backoff</span>
</span><span id="FeedIterator.__init__-675"><a href="#FeedIterator.__init__-675"><span class="linenos">675</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">token</span><span class="p">}</span>
</span><span id="FeedIterator.__init__-676"><a href="#FeedIterator.__init__-676"><span class="linenos">676</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_is_done</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="FeedIterator.__init__-677"><a href="#FeedIterator.__init__-677"><span class="linenos">677</span></a>
</span><span id="FeedIterator.__init__-678"><a href="#FeedIterator.__init__-678"><span class="linenos">678</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FeedIterator.__init__-679"><a href="#FeedIterator.__init__-679"><span class="linenos">679</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Only one of &#39;start_ts&#39; or &#39;cursor&#39; can be defined in the FeedOptions.&quot;</span>
</span><span id="FeedIterator.__init__-680"><a href="#FeedIterator.__init__-680"><span class="linenos">680</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="FeedIterator.__init__-681"><a href="#FeedIterator.__init__-681"><span class="linenos">681</span></a>
</span><span id="FeedIterator.__init__-682"><a href="#FeedIterator.__init__-682"><span class="linenos">682</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">page_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FeedIterator.__init__-683"><a href="#FeedIterator.__init__-683"><span class="linenos">683</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;page_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">page_size</span>
</span><span id="FeedIterator.__init__-684"><a href="#FeedIterator.__init__-684"><span class="linenos">684</span></a>
</span><span id="FeedIterator.__init__-685"><a href="#FeedIterator.__init__-685"><span class="linenos">685</span></a>    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FeedIterator.__init__-686"><a href="#FeedIterator.__init__-686"><span class="linenos">686</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;cursor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">cursor</span>
</span><span id="FeedIterator.__init__-687"><a href="#FeedIterator.__init__-687"><span class="linenos">687</span></a>    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FeedIterator.__init__-688"><a href="#FeedIterator.__init__-688"><span class="linenos">688</span></a>      <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s2">&quot;start_ts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">start_ts</span>
</span></pre></div>


    

                            </div>
                            <div id="FeedIterator.flatten" class="classattr">
                                        <input id="FeedIterator.flatten-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">flatten</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Iterator</span>:</span></span>

                <label class="view-source-button" for="FeedIterator.flatten-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FeedIterator.flatten"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FeedIterator.flatten-724"><a href="#FeedIterator.flatten-724"><span class="linenos">724</span></a>  <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="FeedIterator.flatten-725"><a href="#FeedIterator.flatten-725"><span class="linenos">725</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A generator that yields events instead of pages of events.&quot;&quot;&quot;</span>
</span><span id="FeedIterator.flatten-726"><a href="#FeedIterator.flatten-726"><span class="linenos">726</span></a>    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="FeedIterator.flatten-727"><a href="#FeedIterator.flatten-727"><span class="linenos">727</span></a>      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
</span><span id="FeedIterator.flatten-728"><a href="#FeedIterator.flatten-728"><span class="linenos">728</span></a>        <span class="k">yield</span> <span class="n">event</span>
</span></pre></div>


            <div class="docstring"><p>A generator that yields events instead of pages of events.</p>
</div>


                            </div>
                </section>
                <section id="QueryIterator">
                            <input id="QueryIterator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">QueryIterator</span>:

                <label class="view-source-button" for="QueryIterator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#QueryIterator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="QueryIterator-731"><a href="#QueryIterator-731"><span class="linenos">731</span></a><span class="k">class</span> <span class="nc">QueryIterator</span><span class="p">:</span>
</span><span id="QueryIterator-732"><a href="#QueryIterator-732"><span class="linenos">732</span></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;A class to provider an iterator on top of Fauna queries.&quot;&quot;&quot;</span>
</span><span id="QueryIterator-733"><a href="#QueryIterator-733"><span class="linenos">733</span></a>
</span><span id="QueryIterator-734"><a href="#QueryIterator-734"><span class="linenos">734</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="QueryIterator-735"><a href="#QueryIterator-735"><span class="linenos">735</span></a>               <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span>
</span><span id="QueryIterator-736"><a href="#QueryIterator-736"><span class="linenos">736</span></a>               <span class="n">fql</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
</span><span id="QueryIterator-737"><a href="#QueryIterator-737"><span class="linenos">737</span></a>               <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="QueryIterator-738"><a href="#QueryIterator-738"><span class="linenos">738</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the QueryIterator</span>
</span><span id="QueryIterator-739"><a href="#QueryIterator-739"><span class="linenos">739</span></a>
</span><span id="QueryIterator-740"><a href="#QueryIterator-740"><span class="linenos">740</span></a><span class="sd">        :param fql: A Query</span>
</span><span id="QueryIterator-741"><a href="#QueryIterator-741"><span class="linenos">741</span></a><span class="sd">        :param opts: (Optional) Query Options</span>
</span><span id="QueryIterator-742"><a href="#QueryIterator-742"><span class="linenos">742</span></a>
</span><span id="QueryIterator-743"><a href="#QueryIterator-743"><span class="linenos">743</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="QueryIterator-744"><a href="#QueryIterator-744"><span class="linenos">744</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="QueryIterator-745"><a href="#QueryIterator-745"><span class="linenos">745</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Client</span><span class="p">):</span>
</span><span id="QueryIterator-746"><a href="#QueryIterator-746"><span class="linenos">746</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;client&#39; must be a Client but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">client</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="QueryIterator-747"><a href="#QueryIterator-747"><span class="linenos">747</span></a>                  <span class="sa">f</span><span class="s2">&quot;Client by calling fauna.client.Client()&quot;</span>
</span><span id="QueryIterator-748"><a href="#QueryIterator-748"><span class="linenos">748</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="QueryIterator-749"><a href="#QueryIterator-749"><span class="linenos">749</span></a>
</span><span id="QueryIterator-750"><a href="#QueryIterator-750"><span class="linenos">750</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="QueryIterator-751"><a href="#QueryIterator-751"><span class="linenos">751</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be a Query but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="QueryIterator-752"><a href="#QueryIterator-752"><span class="linenos">752</span></a>                 <span class="sa">f</span><span class="s2">&quot;Query by calling fauna.fql()&quot;</span>
</span><span id="QueryIterator-753"><a href="#QueryIterator-753"><span class="linenos">753</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="QueryIterator-754"><a href="#QueryIterator-754"><span class="linenos">754</span></a>
</span><span id="QueryIterator-755"><a href="#QueryIterator-755"><span class="linenos">755</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
</span><span id="QueryIterator-756"><a href="#QueryIterator-756"><span class="linenos">756</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fql</span> <span class="o">=</span> <span class="n">fql</span>
</span><span id="QueryIterator-757"><a href="#QueryIterator-757"><span class="linenos">757</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span>
</span><span id="QueryIterator-758"><a href="#QueryIterator-758"><span class="linenos">758</span></a>
</span><span id="QueryIterator-759"><a href="#QueryIterator-759"><span class="linenos">759</span></a>  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="QueryIterator-760"><a href="#QueryIterator-760"><span class="linenos">760</span></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">()</span>
</span><span id="QueryIterator-761"><a href="#QueryIterator-761"><span class="linenos">761</span></a>
</span><span id="QueryIterator-762"><a href="#QueryIterator-762"><span class="linenos">762</span></a>  <span class="k">def</span> <span class="nf">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="QueryIterator-763"><a href="#QueryIterator-763"><span class="linenos">763</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="QueryIterator-764"><a href="#QueryIterator-764"><span class="linenos">764</span></a><span class="sd">        A generator function that immediately fetches and yields the results of</span>
</span><span id="QueryIterator-765"><a href="#QueryIterator-765"><span class="linenos">765</span></a><span class="sd">        the stored query. Yields additional pages on subsequent iterations if</span>
</span><span id="QueryIterator-766"><a href="#QueryIterator-766"><span class="linenos">766</span></a><span class="sd">        they exist</span>
</span><span id="QueryIterator-767"><a href="#QueryIterator-767"><span class="linenos">767</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="QueryIterator-768"><a href="#QueryIterator-768"><span class="linenos">768</span></a>
</span><span id="QueryIterator-769"><a href="#QueryIterator-769"><span class="linenos">769</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="QueryIterator-770"><a href="#QueryIterator-770"><span class="linenos">770</span></a>    <span class="n">initial_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
</span><span id="QueryIterator-771"><a href="#QueryIterator-771"><span class="linenos">771</span></a>
</span><span id="QueryIterator-772"><a href="#QueryIterator-772"><span class="linenos">772</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">Page</span><span class="p">):</span>
</span><span id="QueryIterator-773"><a href="#QueryIterator-773"><span class="linenos">773</span></a>      <span class="n">cursor</span> <span class="o">=</span> <span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">after</span>
</span><span id="QueryIterator-774"><a href="#QueryIterator-774"><span class="linenos">774</span></a>      <span class="k">yield</span> <span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
</span><span id="QueryIterator-775"><a href="#QueryIterator-775"><span class="linenos">775</span></a>
</span><span id="QueryIterator-776"><a href="#QueryIterator-776"><span class="linenos">776</span></a>      <span class="k">while</span> <span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="QueryIterator-777"><a href="#QueryIterator-777"><span class="linenos">777</span></a>        <span class="n">next_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="QueryIterator-778"><a href="#QueryIterator-778"><span class="linenos">778</span></a>            <span class="n">fql</span><span class="p">(</span><span class="s2">&quot;Set.paginate($</span><span class="si">{after}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">cursor</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
</span><span id="QueryIterator-779"><a href="#QueryIterator-779"><span class="linenos">779</span></a>        <span class="c1"># TODO: `Set.paginate` does not yet return a `@set` tagged value</span>
</span><span id="QueryIterator-780"><a href="#QueryIterator-780"><span class="linenos">780</span></a>        <span class="c1">#       so we will get back a plain object that might not have</span>
</span><span id="QueryIterator-781"><a href="#QueryIterator-781"><span class="linenos">781</span></a>        <span class="c1">#       an after property.</span>
</span><span id="QueryIterator-782"><a href="#QueryIterator-782"><span class="linenos">782</span></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">next_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
</span><span id="QueryIterator-783"><a href="#QueryIterator-783"><span class="linenos">783</span></a>        <span class="k">yield</span> <span class="n">next_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
</span><span id="QueryIterator-784"><a href="#QueryIterator-784"><span class="linenos">784</span></a>
</span><span id="QueryIterator-785"><a href="#QueryIterator-785"><span class="linenos">785</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="QueryIterator-786"><a href="#QueryIterator-786"><span class="linenos">786</span></a>      <span class="k">yield</span> <span class="p">[</span><span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</span><span id="QueryIterator-787"><a href="#QueryIterator-787"><span class="linenos">787</span></a>
</span><span id="QueryIterator-788"><a href="#QueryIterator-788"><span class="linenos">788</span></a>  <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="QueryIterator-789"><a href="#QueryIterator-789"><span class="linenos">789</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="QueryIterator-790"><a href="#QueryIterator-790"><span class="linenos">790</span></a><span class="sd">        A generator function that immediately fetches and yields the results of</span>
</span><span id="QueryIterator-791"><a href="#QueryIterator-791"><span class="linenos">791</span></a><span class="sd">        the stored query. Yields each item individually, rather than a whole</span>
</span><span id="QueryIterator-792"><a href="#QueryIterator-792"><span class="linenos">792</span></a><span class="sd">        Page at a time. Fetches additional pages as required if they exist.</span>
</span><span id="QueryIterator-793"><a href="#QueryIterator-793"><span class="linenos">793</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="QueryIterator-794"><a href="#QueryIterator-794"><span class="linenos">794</span></a>
</span><span id="QueryIterator-795"><a href="#QueryIterator-795"><span class="linenos">795</span></a>    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
</span><span id="QueryIterator-796"><a href="#QueryIterator-796"><span class="linenos">796</span></a>      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
</span><span id="QueryIterator-797"><a href="#QueryIterator-797"><span class="linenos">797</span></a>        <span class="k">yield</span> <span class="n">item</span>
</span></pre></div>


            <div class="docstring"><p>A class to provider an iterator on top of Fauna queries.</p>
</div>


                            <div id="QueryIterator.__init__" class="classattr">
                                        <input id="QueryIterator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">QueryIterator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">client</span><span class="p">:</span> <span class="n"><a href="#Client">Client</a></span>,</span><span class="param">	<span class="n">fql</span><span class="p">:</span> <span class="n"><a href="../query/query_builder.html#Query">fauna.query.query_builder.Query</a></span>,</span><span class="param">	<span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="#QueryOptions">QueryOptions</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="QueryIterator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#QueryIterator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="QueryIterator.__init__-734"><a href="#QueryIterator.__init__-734"><span class="linenos">734</span></a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="QueryIterator.__init__-735"><a href="#QueryIterator.__init__-735"><span class="linenos">735</span></a>               <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span>
</span><span id="QueryIterator.__init__-736"><a href="#QueryIterator.__init__-736"><span class="linenos">736</span></a>               <span class="n">fql</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
</span><span id="QueryIterator.__init__-737"><a href="#QueryIterator.__init__-737"><span class="linenos">737</span></a>               <span class="n">opts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="QueryIterator.__init__-738"><a href="#QueryIterator.__init__-738"><span class="linenos">738</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the QueryIterator</span>
</span><span id="QueryIterator.__init__-739"><a href="#QueryIterator.__init__-739"><span class="linenos">739</span></a>
</span><span id="QueryIterator.__init__-740"><a href="#QueryIterator.__init__-740"><span class="linenos">740</span></a><span class="sd">        :param fql: A Query</span>
</span><span id="QueryIterator.__init__-741"><a href="#QueryIterator.__init__-741"><span class="linenos">741</span></a><span class="sd">        :param opts: (Optional) Query Options</span>
</span><span id="QueryIterator.__init__-742"><a href="#QueryIterator.__init__-742"><span class="linenos">742</span></a>
</span><span id="QueryIterator.__init__-743"><a href="#QueryIterator.__init__-743"><span class="linenos">743</span></a><span class="sd">        :raises TypeError: Invalid param types</span>
</span><span id="QueryIterator.__init__-744"><a href="#QueryIterator.__init__-744"><span class="linenos">744</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="QueryIterator.__init__-745"><a href="#QueryIterator.__init__-745"><span class="linenos">745</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Client</span><span class="p">):</span>
</span><span id="QueryIterator.__init__-746"><a href="#QueryIterator.__init__-746"><span class="linenos">746</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;client&#39; must be a Client but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">client</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="QueryIterator.__init__-747"><a href="#QueryIterator.__init__-747"><span class="linenos">747</span></a>                  <span class="sa">f</span><span class="s2">&quot;Client by calling fauna.client.Client()&quot;</span>
</span><span id="QueryIterator.__init__-748"><a href="#QueryIterator.__init__-748"><span class="linenos">748</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="QueryIterator.__init__-749"><a href="#QueryIterator.__init__-749"><span class="linenos">749</span></a>
</span><span id="QueryIterator.__init__-750"><a href="#QueryIterator.__init__-750"><span class="linenos">750</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fql</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
</span><span id="QueryIterator.__init__-751"><a href="#QueryIterator.__init__-751"><span class="linenos">751</span></a>      <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;fql&#39; must be a Query but was a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fql</span><span class="p">)</span><span class="si">}</span><span class="s2">. You can build a &quot;</span> \
</span><span id="QueryIterator.__init__-752"><a href="#QueryIterator.__init__-752"><span class="linenos">752</span></a>                 <span class="sa">f</span><span class="s2">&quot;Query by calling fauna.fql()&quot;</span>
</span><span id="QueryIterator.__init__-753"><a href="#QueryIterator.__init__-753"><span class="linenos">753</span></a>      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
</span><span id="QueryIterator.__init__-754"><a href="#QueryIterator.__init__-754"><span class="linenos">754</span></a>
</span><span id="QueryIterator.__init__-755"><a href="#QueryIterator.__init__-755"><span class="linenos">755</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
</span><span id="QueryIterator.__init__-756"><a href="#QueryIterator.__init__-756"><span class="linenos">756</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fql</span> <span class="o">=</span> <span class="n">fql</span>
</span><span id="QueryIterator.__init__-757"><a href="#QueryIterator.__init__-757"><span class="linenos">757</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span>
</span></pre></div>


            <div class="docstring"><p>Initializes the QueryIterator</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>fql</strong>:  A Query</li>
<li><strong>opts</strong>:  (Optional) Query Options</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>TypeError</strong>:  Invalid param types</li>
</ul>
</div>


                            </div>
                            <div id="QueryIterator.client" class="classattr">
                                <div class="attr variable">
            <span class="name">client</span>

        
    </div>
    <a class="headerlink" href="#QueryIterator.client"></a>
    
    

                            </div>
                            <div id="QueryIterator.fql" class="classattr">
                                <div class="attr variable">
            <span class="name">fql</span>

        
    </div>
    <a class="headerlink" href="#QueryIterator.fql"></a>
    
    

                            </div>
                            <div id="QueryIterator.opts" class="classattr">
                                <div class="attr variable">
            <span class="name">opts</span>

        
    </div>
    <a class="headerlink" href="#QueryIterator.opts"></a>
    
    

                            </div>
                            <div id="QueryIterator.iter" class="classattr">
                                        <input id="QueryIterator.iter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">iter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Iterator</span>:</span></span>

                <label class="view-source-button" for="QueryIterator.iter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#QueryIterator.iter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="QueryIterator.iter-762"><a href="#QueryIterator.iter-762"><span class="linenos">762</span></a>  <span class="k">def</span> <span class="nf">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="QueryIterator.iter-763"><a href="#QueryIterator.iter-763"><span class="linenos">763</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="QueryIterator.iter-764"><a href="#QueryIterator.iter-764"><span class="linenos">764</span></a><span class="sd">        A generator function that immediately fetches and yields the results of</span>
</span><span id="QueryIterator.iter-765"><a href="#QueryIterator.iter-765"><span class="linenos">765</span></a><span class="sd">        the stored query. Yields additional pages on subsequent iterations if</span>
</span><span id="QueryIterator.iter-766"><a href="#QueryIterator.iter-766"><span class="linenos">766</span></a><span class="sd">        they exist</span>
</span><span id="QueryIterator.iter-767"><a href="#QueryIterator.iter-767"><span class="linenos">767</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="QueryIterator.iter-768"><a href="#QueryIterator.iter-768"><span class="linenos">768</span></a>
</span><span id="QueryIterator.iter-769"><a href="#QueryIterator.iter-769"><span class="linenos">769</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="QueryIterator.iter-770"><a href="#QueryIterator.iter-770"><span class="linenos">770</span></a>    <span class="n">initial_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
</span><span id="QueryIterator.iter-771"><a href="#QueryIterator.iter-771"><span class="linenos">771</span></a>
</span><span id="QueryIterator.iter-772"><a href="#QueryIterator.iter-772"><span class="linenos">772</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">Page</span><span class="p">):</span>
</span><span id="QueryIterator.iter-773"><a href="#QueryIterator.iter-773"><span class="linenos">773</span></a>      <span class="n">cursor</span> <span class="o">=</span> <span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">after</span>
</span><span id="QueryIterator.iter-774"><a href="#QueryIterator.iter-774"><span class="linenos">774</span></a>      <span class="k">yield</span> <span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
</span><span id="QueryIterator.iter-775"><a href="#QueryIterator.iter-775"><span class="linenos">775</span></a>
</span><span id="QueryIterator.iter-776"><a href="#QueryIterator.iter-776"><span class="linenos">776</span></a>      <span class="k">while</span> <span class="n">cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="QueryIterator.iter-777"><a href="#QueryIterator.iter-777"><span class="linenos">777</span></a>        <span class="n">next_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span id="QueryIterator.iter-778"><a href="#QueryIterator.iter-778"><span class="linenos">778</span></a>            <span class="n">fql</span><span class="p">(</span><span class="s2">&quot;Set.paginate($</span><span class="si">{after}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">cursor</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
</span><span id="QueryIterator.iter-779"><a href="#QueryIterator.iter-779"><span class="linenos">779</span></a>        <span class="c1"># TODO: `Set.paginate` does not yet return a `@set` tagged value</span>
</span><span id="QueryIterator.iter-780"><a href="#QueryIterator.iter-780"><span class="linenos">780</span></a>        <span class="c1">#       so we will get back a plain object that might not have</span>
</span><span id="QueryIterator.iter-781"><a href="#QueryIterator.iter-781"><span class="linenos">781</span></a>        <span class="c1">#       an after property.</span>
</span><span id="QueryIterator.iter-782"><a href="#QueryIterator.iter-782"><span class="linenos">782</span></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">next_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
</span><span id="QueryIterator.iter-783"><a href="#QueryIterator.iter-783"><span class="linenos">783</span></a>        <span class="k">yield</span> <span class="n">next_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
</span><span id="QueryIterator.iter-784"><a href="#QueryIterator.iter-784"><span class="linenos">784</span></a>
</span><span id="QueryIterator.iter-785"><a href="#QueryIterator.iter-785"><span class="linenos">785</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="QueryIterator.iter-786"><a href="#QueryIterator.iter-786"><span class="linenos">786</span></a>      <span class="k">yield</span> <span class="p">[</span><span class="n">initial_response</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>A generator function that immediately fetches and yields the results of
the stored query. Yields additional pages on subsequent iterations if
they exist</p>
</div>


                            </div>
                            <div id="QueryIterator.flatten" class="classattr">
                                        <input id="QueryIterator.flatten-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">flatten</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Iterator</span>:</span></span>

                <label class="view-source-button" for="QueryIterator.flatten-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#QueryIterator.flatten"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="QueryIterator.flatten-788"><a href="#QueryIterator.flatten-788"><span class="linenos">788</span></a>  <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
</span><span id="QueryIterator.flatten-789"><a href="#QueryIterator.flatten-789"><span class="linenos">789</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="QueryIterator.flatten-790"><a href="#QueryIterator.flatten-790"><span class="linenos">790</span></a><span class="sd">        A generator function that immediately fetches and yields the results of</span>
</span><span id="QueryIterator.flatten-791"><a href="#QueryIterator.flatten-791"><span class="linenos">791</span></a><span class="sd">        the stored query. Yields each item individually, rather than a whole</span>
</span><span id="QueryIterator.flatten-792"><a href="#QueryIterator.flatten-792"><span class="linenos">792</span></a><span class="sd">        Page at a time. Fetches additional pages as required if they exist.</span>
</span><span id="QueryIterator.flatten-793"><a href="#QueryIterator.flatten-793"><span class="linenos">793</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="QueryIterator.flatten-794"><a href="#QueryIterator.flatten-794"><span class="linenos">794</span></a>
</span><span id="QueryIterator.flatten-795"><a href="#QueryIterator.flatten-795"><span class="linenos">795</span></a>    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
</span><span id="QueryIterator.flatten-796"><a href="#QueryIterator.flatten-796"><span class="linenos">796</span></a>      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
</span><span id="QueryIterator.flatten-797"><a href="#QueryIterator.flatten-797"><span class="linenos">797</span></a>        <span class="k">yield</span> <span class="n">item</span>
</span></pre></div>


            <div class="docstring"><p>A generator function that immediately fetches and yields the results of
the stored query. Yields each item individually, rather than a whole
Page at a time. Fetches additional pages as required if they exist.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>